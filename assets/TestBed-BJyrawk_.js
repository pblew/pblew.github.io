import{c as te,C as oe,q as ie,f as ae,n as ne,u as re,G as se,v as le,w as ce,B as N,d as ue,j as de,x as fe,h as me,y as pe,k as ve,l as xe,m as _e,p as he,o as Te,g as Me,e as B,i as ye,V as Se}from"./VTextField-DYXlTJu6.js";import{u as Ee}from"./Positions-CNJyKkJq.js";import{u as P,g as Ve,a as Ce,V as U}from"./VSelect-BZ6XBBR_.js";import{d as H,x as V,s as X,r as ge,c as G,o as j,u as i,v as F,y as Ie,z as we,w as y,l as De,a as m,p as R,n as Le,q as be}from"./index-Ck9i7U5g.js";import"./VMenu-BJ41JeIu.js";import"./VSlideGroup-DE3KTn_7.js";var Oe=`#version 300 es
precision highp float;in vec3 v_normal;in vec2 v_texcoord;uniform vec4 u_ambientLight;uniform vec3 u_reverseLightDirection;uniform sampler2D u_texture;out vec4 outColour;void main(void){vec3 normal=normalize(v_normal);float light=dot(normal,u_reverseLightDirection);outColour=texture(u_texture,v_texcoord);outColour.rgb*=light;outColour+=u_ambientLight;}`,Re=`#version 300 es
precision highp sampler2D;in mat4 a_model_position;in vec3 a_vertex;in vec2 a_lscoord;uniform mat4 u_projection;uniform mat4 u_view;uniform sampler2D u_miscDataMap;uniform sampler2D u_miscData2Map;out vec3 v_normal;out vec2 v_texcoord;out vec4 v_colour;const int NUM_TILES=2;const float HEIGHT_SCALE=0.2;const ivec2[6]EVEN_VERTEX_OFFSETS=ivec2[6](ivec2(0,0),ivec2(0,1),ivec2(1,1),ivec2(0,0),ivec2(1,1),ivec2(1,0));const ivec2[6]ODD_VERTEX_OFFSETS=ivec2[6](ivec2(0,0),ivec2(-1,1),ivec2(0,1),ivec2(0,0),ivec2(0,1),ivec2(1,0));int wrap_int(int value,int min_value,int max_value){return((value-min_value)%(max_value+min_value))+min_value;}ivec2 getMainVertexCoord(vec2 lscoord,ivec2 mapSize,int tile){int tileOffset=tile*mapSize.y/NUM_TILES;int y=int(lscoord.r)+tileOffset;int x=wrap_int(int(lscoord.g)+int((y&1)==0),0,mapSize.x);return ivec2(x,y);}ivec2 getOffsetVertexCoord(vec2 lscoord,ivec2 mapSize,int tile,int vertexId,bool isEvenRow){int mapHeight=mapSize.y/NUM_TILES;int tileOffset=tile*mapHeight;ivec2 vertexOffset=isEvenRow ? EVEN_VERTEX_OFFSETS[vertexId]: ODD_VERTEX_OFFSETS[vertexId];int y=wrap_int(int(lscoord.r)+vertexOffset.y,0,mapHeight)+tileOffset;int x=wrap_int(int(lscoord.g)+vertexOffset.x+int((y&1)==0),0,mapSize.x);return ivec2(x,y);}int lookupInt(sampler2D source,int row,int offset){vec4 pixel=texelFetch(source,ivec2(offset>>2,row),0);return int(pixel[offset&3]*255.0);}vec2 texcoordFromLs(vec2 ls1){int triangle=int(step(3.0,float(gl_VertexID)));int lsId=int(ls1[triangle]*255.0);int tileXoffset=lookupInt(u_miscData2Map,lsId,0);int tileYoffset=lookupInt(u_miscData2Map,lsId,1);int vertexXoffset=lookupInt(u_miscData2Map,lsId,2+(gl_VertexID<<1));int vertexYoffset=lookupInt(u_miscData2Map,lsId,3+(gl_VertexID<<1));return vec2(float(tileXoffset+vertexXoffset)/255.0,float(tileYoffset+vertexYoffset)/255.0);}void main(void){ivec2 mapSize=textureSize(u_miscDataMap,0);ivec2 mainVertexCoord=getMainVertexCoord(a_lscoord,mapSize,1);bool isEvenRow=(mainVertexCoord.y&1)==0;vec4 mainVertexMap1Colour=texelFetch(u_miscDataMap,mainVertexCoord,0);vec2 ls=mainVertexMap1Colour.gb;ivec2 offsetVertexCoordTile0=getOffsetVertexCoord(a_lscoord,mapSize,0,gl_VertexID,isEvenRow);vec4 offsetVertexMap0Colour=texelFetch(u_miscDataMap,offsetVertexCoordTile0,0);vec3 normal=offsetVertexMap0Colour.rgb;ivec2 offsetVertexCoordTile1=getOffsetVertexCoord(a_lscoord,mapSize,1,gl_VertexID,isEvenRow);vec4 offsetVertexMap1Colour=texelFetch(u_miscDataMap,offsetVertexCoordTile1,0);float altitude=(offsetVertexMap1Colour.r*255.0)*HEIGHT_SCALE;vec4 worldPosition=u_view*a_model_position*vec4(a_vertex.x,altitude,a_vertex.z,1.0);gl_Position=u_projection*worldPosition;v_normal=normal;v_texcoord=texcoordFromLs(ls);}`;const Fe=H({__name:"TestbedScene",props:{mapDefinition:{},heightAndTypeMap:{},tileMap:{},textureSet:{}},setup(z,{expose:S}){const h=z,C=V(()=>h.textureSet?.image),{loadingStore:g}=X(),s=te(oe.LookAt),I=ie(.1,.1,.1,1),T=ae(0,.15,1);ne(T,T);const f=ge(P({})),p=[],M=[];function w(e,t,{projection:o,view:d},{indexes:x,vertexes:n},l,a){t.setClearColour(ue),t.setEnableBits(e.CULL_FACE,e.DEPTH_TEST),t.bindUniform("u_projection",u=>e.uniformMatrix4fv(u,!1,o)),t.bindUniform("u_view",u=>e.uniformMatrix4fv(u,!1,d)),t.bindUniform("u_ambientLight",u=>e.uniform4fv(u,I)),t.bindUniform("u_reverseLightDirection",u=>e.uniform3fv(u,T));const r=ye(e),c=de(_e(e),xe(e),ve(e),pe(e,h.tileMap),fe(e,me(16,24,Ie))),_=he(e,t,e.TRIANGLES,Te(e,t,r,c,e.TRIANGLES,x.length,a.usedCount,Ee("a_model_position",a),B("a_vertex",n,3,e.FLOAT),B("a_lscoord",l,2,e.FLOAT,1),Me(x)));return F(C,_.setTexture,{immediate:!0}),_}function D(e,t){t.bind("KeyL",()=>p.forEach(o=>o.setDrawMode(e.LINE_LOOP))),t.bind("KeyK",()=>p.forEach(o=>o.setDrawMode(e.TRIANGLES)))}function L(e,t){t.bind(N.Left,({movement:o})=>{s.tilt(o.dy*.1),s.pan(o.dx*.1)}),t.bind(N.Right,({movement:o})=>{s.track(o.dx*-.1,-o.dy*.1)}),t.bindScroll(o=>s.dolly(o*.25))}function b(e,t){t.bind(o=>{function d(n,l){const{movement:a}=l,{dx:r,dy:c}=a;(Math.abs(r)>0||Math.abs(c)>0)&&n.track(-r/10,-c/10)}function x(n,l,a){const{movement:r,currentPosition:c}=l,{movement:_,currentPosition:u}=a,{dx:K,dy:Y}=r,{x:q,y:$}=c,{dx:W,dy:J}=_,{x:Q,y:Z}=u,ee=Math.sign(q-Q)*(K+W)+Math.sign($-Z)*(Y+J);n.dolly(ee/10)}switch(o.length){case 1:d(s,o[0]);break;case 2:x(s,o[0],o[1]);break}})}const E=re(s,(e,[t],{keyboard:o,mouse:d,touch:x},n)=>{const l=Ve();F(()=>h.mapDefinition,a=>{f.value=P(a);const r=Ce(i(f));r.selectAll(i(f)),M.splice(0,1/0,r),p.splice(0,1/0,w(e,t,n,l,r.lsCoords,r.positions)).forEach(c=>c.delete()),s.moveTo(0,a.height*.5,a.height*.5),s.lookAt(0,0,0)},{immediate:!0}),D(e,o),L(e,d),b(e,x),g.setLoading(!1)},e=>{const{worldCoordinateFor:t}=i(f);M.forEach(o=>{const{lsCoords:d,nodes:x,positions:n}=o;d.clear(),n.clear();let l=0;for(const r of x){const c=i(r.worldCoord),{x:_,y:u}=t(c);le(d.itemAt(l),u,_),ce(n.itemAt(l),c),l++}const[a]=p;a.setInstanceCount(n.usedCount),a.updateBuffer("a_model_position",n,n.usedLength),a.updateBuffer("a_lscoord",d,d.usedLength)})},()=>{p.forEach(({activate:e,draw:t},o)=>{e(o===0),t()})},()=>{},()=>{p.splice(0,1/0).forEach(e=>e.delete())});return S({fps:E.fps}),(e,t)=>(j(),G(se,{"fragment-sources":[i(Oe)],"vertex-sources":[i(Re)],onInit:i(E).init,onResize:i(E).resize,onExit:i(E).exit},null,8,["fragment-sources","vertex-sources","onInit","onResize","onExit"]))}}),He=H({__name:"TestBed",setup(z){const S=we(void 0),{mapStore:h,mapsStore:C,texturesStore:g}=X(),{maps:s}=C,{heightAndTypeMap:I,loadMap:T,map:f,tileMap:p}=h,{currentTexture:M,selectTextureById:w,selectTextureByWorldType:D,textureList:L}=g,b=V(()=>i(s).map(v=>({value:v.id,title:v.name}))),A=V(()=>{const{worldType:v}=i(f);return i(L).filter(O=>O.worldType===v)});F(f,({worldType:v})=>D(v));const k=V(()=>i(M).id);return(v,O)=>(j(),G(De,{fluid:"",class:"d-flex flex-column pa-0"},{default:y(()=>[m(be,{class:"flex-grow-0 flex-shrink-0",color:"secondary"},{default:y(()=>[m(R,{class:"mr-3","max-width":"176"},{default:y(()=>[m(U,{label:"Map","hide-details":"",items:b.value,"model-value":i(f).id,"onUpdate:modelValue":i(T)},null,8,["items","model-value","onUpdate:modelValue"])]),_:1}),m(R,{class:"ml-3","max-width":"176"},{default:y(()=>[m(U,{"item-value":"id","item-title":"name",label:"Landscape","hide-details":"",items:A.value,"model-value":k.value,"onUpdate:modelValue":i(w)},null,8,["items","model-value","onUpdate:modelValue"])]),_:1}),m(Le),m(R,{class:"mr-3","max-width":"56"},{default:y(()=>[m(Se,{class:"noMouse","hide-details":"",label:"fps","model-value":S.value?.fps,readonly:""},null,8,["model-value"])]),_:1})]),_:1}),m(Fe,{ref_key:"testbedScene",ref:S,class:"flex-fill","map-definition":i(f),"height-and-type-map":i(I),"tile-map":i(p),"texture-set":i(M)},null,8,["map-definition","height-and-type-map","tile-map","texture-set"])]),_:1}))}});export{He as default};
