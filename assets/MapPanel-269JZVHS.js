import{f as j,z as st,A as q,q as ct,D as ut,s as ft,a as dt,E as lt,w as mt,F as _t,H as vt,P as ue,c as pt,C as xt,u as ht,G as Et,I as fe,d as Tt,j as Me,x as bt,h as yt,y as wt,k as Le,l as Ce,m as Pe,p as Se,o as Fe,g as de,e as U,i as Ie,J as Mt,K as Lt,B as le,M as Ct,V as Pt}from"./VTextField-DYXlTJu6.js";import{ap as Ee,aq as De,x as Q,u as y,d as ne,r as Be,s as Ve,c as B,o as I,y as St,v as Ft,ar as Re,w as P,a as C,V as Ue,g as J,h as ke,F as Oe,i as pe,e as te,j as ze,m as oe,f as Ne,as as g,t as xe,_ as ge,l as It,p as ee,n as Rt,q as At}from"./index-Ck9i7U5g.js";import{F as me,I as _e,u as ve}from"./Positions-CNJyKkJq.js";import{f as Dt}from"./ObjModel-B35Wmw0m.js";import{u as Ae,g as Bt,a as Vt,V as Ut}from"./VSelect-BZ6XBBR_.js";import{V as je}from"./VMenu-BJ41JeIu.js";import"./VSlideGroup-DE3KTn_7.js";function kt(e,i,s,r,f,o,a){return{ambient:e,diffuse:i,emissive:s,opacity:r,opticalDensity:f,shininess:o,specular:a}}const Ot=kt(j(1,1,1),j(.8,.8,.8),j(0,0,0),1,1,225,j(.5,.5,.5));function*zt(e,i){for(const[s,r]of e.entries())for(const f of r)yield i(s,f)}function*Nt(e,i){for(const[s,r]of e.entries())yield i(s,r)}const gt=(e,i)=>[i.uid,i],jt=(e,i)=>{const s=i.length,r=new me(s,_e.MAT4),f=new me(s,_e.VEC4),o=new me(s,_e.FLOAT);return[e,{positions:r,ids:f,selections:o}]};function Gt(e){const i=new Map(zt(e,gt)),s=new Map(Nt(e,jt));function r(a){return st(i.get(a),`No model instance found for uid=${a}`)}function f(a){e.forEach((v,h)=>{const x=s.get(h);if(x===void 0)return;const{positions:E,ids:_,selections:l}=x;E.clear(),_.clear(),l.clear();let p=0;for(const c of v){const{activate:S,deactivate:w,isInView:M}=c;M(a)?(S({position:E.itemAt(p),id:_.itemAt(p),selection:l.itemAt(p)}),p++):w()}})}function o(a){i.forEach(v=>{v.setHovered(v.uid===a)})}return{models:e,buffers:s,findInstanceByUid:r,select:f,hover:o}}function Ht(e){const i=q(e,e.getParameter(e.MAX_CLIENT_WAIT_TIMEOUT_WEBGL),"Failed to retrieve max client wait timeout");async function s(o){const a=q(o,o.fenceSync(o.SYNC_GPU_COMMANDS_COMPLETE,0),"Failed to get sync object");return o.flush(),new Promise((v,h)=>{function x(){switch(o.clientWaitSync(a,o.SYNC_FLUSH_COMMANDS_BIT,i)){case o.WAIT_FAILED:if(E--)requestAnimationFrame(x);else{const _=o.getError();o.deleteSync(a),h(_)}break;case o.TIMEOUT_EXPIRED:requestAnimationFrame(x);break;default:o.deleteSync(a),v(o.NO_ERROR)}}let E=1;requestAnimationFrame(x)})}async function r(o,a,v,h,x,E,_){return await s(o),o.bindBuffer(a,v),o.getBufferSubData(a,h,x,E,_),o.bindBuffer(a,null),x}async function f(o,a,v,h,x,E,_,l,p=0){const c=o.createBuffer();o.bindBuffer(o.PIXEL_PACK_BUFFER,c),o.bufferData(o.PIXEL_PACK_BUFFER,l.byteLength,o.STREAM_READ),o.readPixels(a,v,h,x,E,_,p),o.bindBuffer(o.PIXEL_PACK_BUFFER,null),await r(o,o.PIXEL_PACK_BUFFER,c,0,l),o.deleteBuffer(c)}return{readPixels:(o,a,v,h,x,E,_,l)=>f(e,o,a,v,h,x,E,_,l)}}function Xt(e,i=300,s=150){const r=q(e,e.createTexture(),"Failed to create texture");e.bindTexture(e.TEXTURE_2D,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const f=q(e,e.createRenderbuffer(),"Failed to create render buffer");e.bindRenderbuffer(e.RENDERBUFFER,f);const o=q(e,e.createFramebuffer(),"Failed to create frame buffer");e.bindFramebuffer(e.FRAMEBUFFER,o),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,r,0),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,f),a(i,s);function a(v,h){e.bindTexture(e.TEXTURE_2D,r),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,v,h,0,e.RGBA,e.UNSIGNED_BYTE,null),e.bindRenderbuffer(e.RENDERBUFFER,f),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,v,h)}return{frameBuffer:o,setSize:a}}const he=8;function Kt(e,i){return!!(e>>>i&1)}function Ge(e,i){return 1<<i*he-1-e}function $t(e,i,s){return e&=~Ge(i,s),e}function Wt(e,i,s){return e|=Ge(i,s),e}function Yt(e){if(e<1||e>4)throw new RangeError(`Bytes should be in the range 1 - 4, was: ${e}`)}function qt(e,i=4){Yt(i);let s=0;const r=i*he;for(let f=0;f<r;f++){const o=Kt(e,f),a=f%i*he+Math.floor(f/i);s=o?Wt(s,a,i):$t(s,a,i)}return s}const Jt=e=>e[0]<<16|e[1]<<8|e[2];function*Qt(){let e=0;for(;e<16777215;)yield qt(++e,3);throw new Error(`Ran out of UIDs (n=${e})`)}let Zt=Qt();function eo(){return Zt.next().value}function to(){const e=Ee({hovered:0,selected:new Set});let i,s,r,f=150;const o=new Uint8Array(4);function a(_){i=_,s=Ht(_),r=Xt(i)}function v(){if(r===void 0)throw new Error("Picking has not been initialised");return r.frameBuffer}function h(_,l){f=l,r?.setSize(_,l)}function x(){e.selected.clear();const _=e.hovered;return _>0&&e.selected.add(_),_}function E(_){const{x:l,y:p}=_;return new Promise(c=>{if(i===void 0||s===void 0)throw new Error("Picking has not been initialised");s.readPixels(l,f-p,1,1,i.RGBA,i.UNSIGNED_BYTE,o).then(()=>{const S=Jt(o);e.hovered=S,c(S)},()=>{e.hovered=0,c(0)})})}return{...De(e),init:a,getPickingFrameBuffer:v,setPickingFrameBufferSize:h,setHoveredAsSelection:x,setMousePosition:E}}const oo=(e,i=6)=>(isFinite(e)?e:0).toString(16).padStart(i,"0");function no(e,i){return{modelName:e,modelParts:i}}const Y=1.15;function io(e,i,s){const r=eo(),f=ct(...ut(r).toArray()),o=Ee({worldCoord:{...i},hovered:!1,selected:!1,buffers:void 0}),a=Q(c=>{const{x:S,y:w,z:M}=o.worldCoord;return c===void 0?j(S,w,M):ft(c,S,w,M)}),v=Q(()=>o.selected?.2:o.hovered?.1:0),h=dt();function x(c){lt(h,y(a),c);const[S,w,M]=h,k=S/-M,O=w/-M;return k>-Y&&k<Y&&O>-Y&&O<Y+Y}function E(c){o.buffers=c,mt(o.buffers.position,y(a)),_t(o.buffers.id,f),o.buffers.selection[0]=y(v)}function _(){o.buffers=void 0}function l(c){o.hovered!==c&&(o.hovered=c,o.buffers&&(o.buffers.selection[0]=y(v)))}function p(c){o.selected!==c&&(o.selected=c,o.buffers&&(o.buffers.selection[0]=y(v)))}return{...De(o),uid:r,modelName:e,meta:s,isInView:x,activate:E,deactivate:_,setHovered:l,setSelected:p}}function ro(e,i,s){const r=new Map,f=new Set;return i.nodes.filter(o=>!!o.object).reduce((o,a)=>{const{object:v,altitude:h,position:x}=a,{type:E,index:_}=v;if(E===void 0)return o;const l=E==="DECORATIVE"?`${E}_${_}`:E,p=`${l.toLowerCase()}.obj`;if(f.has(p))return o;let c=r.get(p);if(c===void 0){const D=e.get(p);if(D===void 0)return f.add(p),o;const z=Dt(D);c=no(p,z),r.set(p,c)}const[S,w,M]=s.vertexFor(x.x,x.y),k=(M&1)-1,O=io(p,{x:S+k,y:w,z:M},{objectId:l,position:x,altitude:h});return o.has(c)?o.get(c).push(O):o.set(c,[O]),o},new Map)}var ao=`#version 300 es
precision highp float;in vec3 v_normal;in vec2 v_texcoord;in vec3 v_surfaceToLight;uniform vec3 u_emissive;uniform vec3 u_ambient;uniform vec3 u_ambientLight;uniform vec3 u_diffuse;uniform float u_opacity;uniform sampler2D u_texture;out vec4 outColour;void main(void){vec3 normal=normalize(v_normal);vec3 surfaceToLightDirection=normalize(v_surfaceToLight);float diffuseLight=dot(surfaceToLightDirection,normal)*0.5+0.5;vec4 diffuseColour=texture(u_texture,v_texcoord);vec3 diffuse=u_diffuse*diffuseColour.rgb;float opacity=u_opacity*diffuseColour.a;outColour=vec4(u_emissive+u_ambient*u_ambientLight+diffuse*diffuseLight,opacity);}`,so=`#version 300 es
precision highp sampler2D;in mat4 a_model_position;in vec3 a_vertex;in vec2 a_lscoord;uniform mat4 u_projection;uniform mat4 u_view;uniform sampler2D u_miscDataMap;uniform sampler2D u_miscData2Map;uniform vec3 u_worldLightPosition;out vec3 v_normal;out vec2 v_texcoord;out vec3 v_surfaceToLight;const int NUM_TILES=2;const float HEIGHT_SCALE=0.2;const ivec2[6]EVEN_VERTEX_OFFSETS=ivec2[6](ivec2(0,0),ivec2(0,1),ivec2(1,1),ivec2(0,0),ivec2(1,1),ivec2(1,0));const ivec2[6]ODD_VERTEX_OFFSETS=ivec2[6](ivec2(0,0),ivec2(-1,1),ivec2(0,1),ivec2(0,0),ivec2(0,1),ivec2(1,0));int wrap_int(int value,int min_value,int max_value){return((value-min_value)%(max_value+min_value))+min_value;}ivec2 getMainVertexCoord(vec2 lscoord,ivec2 mapSize,int tile){int tileOffset=tile*mapSize.y/NUM_TILES;int y=int(lscoord.r)+tileOffset;int x=wrap_int(int(lscoord.g)+int((y&1)==0),0,mapSize.x);return ivec2(x,y);}ivec2 getOffsetVertexCoord(vec2 lscoord,ivec2 mapSize,int tile,int vertexId,bool isEvenRow){int mapHeight=mapSize.y/NUM_TILES;int tileOffset=tile*mapHeight;ivec2 vertexOffset=isEvenRow ? EVEN_VERTEX_OFFSETS[vertexId]: ODD_VERTEX_OFFSETS[vertexId];int y=wrap_int(int(lscoord.r)+vertexOffset.y,0,mapHeight)+tileOffset;int x=wrap_int(int(lscoord.g)+vertexOffset.x+int((y&1)==0),0,mapSize.x);return ivec2(x,y);}int lookupInt(sampler2D source,int row,int offset){vec4 pixel=texelFetch(source,ivec2(offset>>2,row),0);return int(pixel[offset&3]*255.0);}vec2 texcoordFromLs(vec2 ls1){int triangle=int(step(3.0,float(gl_VertexID)));int lsId=int(ls1[triangle]*255.0);int tileXoffset=lookupInt(u_miscData2Map,lsId,0);int tileYoffset=lookupInt(u_miscData2Map,lsId,1);int vertexXoffset=lookupInt(u_miscData2Map,lsId,2+(gl_VertexID<<1));int vertexYoffset=lookupInt(u_miscData2Map,lsId,3+(gl_VertexID<<1));return vec2(float(tileXoffset+vertexXoffset)/255.0,float(tileYoffset+vertexYoffset)/255.0);}void main(void){ivec2 mapSize=textureSize(u_miscDataMap,0);ivec2 mainVertexCoord=getMainVertexCoord(a_lscoord,mapSize,1);bool isEvenRow=(mainVertexCoord.y&1)==0;vec4 mainVertexMap1Colour=texelFetch(u_miscDataMap,mainVertexCoord,0);vec2 ls=mainVertexMap1Colour.gb;ivec2 offsetVertexCoordTile0=getOffsetVertexCoord(a_lscoord,mapSize,0,gl_VertexID,isEvenRow);vec4 offsetVertexMap0Colour=texelFetch(u_miscDataMap,offsetVertexCoordTile0,0);vec3 normal=offsetVertexMap0Colour.rgb;ivec2 offsetVertexCoordTile1=getOffsetVertexCoord(a_lscoord,mapSize,1,gl_VertexID,isEvenRow);vec4 offsetVertexMap1Colour=texelFetch(u_miscDataMap,offsetVertexCoordTile1,0);float altitude=(offsetVertexMap1Colour.r*255.0)*HEIGHT_SCALE;vec4 worldPosition=u_view*a_model_position*vec4(a_vertex.x,altitude,a_vertex.z,1.0);gl_Position=u_projection*worldPosition;v_normal=normal;v_texcoord=texcoordFromLs(ls);v_surfaceToLight=u_worldLightPosition-worldPosition.xyz;}`,co=`#version 300 es
precision highp float;in vec3 v_normal;in vec4 v_colour;in vec2 v_texcoord;in vec3 v_tangent;in vec3 v_surfaceToLight;in vec3 v_surfaceToView;uniform vec3 u_emissive;uniform vec3 u_ambient;uniform vec3 u_ambientLight;uniform vec3 u_diffuse;uniform vec3 u_specular;uniform float u_opacity;uniform float u_shininess;uniform sampler2D u_diffuseMap;uniform sampler2D u_normalMap;uniform sampler2D u_specularMap;out vec4 outColour;void main(void){vec3 normal=normalize(v_normal)*(float(gl_FrontFacing)*2.0-1.0);vec3 tangent=normalize(v_tangent)*(float(gl_FrontFacing)*2.0-1.0);vec3 bitangent=normalize(cross(normal,tangent));mat3 tbn=mat3(tangent,bitangent,normal);normal=texture(u_normalMap,v_texcoord).rgb*2.0-1.0;normal=normalize(tbn*normal);vec3 surfaceToLightDirection=normalize(v_surfaceToLight);vec3 surfaceToViewDirection=normalize(v_surfaceToView);vec3 halfVector=normalize(surfaceToLightDirection+surfaceToViewDirection);float diffuseLight=dot(surfaceToLightDirection,normal)*0.5+0.5;vec4 diffuseMapColour=texture(u_diffuseMap,v_texcoord);vec3 diffuse=u_diffuse*diffuseMapColour.rgb*v_colour.rgb;float specularLight=clamp(dot(normal,halfVector),0.0,1.0);vec4 specularMapColour=texture(u_specularMap,v_texcoord);vec3 specular=u_specular*specularMapColour.rgb;float opacity=u_opacity*diffuseMapColour.a*v_colour.a;outColour=vec4(u_emissive+u_ambient*u_ambientLight+diffuse*diffuseLight+specular*pow(specularLight,u_shininess),opacity);}`,uo=`#version 300 es
layout(location=0)in mat4 a_model_position;layout(location=4)in vec3 a_vertex;in vec3 a_normal;layout(location=7)in vec4 a_colour;in float a_selection;in vec2 a_texcoord;in vec3 a_tangent;uniform mat4 u_projection;uniform mat4 u_view;uniform mat4 u_world;uniform vec3 u_worldLightPosition;uniform vec3 u_cameraPosition;out vec3 v_normal;out vec4 v_colour;out vec2 v_texcoord;out vec3 v_tangent;out vec3 v_surfaceToLight;out vec3 v_surfaceToView;void main(){vec4 worldPosition=u_view*a_model_position*vec4(a_vertex,1.0);gl_Position=u_projection*worldPosition;v_colour=a_colour+vec4(a_selection,a_selection,a_selection,0.0);v_texcoord=a_texcoord;v_surfaceToLight=u_worldLightPosition-worldPosition.xyz;v_surfaceToView=u_cameraPosition-worldPosition.xyz;mat3 normalMat=mat3(u_world);v_normal=normalize(normalMat*a_normal);v_tangent=normalize(normalMat*a_tangent);}`,fo=`#version 300 es
precision highp float;flat in vec4 v_colour;out vec4 outColour;void main(){outColour=v_colour;}`,lo=`#version 300 es
layout(location=0)in mat4 a_model_position;layout(location=4)in vec3 a_vertex;layout(location=7)in vec4 a_colour;uniform mat4 u_projection;uniform mat4 u_view;flat out vec4 v_colour;void main(){gl_Position=u_projection*u_view*a_model_position*vec4(a_vertex,1.0);v_colour=a_colour;}`;const mo=3e5,_o=1,vo=ne({__name:"MapScene",props:{mapDefinition:{},heightAndTypeMap:{},tileMap:{},models:{},textureSet:{}},setup(e,{expose:i}){function s(t,n){switch(n){case 0:return t.hqCoordinates;case 1:return t.portalCoordinates;case 2:return{x:t.width/2,y:t.height/2}}}const r=vt(),f=j(-128,64,0),o=j(.1,.1,.1),a=e,v=Be(void 0),{loadingStore:h}=Ve(),x=Ee({projectionMode:ue.PERSPECTIVE}),E=[ao,co,fo],_=[so,uo,lo],l=pt(xt.LookAt),p=to();let c,S;const w=[],M=[];let k;const O=Ae(a.mapDefinition),D=Gt(ro(a.models,a.mapDefinition,O));let z=0;const Te=_o*12;function Z(t,n){const d=s(t,n)??s(t,2),[m,u,T]=O.vertexFor(d.x,d.y),F=(d.y&1)-1;l.lookAt(m+F,u,T),l.moveTo(m+F,Te,T+Te),z=0}function be(t){x.projectionMode=t,K.resize()}function He(t,n,{projection:d,view:m},{indexes:u,vertexes:T},F,b){const{ambient:R,emissive:A,opacity:N}=Ot,G=j(1,1,1);n.setClearColour(Tt),n.setEnableBits(t.CULL_FACE,t.DEPTH_TEST),n.bindUniform("u_projection",L=>t.uniformMatrix4fv(L,!1,d)),n.bindUniform("u_view",L=>t.uniformMatrix4fv(L,!1,m)),n.bindUniform("u_ambientLight",L=>t.uniform3fv(L,o)),n.bindUniform("u_worldLightPosition",L=>t.uniform3fv(L,f)),n.bindUniform("u_emissive",L=>t.uniform3fv(L,A)),n.bindUniform("u_ambient",L=>t.uniform3fv(L,R)),n.bindUniform("u_diffuse",L=>t.uniform3fv(L,G)),n.bindUniform("u_opacity",L=>t.uniform1f(L,N));const $=Ie(t),W=Me(Pe(t),Ce(t),Le(t),wt(t,a.tileMap),bt(t,yt(16,24,St))),X=Se(t,n,t.TRIANGLES,Fe(t,n,$,W,t.TRIANGLES,u.length,b.usedCount,ve("a_model_position",b),U("a_vertex",T,3,t.FLOAT),U("a_lscoord",F,2,t.FLOAT,1),de(u)));return Ft(qe,X.setTexture,{immediate:!0}),X}function Xe(t,n,{projection:d,view:m}){return n.bindUniform("u_projection",u=>t.uniformMatrix4fv(u,!1,d)),n.bindUniform("u_view",u=>t.uniformMatrix4fv(u,!1,m)),n.bindUniform("u_world",u=>t.uniformMatrix4fv(u,!1,r)),n.bindUniform("u_cameraPosition",u=>t.uniform3fv(u,l.position)),n.bindUniform("u_ambientLight",u=>t.uniform3fv(u,o)),n.bindUniform("u_worldLightPosition",u=>t.uniform3fv(u,f)),Array.from(D.buffers.entries(),([u,T])=>{const{modelParts:F}=u,{positions:b,selections:R}=T,A=F.map(N=>{const{buffer:G,ambient:$,diffuse:W,emissive:X,opacity:L,shininess:ie,specular:re,diffuseMap:ae,normalMap:se,specularMap:ce}=N,{vertexes:tt,normals:ot,colours:nt,texcoords:it,tangents:rt,indexes:we}=G,H=Ie(t);H.bindUniform("u_emissive",V=>t.uniform3fv(V,X)),H.bindUniform("u_ambient",V=>t.uniform3fv(V,$)),H.bindUniform("u_diffuse",V=>t.uniform3fv(V,W)),H.bindUniform("u_specular",V=>t.uniform3fv(V,re)),H.bindUniform("u_opacity",V=>t.uniform1f(V,L)),H.bindUniform("u_shininess",V=>t.uniform1f(V,ie+25));const at=Me(Pe(t,ae),Ce(t,se),Le(t,ce));return Fe(t,n,H,at,t.TRIANGLES,we.length,b.usedCount,ve("a_model_position",b),U("a_vertex",tt,3,t.FLOAT),U("a_normal",ot,3,t.FLOAT),U("a_colour",nt,4,t.FLOAT),U("a_selection",R,1,t.FLOAT,1),U("a_texcoord",it,2,t.FLOAT),U("a_tangent",rt,3,t.FLOAT),de(we))});return Se(t,n,t.TRIANGLES,...A)})}function Ke(t,n,{projection:d,view:m}){return n.setClearColour(Mt),n.setEnableBits(t.CULL_FACE,t.DEPTH_TEST),n.bindUniform("u_projection",u=>t.uniformMatrix4fv(u,!1,d)),n.bindUniform("u_view",u=>t.uniformMatrix4fv(u,!1,m)),Array.from(D.buffers.entries(),([u,T])=>{const{modelParts:F}=u,{ids:b,positions:R}=T,{buffer:A}=F[0],{indexes:N,vertexes:G}=A;return Lt(t,n,t.TRIANGLES,N.length,R.usedCount,ve("a_model_position",R),U("a_vertex",G,3,t.FLOAT),U("a_colour",b,4,t.FLOAT,1),de(N))})}function $e(t,n){n.bind("ArrowDown",()=>l.pedestal(-.5)),n.bind("ArrowUp",()=>l.pedestal(.5)),n.bind("ArrowLeft",()=>z+=100),n.bind("ArrowRight",()=>z-=100),n.bind("Home",()=>Z(a.mapDefinition,0)),n.bind("End",()=>Z(a.mapDefinition,1)),n.bind("Space",()=>z=0),n.bind("KeyC",()=>Z(a.mapDefinition,2)),n.bind("KeyO",()=>be(ue.ORTHOGRAPHIC)),n.bind("KeyP",()=>be(ue.PERSPECTIVE)),n.bind("KeyL",()=>{c.setDrawMode(t.LINE_LOOP),w.forEach(d=>d.setDrawMode(t.LINE_LOOP)),M.forEach(d=>d.setDrawMode(t.LINE_LOOP))}),n.bind("KeyK",()=>{c.setDrawMode(t.TRIANGLES),w.forEach(d=>d.setDrawMode(t.TRIANGLES)),M.forEach(d=>d.setDrawMode(t.TRIANGLES))})}function We(t,n){let d=0;n.bind(le.Left,()=>{if(y(p.hovered)!==d){if(y(p.selected).forEach(m=>D.findInstanceByUid(m).setSelected(!1)),d=p.setHoveredAsSelection(),d>0){const m=D.findInstanceByUid(d),{meta:u,setSelected:T}=m;T(!0),Re({uid:oo(d),...u})}else Re(void 0);fe(D.buffers.values(),w).forEach((m,u)=>{const{selections:T}=m;u.updateBuffer("a_selection",T,T.usedLength)})}}),n.bind(le.Right,m=>{l.track(-m.movement.dx/10,-m.movement.dy/10)}),n.bind(le.Left|Ct.Ctrl,m=>{l.tilt(m.movement.dy/10),l.pan(m.movement.dx/10)}),n.bindScroll(m=>l.dolly(m*.25)),n.bindMove(m=>k=m)}function Ye(t,n){n.bind(d=>{function m(T,F){const{movement:b}=F,{dx:R,dy:A}=b;(Math.abs(R)>0||Math.abs(A)>0)&&T.track(-R/10,-A/10)}function u(T,F,b){const{movement:R,currentPosition:A}=F,{movement:N,currentPosition:G}=b,{dx:$,dy:W}=R,{x:X,y:L}=A,{dx:ie,dy:re}=N,{x:ae,y:se}=G,ce=Math.sign(X-ae)*($+ie)+Math.sign(L-se)*(W+re);T.dolly(ce/10)}switch(d.length){case 1:m(l,d[0]);break;case 2:u(l,d[0],d[1]);break}})}const qe=Q(()=>a.textureSet?.image),Je=(t,[n,d,m],{keyboard:u,mouse:T,touch:F},b)=>{const R=Bt(),A=Ae(a.mapDefinition);S=Vt(A),S.selectAll(A),c=He(t,n,b,R,S.lsCoords,S.positions),D.select(b.view),w.splice(0,1/0,...Xe(t,d,b)),p.init(t),M.splice(0,1/0,...Ke(t,m,b)),$e(t,u),We(t,T),Ye(t,F),Z(a.mapDefinition,0),h.setLoading(!1)},Qe=(t,n)=>{const{drawingBufferWidth:d,drawingBufferHeight:m}=t;p.setPickingFrameBufferSize(d,m),D.select(n),fe(D.buffers.values(),w,M).forEach((u,T,F)=>{const{positions:b,ids:R,selections:A}=u;T.setInstanceCount(b.usedCount),T.updateBuffer("a_model_position",b,b.usedLength),T.updateBuffer("a_selection",A,A.usedLength),F.setInstanceCount(b.usedCount),F.updateBuffer("a_model_position",b,b.usedLength),F.updateBuffer("a_colour",R,R.usedLength)})},Ze=()=>{c.activate(),c.draw(),w.filter(n=>y(n.instanceCount)>0).forEach(n=>{n.activate(!1),n.draw()});let t=0;M.filter(n=>y(n.instanceCount)>0).forEach(n=>{n.activate(t++===0,p.getPickingFrameBuffer()),n.draw()}),t>0&&k&&p.setMousePosition(k).then(et)};let ye=0;function et(t){if(t===ye)return;ye=t;const n=t>0?"pointer":void 0;y(v)?.setMouseCursor(n),D.hover(t),fe(D.buffers.values(),w).forEach((d,m)=>{const{selections:u}=d;m.updateBuffer("a_selection",u,u.usedLength)})}const K=ht(l,Je,Qe,Ze,t=>{z!==0&&l.arc(z*t/mo)},()=>{M.forEach(t=>t.delete()),w.forEach(t=>t.delete()),c.delete()});return i({fps:K.fps}),(t,n)=>(I(),B(Et,{ref_key:"glPanel",ref:v,"fragment-sources":E,"vertex-sources":_,"projection-mode":x.projectionMode,onInit:y(K).init,onResize:y(K).resize,onExit:y(K).exit},null,8,["projection-mode","onInit","onResize","onExit"]))}}),po={key:1},xo=ne({__name:"KeyControl",props:{keyControls:{}},setup(e){return(i,s)=>(I(),B(je,{location:"bottom center"},{activator:P(({props:r})=>[C(pe,{location:"top"},{activator:P(({props:f})=>[C(ze,oe(oe(r,f),{icon:"mdi-keyboard-variant",tile:""}),null,16)]),default:P(()=>[s[0]||(s[0]=te(" Keyboard control ",-1))]),_:2},1024)]),default:P(()=>[C(Ue,{density:"compact","bg-color":"secondary"},{default:P(()=>[(I(!0),J(Oe,null,ke(e.keyControls,r=>(I(),B(Ne,{key:r.key,title:r.action},{prepend:P(()=>[r.key.startsWith("mdi-")?(I(),B(g,{key:0,icon:r.key},null,8,["icon"])):(I(),J("kbd",po,xe(r.key),1))]),_:2},1032,["title"]))),128))]),_:1})]),_:1}))}}),ho=ge(xo,[["__scopeId","data-v-8b7cd330"]]),Eo={key:0},To={key:1},bo=ne({__name:"MouseControl",props:{mouseControls:{}},setup(e){return(i,s)=>(I(),B(je,{location:"bottom center"},{activator:P(({props:r})=>[C(pe,{location:"top"},{activator:P(({props:f})=>[C(ze,oe(oe(r,f),{icon:"mdi-mouse-variant",tile:""}),null,16)]),default:P(()=>[s[0]||(s[0]=te(" Mouse control ",-1))]),_:2},1024)]),default:P(()=>[C(Ue,{density:"compact","bg-color":"secondary"},{default:P(()=>[(I(!0),J(Oe,null,ke(e.mouseControls,r=>(I(),B(Ne,{key:r.action,title:r.action},{prepend:P(()=>[C(pe,{activator:"parent",location:"left"},{default:P(()=>[te(xe(r.tooltip),1)]),_:2},1024),r.modifier?(I(),J("kbd",Eo,[te(xe(r.modifier)+" ",1),C(g,{icon:"mdi-plus",size:"x-small"})])):(I(),J("kbd",To)),r.leftButton?(I(),B(g,{key:2,icon:"mdi-rectangle",size:"large"})):(I(),B(g,{key:3,icon:"mdi-rectangle-outline",size:"large"})),r.wheel?(I(),B(g,{key:4,icon:"mdi-rectangle",size:"large"})):(I(),B(g,{key:5,icon:"mdi-rectangle-outline",size:"large"})),r.rightButton?(I(),B(g,{key:6,icon:"mdi-rectangle",size:"large"})):(I(),B(g,{key:7,icon:"mdi-rectangle-outline",size:"large"}))]),_:2},1032,["title"]))),128))]),_:1})]),_:1}))}}),yo=ge(bo,[["__scopeId","data-v-06a81ba9"]]),Ao=ne({__name:"MapPanel",setup(e){const i=Be(void 0),{mapStore:s,modelsStore:r,texturesStore:f}=Ve(),{heightAndTypeMap:o,map:a,tileMap:v}=s,{modelCache:h}=r,{currentTexture:x,selectTextureById:E,textureList:_}=f,l=Q(()=>{const{worldType:w}=y(a);return y(_).filter(M=>M.worldType===w)}),p=Q(()=>y(x).id),c=[{key:"mdi-arrow-up-bold",action:"move camera up"},{key:"mdi-arrow-down-bold",action:"move camera down"},{key:"mdi-arrow-left-bold",action:"increase camera movement to the left"},{key:"mdi-arrow-right-bold",action:"increase camera movement to the right"},{key:"space",action:"stop camera moving"},{key:"Home",action:"return camera to start position"},{key:"End",action:"send camera to the exit portal position"},{key:"C",action:"send camera to the centre of the map"},{key:"O",action:"orthographic rendering"},{key:"P",action:"perspective rendering"},{key:"K",action:"filled drawing"},{key:"L",action:"line drawing"}],S=[{modifier:"<ctrl>",leftButton:!0,tooltip:"Ctrl + Left button",action:"turn the camera"},{rightButton:!0,tooltip:"Right button",action:"move the camera"},{wheel:!0,tooltip:"Wheel",action:"zoom the camera"}];return(w,M)=>(I(),B(It,{fluid:"",class:"d-flex flex-column pa-0"},{default:P(()=>[C(At,{class:"flex-grow-0 flex-shrink-0",color:"secondary"},{default:P(()=>[C(ee,{class:"ml-3","max-width":"176"},{default:P(()=>[C(Ut,{"item-value":"id","item-title":"name",label:"Landscape","hide-details":"",items:l.value,"model-value":p.value,"onUpdate:modelValue":y(E)},null,8,["items","model-value","onUpdate:modelValue"])]),_:1}),C(Rt),C(ee,{class:"mr-3","max-width":"56"},{default:P(()=>[C(ho,{"key-controls":c})]),_:1}),C(ee,{class:"mr-3","max-width":"56"},{default:P(()=>[C(yo,{"mouse-controls":S})]),_:1}),C(ee,{class:"mr-3","max-width":"56"},{default:P(()=>[C(Pt,{class:"noMouse","hide-details":"",label:"fps","model-value":i.value?.fps,readonly:""},null,8,["model-value"])]),_:1})]),_:1}),C(vo,{ref_key:"mapScene",ref:i,class:"flex-fill","map-definition":y(a),"height-and-type-map":y(o),"tile-map":y(v),models:y(h).contents,"texture-set":y(x)},null,8,["map-definition","height-and-type-map","tile-map","models","texture-set"])]),_:1}))}});export{Ao as default};
