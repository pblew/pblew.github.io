import{f as g,y as ye,z as Y,q as ut,A as ft,D as dt,E as lt,F as mt,P as ce,c as _t,C as vt,u as pt,G as xt,H as ue,d as ht,j as we,w as Et,h as Tt,x as bt,k as Me,l as Ce,m as Le,p as Se,o as Pe,g as fe,e as O,i as Re,I as yt,J as wt,B as de,M as Mt,K as Ct,V as Lt}from"./VTextField-BOb9BvTK.js";import{u as b,aq as Be,ar as Ve,as as St,x as ee,d as oe,at as Pt,s as Ue,c as I,o as w,z as Rt,v as Ft,y as Fe,w as L,a as R,V as ke,g as q,h as Oe,F as ze,i as ve,e as Z,j as Ne,m as te,f as ge,au as N,t as pe,_ as je,r as It,l as At,av as Ie,p as Q,n as Dt,q as Bt}from"./index-DZCFnzis.js";import{F as le,I as me,u as _e}from"./Positions-DQCArEdh.js";import{S as Ge,b as Vt,u as Ae,g as Ut,a as kt,V as Ot}from"./VSelect-HvvPnQwR.js";import{f as zt}from"./ObjModel-B_lwznql.js";import{V as He}from"./VMenu-RlJWbLkt.js";import"./VSlideGroup-DvHmRCB8.js";function Nt(e,r,s,a,c,i,n){return{ambient:e,diffuse:r,emissive:s,opacity:a,opticalDensity:c,shininess:i,specular:n}}const gt=Nt(g(1,1,1),g(.8,.8,.8),g(0,0,0),1,1,225,g(.5,.5,.5));function*jt(e,r){for(const[s,a]of e.entries())for(const c of a)yield r(s,c)}function*Gt(e,r){for(const[s,a]of e.entries())yield r(s,a)}const Ht=(e,r)=>[r.uid,r],Xt=(e,r)=>{const s=r.length,a=new le(s,me.MAT4),c=new le(s,me.VEC4),i=new le(s,me.FLOAT);return[e,{positions:a,ids:c,selections:i}]};function Kt(e,r,s){const{positions:a,ids:c,selections:i}=s;a.clear(),c.clear(),i.clear();let n=0;r.forEach(d=>{const{activate:x,deactivate:u,mapCoord:h}=d;e.isVisible(b(h).index)?(x({position:a.itemAt(n),id:c.itemAt(n),selection:i.itemAt(n)}),n++):u()})}function $t(e){const r=new Map(jt(e,Ht)),s=new Map(Gt(e,Xt));function a(n){return ye(r.get(n),`No model instance found for uid=${n}`)}function c(n){Ge.of(e.entries()).filter(([d,x])=>s.has(d)).forEach(([d,x])=>Kt(n,x,ye(s.get(d),`Buffer not found for model=${d}`)))}function i(n){r.forEach(d=>{d.setHovered(d.uid===n)})}return{models:e,buffers:s,findInstanceByUid:a,select:c,hover:i}}function Wt(e){const r=Y(e,e.getParameter(e.MAX_CLIENT_WAIT_TIMEOUT_WEBGL),"Failed to retrieve max client wait timeout");async function s(i){const n=Y(i,i.fenceSync(i.SYNC_GPU_COMMANDS_COMPLETE,0),"Failed to get sync object");return i.flush(),new Promise((d,x)=>{function u(){switch(i.clientWaitSync(n,i.SYNC_FLUSH_COMMANDS_BIT,r)){case i.WAIT_FAILED:if(h--)requestAnimationFrame(u);else{const _=i.getError();i.deleteSync(n),x(_)}break;case i.TIMEOUT_EXPIRED:requestAnimationFrame(u);break;default:i.deleteSync(n),d(i.NO_ERROR)}}let h=1;requestAnimationFrame(u)})}async function a(i,n,d,x,u,h,_){return await s(i),i.bindBuffer(n,d),i.getBufferSubData(n,x,u,h,_),i.bindBuffer(n,null),u}async function c(i,n,d,x,u,h,_,v,S=0){const E=i.createBuffer();i.bindBuffer(i.PIXEL_PACK_BUFFER,E),i.bufferData(i.PIXEL_PACK_BUFFER,v.byteLength,i.STREAM_READ),i.readPixels(n,d,x,u,h,_,S),i.bindBuffer(i.PIXEL_PACK_BUFFER,null),await a(i,i.PIXEL_PACK_BUFFER,E,0,v),i.deleteBuffer(E)}return{readPixels:(i,n,d,x,u,h,_,v)=>c(e,i,n,d,x,u,h,_,v)}}function Yt(e,r=300,s=150){const a=Y(e,e.createTexture(),"Failed to create texture");e.bindTexture(e.TEXTURE_2D,a),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const c=Y(e,e.createRenderbuffer(),"Failed to create render buffer");e.bindRenderbuffer(e.RENDERBUFFER,c);const i=Y(e,e.createFramebuffer(),"Failed to create frame buffer");e.bindFramebuffer(e.FRAMEBUFFER,i),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,a,0),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,c),n(r,s);function n(d,x){e.bindTexture(e.TEXTURE_2D,a),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,d,x,0,e.RGBA,e.UNSIGNED_BYTE,null),e.bindRenderbuffer(e.RENDERBUFFER,c),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,d,x)}return{frameBuffer:i,setSize:n}}const xe=8;function qt(e,r){return!!(e>>>r&1)}function Xe(e,r){return 1<<r*xe-1-e}function Jt(e,r,s){return e&=~Xe(r,s),e}function Qt(e,r,s){return e|=Xe(r,s),e}function Zt(e){if(e<1||e>4)throw new RangeError(`Bytes should be in the range 1 - 4, was: ${e}`)}function eo(e,r=4){Zt(r);let s=0;const a=r*xe;for(let c=0;c<a;c++){const i=qt(e,c),n=c%r*xe+Math.floor(c/r);s=i?Qt(s,n,r):Jt(s,n,r)}return s}const to=e=>e[0]<<16|e[1]<<8|e[2];function*oo(){let e=0;for(;e<16777215;)yield eo(++e,3);throw new Error(`Ran out of UIDs (n=${e})`)}let no=oo();function io(){return no.next().value}function ro(){const e=Be({hovered:0,selected:new Set});let r,s,a,c=150;const i=new Uint8Array(4);function n(_){r=_,s=Wt(_),a=Yt(r)}function d(){if(a===void 0)throw new Error("Picking has not been initialised");return a.frameBuffer}function x(_,v){c=v,a?.setSize(_,v)}function u(){e.selected.clear();const _=e.hovered;return _>0&&e.selected.add(_),_}function h(_){const{x:v,y:S}=_;return new Promise(E=>{if(r===void 0||s===void 0)throw new Error("Picking has not been initialised");s.readPixels(v,c-S,1,1,r.RGBA,r.UNSIGNED_BYTE,i).then(()=>{const p=to(i);e.hovered=p,E(p)},()=>{e.hovered=0,E(0)})})}return{...Ve(e),init:n,getPickingFrameBuffer:d,setPickingFrameBufferSize:x,setHoveredAsSelection:u,setMousePosition:h}}const ao=(e,r=6)=>(isFinite(e)?e:0).toString(16).padStart(r,"0");function so(e,r){return{modelName:e,modelParts:r}}function co(e,r,s,a){const c=io(),i=ut(...ft(c).toArray()),{x:n,y:d,z:x}=s,u=St({mapCoord:r,worldCoord:g(n,d,x),hovered:!1,selected:!1,buffers:void 0}),h=ee(()=>u.selected?.2:u.hovered?.1:0);function _(p){u.buffers=p,dt(p.position,u.worldCoord),lt(p.id,i),p.selection[0]=b(h)}function v(){u.buffers=void 0}function S(p){u.hovered!==p&&(u.hovered=p,u.buffers&&(u.buffers.selection[0]=b(h)))}function E(p){u.selected!==p&&(u.selected=p,u.buffers&&(u.buffers.selection[0]=b(h)))}return{...Ve(u),uid:c,modelName:e,meta:a,activate:_,deactivate:v,setHovered:S,setSelected:E}}function uo(e,r,s){const a=new Map,c=new Set;function i(n){const d=e.get(n);if(d===void 0){c.add(n);return}const x=zt(d),u=so(n,x);return a.set(n,u),u}return Ge.of(r.nodes).filter(n=>!!n.object).reduce((n,d)=>{const{object:x,altitude:u,position:h}=d,{type:_,index:v}=x;if(_===void 0)return n;const S=_==="DECORATIVE"?`${_}_${v}`:_,E=`${S.toLowerCase()}.obj`;if(c.has(E))return n;const p=a.get(E)??i(E);if(p===void 0)return n;const[D,U,z]=s.vertexFor(h.x,h.y),j=(z&1)-1,A=co(E,Vt(h.x,h.y,r.width),{x:D+j,y:U,z},{objectId:S,position:h,altitude:u});return n.has(p)?n.get(p).push(A):n.set(p,[A]),n},new Map)}var fo=`#version 300 es
precision highp float;in vec3 v_normal;in vec2 v_texcoord;in vec3 v_surfaceToLight;uniform vec3 u_emissive;uniform vec3 u_ambient;uniform vec3 u_ambientLight;uniform vec3 u_diffuse;uniform float u_opacity;uniform sampler2D u_texture;out vec4 outColour;void main(void){vec3 normal=normalize(v_normal);vec3 surfaceToLightDirection=normalize(v_surfaceToLight);float diffuseLight=dot(surfaceToLightDirection,normal)*0.5+0.5;vec4 diffuseColour=texture(u_texture,v_texcoord);vec3 diffuse=u_diffuse*diffuseColour.rgb;float opacity=u_opacity*diffuseColour.a;outColour=vec4(u_emissive+u_ambient*u_ambientLight+diffuse*diffuseLight,opacity);}`,lo=`#version 300 es
precision highp sampler2D;in mat4 a_model_position;in vec3 a_vertex;in vec2 a_lscoord;uniform mat4 u_projection;uniform mat4 u_view;uniform sampler2D u_miscDataMap;uniform sampler2D u_miscData2Map;uniform vec3 u_worldLightPosition;out vec3 v_normal;out vec2 v_texcoord;out vec3 v_surfaceToLight;const int NUM_TILES=2;const float HEIGHT_SCALE=0.2;const ivec2[6]EVEN_VERTEX_OFFSETS=ivec2[6](ivec2(0,0),ivec2(0,1),ivec2(1,1),ivec2(0,0),ivec2(1,1),ivec2(1,0));const ivec2[6]ODD_VERTEX_OFFSETS=ivec2[6](ivec2(0,0),ivec2(-1,1),ivec2(0,1),ivec2(0,0),ivec2(0,1),ivec2(1,0));int wrap_int(int value,int min_value,int max_value){return((value-min_value)%(max_value+min_value))+min_value;}ivec2 getMainVertexCoord(vec2 lscoord,ivec2 mapSize,int tile){int tileOffset=tile*mapSize.y/NUM_TILES;int y=int(lscoord.r)+tileOffset;int x=wrap_int(int(lscoord.g)+int((y&1)==0),0,mapSize.x);return ivec2(x,y);}ivec2 getOffsetVertexCoord(vec2 lscoord,ivec2 mapSize,int tile,int vertexId,bool isEvenRow){int mapHeight=mapSize.y/NUM_TILES;int tileOffset=tile*mapHeight;ivec2 vertexOffset=isEvenRow ? EVEN_VERTEX_OFFSETS[vertexId]: ODD_VERTEX_OFFSETS[vertexId];int y=wrap_int(int(lscoord.r)+vertexOffset.y,0,mapHeight)+tileOffset;int x=wrap_int(int(lscoord.g)+vertexOffset.x+int((y&1)==0),0,mapSize.x);return ivec2(x,y);}int lookupInt(sampler2D source,int row,int offset){vec4 pixel=texelFetch(source,ivec2(offset>>2,row),0);return int(pixel[offset&3]*255.0);}vec2 texcoordFromLs(vec2 ls1){int triangle=int(step(3.0,float(gl_VertexID)));int lsId=int(ls1[triangle]*255.0);int tileXoffset=lookupInt(u_miscData2Map,lsId,0);int tileYoffset=lookupInt(u_miscData2Map,lsId,1);int vertexXoffset=lookupInt(u_miscData2Map,lsId,2+(gl_VertexID<<1));int vertexYoffset=lookupInt(u_miscData2Map,lsId,3+(gl_VertexID<<1));return vec2(float(tileXoffset+vertexXoffset)/255.0,float(tileYoffset+vertexYoffset)/255.0);}void main(void){ivec2 mapSize=textureSize(u_miscDataMap,0);ivec2 mainVertexCoord=getMainVertexCoord(a_lscoord,mapSize,1);bool isEvenRow=(mainVertexCoord.y&1)==0;vec4 mainVertexMap1Colour=texelFetch(u_miscDataMap,mainVertexCoord,0);vec2 ls=mainVertexMap1Colour.gb;ivec2 offsetVertexCoordTile0=getOffsetVertexCoord(a_lscoord,mapSize,0,gl_VertexID,isEvenRow);vec4 offsetVertexMap0Colour=texelFetch(u_miscDataMap,offsetVertexCoordTile0,0);vec3 normal=offsetVertexMap0Colour.rgb;ivec2 offsetVertexCoordTile1=getOffsetVertexCoord(a_lscoord,mapSize,1,gl_VertexID,isEvenRow);vec4 offsetVertexMap1Colour=texelFetch(u_miscDataMap,offsetVertexCoordTile1,0);float altitude=(offsetVertexMap1Colour.r*255.0)*HEIGHT_SCALE;vec4 worldPosition=u_view*a_model_position*vec4(a_vertex.x,altitude,a_vertex.z,1.0);gl_Position=u_projection*worldPosition;v_normal=normal;v_texcoord=texcoordFromLs(ls);v_surfaceToLight=u_worldLightPosition-worldPosition.xyz;}`,mo=`#version 300 es
precision highp float;in vec3 v_normal;in vec4 v_colour;in vec2 v_texcoord;in vec3 v_tangent;in vec3 v_surfaceToLight;in vec3 v_surfaceToView;uniform vec3 u_emissive;uniform vec3 u_ambient;uniform vec3 u_ambientLight;uniform vec3 u_diffuse;uniform vec3 u_specular;uniform float u_opacity;uniform float u_shininess;uniform sampler2D u_diffuseMap;uniform sampler2D u_normalMap;uniform sampler2D u_specularMap;out vec4 outColour;void main(void){vec3 normal=normalize(v_normal)*(float(gl_FrontFacing)*2.0-1.0);vec3 tangent=normalize(v_tangent)*(float(gl_FrontFacing)*2.0-1.0);vec3 bitangent=normalize(cross(normal,tangent));mat3 tbn=mat3(tangent,bitangent,normal);normal=texture(u_normalMap,v_texcoord).rgb*2.0-1.0;normal=normalize(tbn*normal);vec3 surfaceToLightDirection=normalize(v_surfaceToLight);vec3 surfaceToViewDirection=normalize(v_surfaceToView);vec3 halfVector=normalize(surfaceToLightDirection+surfaceToViewDirection);float diffuseLight=dot(surfaceToLightDirection,normal)*0.5+0.5;vec4 diffuseMapColour=texture(u_diffuseMap,v_texcoord);vec3 diffuse=u_diffuse*diffuseMapColour.rgb*v_colour.rgb;float specularLight=clamp(dot(normal,halfVector),0.0,1.0);vec4 specularMapColour=texture(u_specularMap,v_texcoord);vec3 specular=u_specular*specularMapColour.rgb;float opacity=u_opacity*diffuseMapColour.a*v_colour.a;outColour=vec4(u_emissive+u_ambient*u_ambientLight+diffuse*diffuseLight+specular*pow(specularLight,u_shininess),opacity);}`,_o=`#version 300 es
layout(location=0)in mat4 a_model_position;layout(location=4)in vec3 a_vertex;in vec3 a_normal;layout(location=7)in vec4 a_colour;in float a_selection;in vec2 a_texcoord;in vec3 a_tangent;uniform mat4 u_projection;uniform mat4 u_view;uniform mat4 u_world;uniform vec3 u_worldLightPosition;uniform vec3 u_cameraPosition;out vec3 v_normal;out vec4 v_colour;out vec2 v_texcoord;out vec3 v_tangent;out vec3 v_surfaceToLight;out vec3 v_surfaceToView;void main(){vec4 worldPosition=u_view*a_model_position*vec4(a_vertex,1.0);gl_Position=u_projection*worldPosition;v_colour=a_colour+vec4(a_selection,a_selection,a_selection,0.0);v_texcoord=a_texcoord;v_surfaceToLight=u_worldLightPosition-worldPosition.xyz;v_surfaceToView=u_cameraPosition-worldPosition.xyz;mat3 normalMat=mat3(u_world);v_normal=normalize(normalMat*a_normal);v_tangent=normalize(normalMat*a_tangent);}`,vo=`#version 300 es
precision highp float;flat in vec4 v_colour;out vec4 outColour;void main(){outColour=v_colour;}`,po=`#version 300 es
layout(location=0)in mat4 a_model_position;layout(location=4)in vec3 a_vertex;layout(location=7)in vec4 a_colour;uniform mat4 u_projection;uniform mat4 u_view;flat out vec4 v_colour;void main(){gl_Position=u_projection*u_view*a_model_position*vec4(a_vertex,1.0);v_colour=a_colour;}`;const xo=3e5,De=1.25,ho=1,Eo=oe({__name:"MapScene",props:{mapDefinition:{},heightAndTypeMap:{},tileMap:{},models:{},textureSet:{}},setup(e,{expose:r}){function s(t,o){switch(o){case 0:return t.hqCoordinates;case 1:return t.portalCoordinates;case 2:return{x:t.width/2,y:t.height/2}}}const a=mt(),c=g(-128,64,0),i=g(.1,.1,.1),n=e,d=Pt("glPanel"),{loadingStore:x}=Ue(),u=Be({projectionMode:ce.PERSPECTIVE}),h=[fo,mo,vo],_=[lo,_o,po],v=_t(vt.LookAt),S=ro();let E,p;const D=[],U=[];let z;const j=Ae(n.mapDefinition),A=$t(uo(n.models,n.mapDefinition,j));let H=0;const he=ho*12;function J(t,o){const l=s(t,o)??s(t,2),[m,f,T]=j.vertexFor(l.x,l.y),F=(l.y&1)-1;v.lookAt(m+F,f,T),v.moveTo(m+F,he,T+he),H=0}function Ee(t){u.projectionMode=t,K.resize()}function Ke(t,o,{projection:l,view:m},{indexes:f,vertexes:T},F,y){const{ambient:P,emissive:M,opacity:B}=gt,k=g(1,1,1);o.setClearColour(ht),o.setEnableBits(t.CULL_FACE,t.DEPTH_TEST,t.SCISSOR_TEST),o.bindUniform("u_projection",C=>t.uniformMatrix4fv(C,!1,l)),o.bindUniform("u_view",C=>t.uniformMatrix4fv(C,!1,m)),o.bindUniform("u_ambientLight",C=>t.uniform3fv(C,i)),o.bindUniform("u_worldLightPosition",C=>t.uniform3fv(C,c)),o.bindUniform("u_emissive",C=>t.uniform3fv(C,M)),o.bindUniform("u_ambient",C=>t.uniform3fv(C,P)),o.bindUniform("u_diffuse",C=>t.uniform3fv(C,k)),o.bindUniform("u_opacity",C=>t.uniform1f(C,B));const $=Re(t),W=we(Le(t),Ce(t),Me(t),bt(t,n.tileMap),Et(t,Tt(16,24,Rt))),X=Se(t,o,t.TRIANGLES,Pe(t,o,$,W,t.TRIANGLES,f.length,y.usedCount,_e("a_model_position",y),O("a_vertex",T,3,t.FLOAT),O("a_lscoord",F,2,t.FLOAT,1),fe(f)));return Ft(Qe,X.setTexture,{immediate:!0}),X}function $e(t,o,{projection:l,view:m}){return o.bindUniform("u_projection",f=>t.uniformMatrix4fv(f,!1,l)),o.bindUniform("u_view",f=>t.uniformMatrix4fv(f,!1,m)),o.bindUniform("u_world",f=>t.uniformMatrix4fv(f,!1,a)),o.bindUniform("u_cameraPosition",f=>t.uniform3fv(f,v.position)),o.bindUniform("u_ambientLight",f=>t.uniform3fv(f,i)),o.bindUniform("u_worldLightPosition",f=>t.uniform3fv(f,c)),Array.from(A.buffers.entries(),([f,T])=>{const{modelParts:F}=f,{positions:y,selections:P}=T,M=F.map(B=>{const{buffer:k,ambient:$,diffuse:W,emissive:X,opacity:C,shininess:ne,specular:ie,diffuseMap:re,normalMap:ae,specularMap:se}=B,{vertexes:nt,normals:it,colours:rt,texcoords:at,tangents:st,indexes:be}=k,G=Re(t);G.bindUniform("u_emissive",V=>t.uniform3fv(V,X)),G.bindUniform("u_ambient",V=>t.uniform3fv(V,$)),G.bindUniform("u_diffuse",V=>t.uniform3fv(V,W)),G.bindUniform("u_specular",V=>t.uniform3fv(V,ie)),G.bindUniform("u_opacity",V=>t.uniform1f(V,C)),G.bindUniform("u_shininess",V=>t.uniform1f(V,ne+25));const ct=we(Le(t,re),Ce(t,ae),Me(t,se));return Pe(t,o,G,ct,t.TRIANGLES,be.length,y.usedCount,_e("a_model_position",y),O("a_vertex",nt,3,t.FLOAT),O("a_normal",it,3,t.FLOAT),O("a_colour",rt,4,t.FLOAT),O("a_selection",P,1,t.FLOAT,1),O("a_texcoord",at,2,t.FLOAT),O("a_tangent",st,3,t.FLOAT),fe(be))});return Se(t,o,t.TRIANGLES,...M)})}function We(t,o,{projection:l,view:m}){return o.setClearColour(yt),o.setEnableBits(t.CULL_FACE,t.DEPTH_TEST),o.bindUniform("u_projection",f=>t.uniformMatrix4fv(f,!1,l)),o.bindUniform("u_view",f=>t.uniformMatrix4fv(f,!1,m)),Array.from(A.buffers.entries(),([f,T])=>{const{modelParts:F}=f,{ids:y,positions:P}=T,{buffer:M}=F[0],{indexes:B,vertexes:k}=M;return wt(t,o,t.TRIANGLES,B.length,P.usedCount,_e("a_model_position",P),O("a_vertex",k,3,t.FLOAT),O("a_colour",y,4,t.FLOAT,1),fe(B))})}function Ye(t,o){o.bind("ArrowDown",()=>v.pedestal(-.5)),o.bind("ArrowUp",()=>v.pedestal(.5)),o.bind("ArrowLeft",()=>H+=100),o.bind("ArrowRight",()=>H-=100),o.bind("Home",()=>J(n.mapDefinition,0)),o.bind("End",()=>J(n.mapDefinition,1)),o.bind("Space",()=>H=0),o.bind("KeyC",()=>J(n.mapDefinition,2)),o.bind("KeyO",()=>Ee(ce.ORTHOGRAPHIC)),o.bind("KeyP",()=>Ee(ce.PERSPECTIVE)),o.bind("KeyL",()=>{E.setDrawMode(t.LINE_LOOP),D.forEach(l=>l.setDrawMode(t.LINE_LOOP)),U.forEach(l=>l.setDrawMode(t.LINE_LOOP))}),o.bind("KeyK",()=>{E.setDrawMode(t.TRIANGLES),D.forEach(l=>l.setDrawMode(t.TRIANGLES)),U.forEach(l=>l.setDrawMode(t.TRIANGLES))})}function qe(t,o){let l=0;o.bind(de.Left,()=>{if(b(S.hovered)!==l){if(b(S.selected).forEach(m=>A.findInstanceByUid(m).setSelected(!1)),l=S.setHoveredAsSelection(),l>0){const m=A.findInstanceByUid(l),{meta:f,setSelected:T}=m;T(!0),Fe({uid:ao(l),...f})}else Fe(void 0);ue(A.buffers.values(),D).forEach((m,f)=>{const{selections:T}=m;f.updateBuffer("a_selection",T,T.usedLength)})}}),o.bind(de.Right,m=>{v.track(-m.movement.dx/10,-m.movement.dy/10)}),o.bind(de.Left|Mt.Ctrl,m=>{v.tilt(m.movement.dy/10),v.pan(m.movement.dx/10)}),o.bindScroll(m=>v.dolly(m*.25)),o.bindMove(m=>z=m)}function Je(t,o){o.bind(l=>{function m(T,F){const{movement:y}=F,{dx:P,dy:M}=y;(Math.abs(P)>0||Math.abs(M)>0)&&T.track(-P/10,-M/10)}function f(T,F,y){const{movement:P,currentPosition:M}=F,{movement:B,currentPosition:k}=y,{dx:$,dy:W}=P,{x:X,y:C}=M,{dx:ne,dy:ie}=B,{x:re,y:ae}=k,se=Math.sign(X-re)*($+ne)+Math.sign(C-ae)*(W+ie);T.dolly(se/10)}switch(l.length){case 1:m(v,l[0]);break;case 2:f(v,l[0],l[1]);break}})}const Qe=ee(()=>n.textureSet?.image),Ze=(t,[o,l,m],{keyboard:f,mouse:T,touch:F},y)=>{const P=Ut(),M=Ae(n.mapDefinition);p=kt(M),p.select(y.view,De),E=Ke(t,o,y,P,p.lsCoords,p.positions),A.select(p),D.splice(0,1/0,...$e(t,l,y)),S.init(t),U.splice(0,1/0,...We(t,m,y)),Ye(t,f),qe(t,T),Je(t,F),J(n.mapDefinition,0),x.setLoading(!1)},et=(t,o)=>{const{drawingBufferWidth:l,drawingBufferHeight:m}=t;S.setPickingFrameBufferSize(l,m),p.select(o,De),A.select(p);const{lsCoords:f,positions:T}=p;E.setInstanceCount(T.usedCount),E.updateBuffer("a_model_position",T,T.usedLength),E.updateBuffer("a_lscoord",f,f.usedLength),ue(A.buffers.values(),D,U).forEach((F,y,P)=>{const{positions:M,ids:B,selections:k}=F;y.setInstanceCount(M.usedCount),y.updateBuffer("a_model_position",M,M.usedLength),y.updateBuffer("a_selection",k,k.usedLength),P.setInstanceCount(M.usedCount),P.updateBuffer("a_model_position",M,M.usedLength),P.updateBuffer("a_colour",B,B.usedLength)})},tt=()=>{E.activate(),E.draw(),D.filter(o=>b(o.instanceCount)>0).forEach(o=>{o.activate(!1),o.draw()});let t=0;U.filter(o=>b(o.instanceCount)>0).forEach(o=>{o.activate(t++===0,S.getPickingFrameBuffer()),o.draw()}),t>0&&z&&S.setMousePosition(z).then(ot)};let Te=0;function ot(t){if(t===Te)return;Te=t;const o=t>0?"pointer":void 0;b(d)?.setMouseCursor(o),A.hover(t),ue(A.buffers.values(),D).forEach((l,m)=>{const{selections:f}=l;m.updateBuffer("a_selection",f,f.usedLength)})}const K=pt(v,Ze,et,tt,t=>{H!==0&&v.arc(H*t/xo)},()=>{U.forEach(t=>t.delete()),D.forEach(t=>t.delete()),E.delete()});return r({fps:K.fps}),(t,o)=>(w(),I(xt,{ref_key:"glPanel",ref:d,"fragment-sources":h,"vertex-sources":_,"projection-mode":u.projectionMode,onInit:b(K).init,onResize:b(K).resize,onExit:b(K).exit},null,8,["projection-mode","onInit","onResize","onExit"]))}}),To={key:1},bo=oe({__name:"KeyControl",props:{keyControls:{}},setup(e){return(r,s)=>(w(),I(He,{location:"bottom center"},{activator:L(({props:a})=>[R(ve,{location:"top"},{activator:L(({props:c})=>[R(Ne,te(te(a,c),{icon:"mdi-keyboard-variant",tile:""}),null,16)]),default:L(()=>[s[0]||(s[0]=Z(" Keyboard control ",-1))]),_:2},1024)]),default:L(()=>[R(ke,{density:"compact","bg-color":"secondary"},{default:L(()=>[(w(!0),q(ze,null,Oe(e.keyControls,a=>(w(),I(ge,{key:a.key,title:a.action},{prepend:L(()=>[a.key.startsWith("mdi-")?(w(),I(N,{key:0,icon:a.key},null,8,["icon"])):(w(),q("kbd",To,pe(a.key),1))]),_:2},1032,["title"]))),128))]),_:1})]),_:1}))}}),yo=je(bo,[["__scopeId","data-v-8b7cd330"]]),wo={key:0},Mo={key:1},Co=oe({__name:"MouseControl",props:{mouseControls:{}},setup(e){return(r,s)=>(w(),I(He,{location:"bottom center"},{activator:L(({props:a})=>[R(ve,{location:"top"},{activator:L(({props:c})=>[R(Ne,te(te(a,c),{icon:"mdi-mouse-variant",tile:""}),null,16)]),default:L(()=>[s[0]||(s[0]=Z(" Mouse control ",-1))]),_:2},1024)]),default:L(()=>[R(ke,{density:"compact","bg-color":"secondary"},{default:L(()=>[(w(!0),q(ze,null,Oe(e.mouseControls,a=>(w(),I(ge,{key:a.action,title:a.action},{prepend:L(()=>[R(ve,{activator:"parent",location:"left"},{default:L(()=>[Z(pe(a.tooltip),1)]),_:2},1024),a.modifier?(w(),q("kbd",wo,[Z(pe(a.modifier)+" ",1),R(N,{icon:"mdi-plus",size:"x-small"})])):(w(),q("kbd",Mo)),a.leftButton?(w(),I(N,{key:2,icon:"mdi-rectangle",size:"large"})):(w(),I(N,{key:3,icon:"mdi-rectangle-outline",size:"large"})),a.wheel?(w(),I(N,{key:4,icon:"mdi-rectangle",size:"large"})):(w(),I(N,{key:5,icon:"mdi-rectangle-outline",size:"large"})),a.rightButton?(w(),I(N,{key:6,icon:"mdi-rectangle",size:"large"})):(w(),I(N,{key:7,icon:"mdi-rectangle-outline",size:"large"}))]),_:2},1032,["title"]))),128))]),_:1})]),_:1}))}}),Lo=je(Co,[["__scopeId","data-v-06a81ba9"]]),Uo=oe({__name:"MapPanel",setup(e){const{hasKeyboard:r,hasMouse:s}=Ct(),a=It(void 0),{mapStore:c,modelsStore:i,texturesStore:n}=Ue(),{heightAndTypeMap:d,map:x,tileMap:u}=c,{modelCache:h}=i,{currentTexture:_,selectTextureById:v,textureList:S}=n,E=ee(()=>{const{worldType:z}=b(x);return b(S).filter(j=>j.worldType===z)}),p=ee(()=>b(_).id),D=[{key:"mdi-arrow-up-bold",action:"move camera up"},{key:"mdi-arrow-down-bold",action:"move camera down"},{key:"mdi-arrow-left-bold",action:"increase camera movement to the left"},{key:"mdi-arrow-right-bold",action:"increase camera movement to the right"},{key:"space",action:"stop camera moving"},{key:"Home",action:"return camera to start position"},{key:"End",action:"send camera to the exit portal position"},{key:"C",action:"send camera to the centre of the map"},{key:"O",action:"orthographic rendering"},{key:"P",action:"perspective rendering"},{key:"K",action:"filled drawing"},{key:"L",action:"line drawing"}],U=[{modifier:"<ctrl>",leftButton:!0,tooltip:"Ctrl + Left button",action:"turn the camera"},{rightButton:!0,tooltip:"Right button",action:"move the camera"},{wheel:!0,tooltip:"Wheel",action:"zoom the camera"}];return(z,j)=>(w(),I(At,{fluid:"",class:"d-flex flex-column pa-0"},{default:L(()=>[R(Bt,{class:"flex-grow-0 flex-shrink-0",color:"secondary"},{default:L(()=>[R(Q,{class:"ml-3","max-width":"176"},{default:L(()=>[R(Ot,{"item-value":"id","item-title":"name",label:"Landscape","hide-details":"",items:E.value,"model-value":p.value,"onUpdate:modelValue":b(v)},null,8,["items","model-value","onUpdate:modelValue"])]),_:1}),R(Dt),b(r)?(w(),I(Q,{key:0,class:"mr-3","max-width":"56"},{default:L(()=>[R(yo,{"key-controls":D})]),_:1})):Ie("",!0),b(s)?(w(),I(Q,{key:1,class:"mr-3","max-width":"56"},{default:L(()=>[R(Lo,{"mouse-controls":U})]),_:1})):Ie("",!0),R(Q,{class:"mr-3","max-width":"56"},{default:L(()=>[R(Lt,{class:"no-mouse","hide-details":"",label:"fps","model-value":a.value?.fps,readonly:""},null,8,["model-value"])]),_:1})]),_:1}),R(Eo,{ref_key:"mapScene",ref:a,class:"flex-fill","map-definition":b(x),"height-and-type-map":b(d),"tile-map":b(u),models:b(h).contents,"texture-set":b(_)},null,8,["map-definition","height-and-type-map","tile-map","models","texture-set"])]),_:1}))}});export{Uo as default};
