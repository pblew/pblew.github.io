import{s as ke,D as ct,E as ut,n as Ae,F as Re,H as ft,a as ae,f as $,I as dt,J as ee,x as lt,K as mt,w as _t,v as vt,L as pt,y as xt,N as ht,P as xe,c as yt,Z as bt,C as Tt,u as Et,G as wt,O as he,d as Lt,b as Ft,e as j,i as Pt,j as Mt,k as Ct,l as At,m as Rt,o as Bt,g as ye,p as It,Q as St,R as Ut,B as be,M as Vt,V as kt}from"./VTextField-fH_mrKsa.js";import{ap as Fe,y as De,z as oe,u as M,s as Pe,aq as Be,d as ce,r as Ne,c as O,o as S,ar as Dt,as as Ie,w as I,a as B,V as Oe,g as te,h as ge,F as ze,i as Ee,e as re,j as je,m as ie,f as Ge,at as H,t as we,_ as Xe,l as Nt,p as ne,n as Ot,q as gt}from"./index-D-m9IlZp.js";import{F as q,I as Z,u as Se}from"./Float32Buffer-CEp1cwLg.js";import{u as Te,V as zt}from"./VSelect-7bT6iH3j.js";import{f as jt}from"./ObjModel-DdSnjHtG.js";import{V as He}from"./VMenu-CoiJaheW.js";import"./VSlideGroup-Bw7kydLO.js";class Gt extends q{constructor(n){super(n,Z.VEC3)}getNormal(n){return this.peekAt(n)}setNormal(n,i,r,d){this.setItem(n,i,r,d)}}class Xt extends q{constructor(n){super(n,Z.VEC3)}getVertex(n){return this.peekAt(n)}setVertex(n,i,r,d){this.setItem(n,i,r,d)}}const Ue=ae(),Ve=ae();class Ht extends q{constructor(n){super(n,Z.VEC3)}calculateVertexNormal(n){ke(n,0,0,0);for(const i of ct(this.capacity))ut(n,n,this.peekAt(i));Ae(n,n)}setFace(n,i,r,d){Re(Ue,i,r),Re(Ve,r,d);const t=this.peekAt(n);ft(t,Ue,Ve),Ae(t,t)}}function se(e,n,i=0){const r=n-i;return((e-i)%r+r)%r+i}function Y(e,n){return[e[0],e[1],n[2]]}function Kt(e,n){const{width:i,height:r,terrain1For:d,terrain2For:t,vertexFor:u}=e;function l(h,E){const L=se(h,i+1);return se(E,r+1)*(i+1)+L}const x=(i+1)*(r+1),_=new Xt(x),v=new Gt(x),m=new Uint8Array(x),f=new Uint8Array(x);for(const{index:h,x:E,y:L}of Te(i+1,r+1)){const[g,U,ue]=u(E,L);_.setVertex(h,g,U,ue),m[h]=d(E,L),f[h]=t(E,L)}const c=new Ht(6),a=ae();for(const{index:h,x:E,y:L}of Te(i+1,r+1)){const g=_.getVertex(h),U=[Y(u(E+1,L),_.getVertex(l(E+1,L))),Y(u(E,L+1),_.getVertex(l(E,L+1))),Y(u(E-1,L+1),_.getVertex(l(E-1,L+1))),Y(u(E-1,L),_.getVertex(l(E-1,L))),Y(u(E-1,L-1),_.getVertex(l(E-1,L-1))),Y(u(E,L-1),_.getVertex(l(E,L-1)))];c.setFace(0,g,U[1],U[0]),c.setFace(1,g,U[2],U[1]),c.setFace(2,g,U[3],U[2]),c.setFace(3,g,U[4],U[3]),c.setFace(4,g,U[5],U[4]),c.setFace(5,g,U[0],U[5]),c.calculateVertexNormal(a),v.setNormal(h,a[0],a[1],a[2])}function T(h,E){return _.getVertex(l(h,E))}function C(h,E){return v.getNormal(l(h,E))}function A(h,E){return m[l(h,E)]}function V(h,E){return f[l(h,E)]}function w(){return Te(i,r)}return{numVertexes:x,getVertex:T,getNormal:C,getTerrain1Type:A,getTerrain2Type:V,coordinates:w}}function $t(e,n,i,r,d,t,u){return{ambient:e,diffuse:n,emissive:i,opacity:r,opticalDensity:d,shininess:t,specular:u}}const Wt=$t($(1,1,1),$(.8,.8,.8),$(0,0,0),1,1,225,$(.5,.5,.5));function*Yt(e,n){for(const[i,r]of e.entries())for(const d of r)yield n(i,d)}function*qt(e,n){for(const[i,r]of e.entries())yield n(i,r)}const Zt=(e,n)=>[n.uid,n],Jt=(e,n)=>{const i=n.length,r=new q(i,Z.MAT4),d=new q(i,Z.VEC4),t=new q(i,Z.FLOAT);return[e,{positions:r,ids:d,selections:t}]};function Qt(e){const n=new Map(Yt(e,Zt)),i=new Map(qt(e,Jt));function r(u){return dt(n.get(u),`No model instance found for uid=${u}`)}function d(u){e.forEach((l,x)=>{const _=i.get(x);if(_===void 0)return;const{positions:v,ids:m,selections:f}=_;v.clear(),m.clear(),f.clear();let c=0;for(const a of l){const{activate:T,deactivate:C,isInView:A}=a;A(u)?(T({position:v.itemAt(c),id:m.itemAt(c),selection:f.itemAt(c)}),c++):C()}})}function t(u){n.forEach(l=>{l.setHovered(l.uid===u)})}return{models:e,buffers:i,findInstanceByUid:r,select:d,hover:t}}function eo(e){const n=ee(e,e.getParameter(e.MAX_CLIENT_WAIT_TIMEOUT_WEBGL),"Failed to retrieve max client wait timeout");async function i(t){const u=ee(t,t.fenceSync(t.SYNC_GPU_COMMANDS_COMPLETE,0),"Failed to get sync object");return t.flush(),new Promise((l,x)=>{function _(){switch(t.clientWaitSync(u,t.SYNC_FLUSH_COMMANDS_BIT,n)){case t.WAIT_FAILED:if(v--)requestAnimationFrame(_);else{const m=t.getError();t.deleteSync(u),x(m)}break;case t.TIMEOUT_EXPIRED:requestAnimationFrame(_);break;default:t.deleteSync(u),l(t.NO_ERROR)}}let v=1;requestAnimationFrame(_)})}async function r(t,u,l,x,_,v,m){return await i(t),t.bindBuffer(u,l),t.getBufferSubData(u,x,_,v,m),t.bindBuffer(u,null),_}async function d(t,u,l,x,_,v,m,f,c=0){const a=t.createBuffer();t.bindBuffer(t.PIXEL_PACK_BUFFER,a),t.bufferData(t.PIXEL_PACK_BUFFER,f.byteLength,t.STREAM_READ),t.readPixels(u,l,x,_,v,m,c),t.bindBuffer(t.PIXEL_PACK_BUFFER,null),await r(t,t.PIXEL_PACK_BUFFER,a,0,f),t.deleteBuffer(a)}return{readPixels:(t,u,l,x,_,v,m,f)=>d(e,t,u,l,x,_,v,m,f)}}function to(e,n=300,i=150){const r=ee(e,e.createTexture(),"Failed to create texture");e.bindTexture(e.TEXTURE_2D,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const d=ee(e,e.createRenderbuffer(),"Failed to create render buffer");e.bindRenderbuffer(e.RENDERBUFFER,d);const t=ee(e,e.createFramebuffer(),"Failed to create frame buffer");e.bindFramebuffer(e.FRAMEBUFFER,t),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,r,0),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,d),u(n,i);function u(l,x){e.bindTexture(e.TEXTURE_2D,r),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,l,x,0,e.RGBA,e.UNSIGNED_BYTE,null),e.bindRenderbuffer(e.RENDERBUFFER,d),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,l,x)}return{frameBuffer:t,setSize:u}}const Le=8;function oo(e,n){return!!(e>>>n&1)}function Ke(e,n){return 1<<n*Le-1-e}function no(e,n,i){return e&=~Ke(n,i),e}function ro(e,n,i){return e|=Ke(n,i),e}function io(e){if(e<1||e>4)throw new RangeError(`Bytes should be in the range 1 - 4, was: ${e}`)}function so(e,n=4){io(n);let i=0;const r=n*Le;for(let d=0;d<r;d++){const t=oo(e,d),u=d%n*Le+Math.floor(d/n);i=t?ro(i,u,n):no(i,u,n)}return i}const ao=e=>e[0]<<16|e[1]<<8|e[2];function*co(){let e=0;for(;e<16777215;)yield so(++e,3);throw new Error(`Ran out of UIDs (n=${e})`)}let uo=co();function fo(){return uo.next().value}function lo(){const e=Fe({hovered:0,selected:new Set});let n,i,r,d=150;const t=new Uint8Array(4);function u(m){n=m,i=eo(m),r=to(n)}function l(){if(r===void 0)throw new Error("Picking has not been initialised");return r.frameBuffer}function x(m,f){d=f,r?.setSize(m,f)}function _(){e.selected.clear();const m=e.hovered;return m>0&&e.selected.add(m),m}function v(m){const{x:f,y:c}=m;return new Promise(a=>{if(n===void 0||i===void 0)throw new Error("Picking has not been initialised");i.readPixels(f,d-c,1,1,n.RGBA,n.UNSIGNED_BYTE,t).then(()=>{const T=ao(t);e.hovered=T,a(T)},()=>{e.hovered=0,a(0)})})}return{...De(e),init:u,getPickingFrameBuffer:l,setPickingFrameBufferSize:x,setHoveredAsSelection:_,setMousePosition:v}}const mo=(e,n=6)=>(isFinite(e)?e:0).toString(16).padStart(n,"0");function _o(e,n){return{modelName:e,modelParts:n}}const Q=1.15;function vo(e,n,i){const r=fo(),d=lt(...mt(r).toArray()),t=Fe({worldCoord:{...n},hovered:!1,selected:!1,buffers:void 0}),u=oe(a=>{const{x:T,y:C,z:A}=t.worldCoord;return a===void 0?$(T,C,A):ke(a,T,C,A)}),l=oe(()=>t.selected?.2:t.hovered?.1:0),x=ae();function _(a){_t(x,M(u),a);const[T,C,A]=x,V=T/-A,w=C/-A;return V>-Q&&V<Q&&w>-Q&&w<Q+Q}function v(a){t.buffers=a,vt(t.buffers.position,M(u)),pt(t.buffers.id,d),t.buffers.selection[0]=M(l)}function m(){t.buffers=void 0}function f(a){t.hovered!==a&&(t.hovered=a,t.buffers&&(t.buffers.selection[0]=M(l)))}function c(a){t.selected!==a&&(t.selected=a,t.buffers&&(t.buffers.selection[0]=M(l)))}return{...De(t),uid:r,modelName:e,meta:i,isInView:_,activate:v,deactivate:m,setHovered:f,setSelected:c}}function po(e,n,i){const r=new Map,d=new Set;return n.nodes.filter(t=>!!t.object).reduce((t,u)=>{const{object:l,altitude:x,position:_}=u,{type:v,index:m}=l;if(v===void 0)return t;const f=v==="DECORATIVE"?`${v}_${m}`:v,c=`${f.toLowerCase()}.obj`;if(d.has(c))return t;let a=r.get(c);if(a===void 0){const w=e.get(c);if(w===void 0)return d.add(c),t;const h=jt(w);a=_o(c,h),r.set(c,a)}const[T,C,A]=i.getVertex(_.x,_.y),V=vo(c,{x:T,y:C,z:A},{objectId:f,position:_,altitude:x});return t.has(a)?t.get(a).push(V):t.set(a,[V]),t},new Map)}function xo(e){const n=new Float32Array(e*3),i=new Float32Array(e*3),r=new Float32Array(e*2),d=new Uint32Array(e);let t=0,u=0,l=0,x=0,_=0;function v(m,f,c){const[a,T,C]=m,[A,V,w]=f,[h,E]=c;n[t++]=a,n[t++]=T,n[t++]=C,i[u++]=A,i[u++]=V,i[u++]=w,r[l++]=h,r[l++]=E,d[x++]=_++}return{vertexes:n,normals:i,texcoords:r,indexes:d,emitVertex:v}}function ho(e){const{height:n,nodes:i,width:r}=e,d=-(r/2),t=-(n/2);function u(v,m){const f=se(v,r),c=se(m,n);return i[c*r+f]}function l(v,m){const f=u(v,m),{terrain1:c}=f;return Be(c)}function x(v,m){const f=u(v,m),{terrain2:c}=f;return Be(c)}function _(v,m){const c=(m&1)===0?0:.5,{altitude:a}=u(v,m);return[-(v+c+d),m+t,a*.2]}return{width:r,height:n,terrain1For:l,terrain2For:x,worldCoordinateFor:()=>{throw Error("Not implemented")},vertexFor:_}}function yo(){const{texturesStore:e}=Pe();return M(e.currentTexture)}function bo(e,n){const{numVertexes:i,coordinates:r,getNormal:d,getTerrain1Type:t,getTerrain2Type:u,getVertex:l}=e,{getT1TexCoords:x,getT2TexCoords:_}=n,v=xo(i*6),{emitVertex:m}=v;function f(c,a,T){m(l(c,a),d(c,a),T)}for(const{x:c,y:a,isEvenRow:T}of r()){const C=t(c,a),A=u(c,a),V=t(c+1,a);if(T){const w=x(A);f(c,a,w[0]),f(c,a+1,w[1]),f(c+1,a,w[2]);const h=_(V);f(c+1,a,h[0]),f(c,a+1,h[1]),f(c+1,a+1,h[2])}else{const w=_(C);f(c,a,w[0]),f(c,a+1,w[1]),f(c+1,a+1,w[2]);const h=x(A);f(c,a,h[0]),f(c+1,a+1,h[1]),f(c+1,a,h[2])}}return v}var To=`#version 300 es
precision highp float;in vec3 v_normal;in vec2 v_texcoord;in vec3 v_surfaceToLight;uniform vec3 u_emissive;uniform vec3 u_ambient;uniform vec3 u_ambientLight;uniform vec3 u_diffuse;uniform float u_opacity;uniform sampler2D u_texture;out vec4 outColour;void main(void){vec3 normal=normalize(v_normal);vec3 surfaceToLightDirection=normalize(v_surfaceToLight);float diffuseLight=dot(surfaceToLightDirection,normal)*0.5+0.5;vec4 diffuseColour=texture(u_texture,v_texcoord);vec3 diffuse=u_diffuse*diffuseColour.rgb;float opacity=u_opacity*diffuseColour.a;outColour=vec4(u_emissive+u_ambient*u_ambientLight+diffuse*diffuseLight,opacity);}`,Eo=`#version 300 es
in vec3 a_vertex;in vec2 a_texcoord;in vec3 a_normal;uniform mat4 u_projection;uniform mat4 u_view;uniform vec3 u_worldLightPosition;out vec3 v_normal;out vec2 v_texcoord;out vec3 v_surfaceToLight;void main(void){vec4 worldPosition=u_view*vec4(a_vertex,1.0);gl_Position=u_projection*worldPosition;v_normal=a_normal;v_texcoord=a_texcoord;v_surfaceToLight=u_worldLightPosition-worldPosition.xyz;}`,wo=`#version 300 es
precision highp float;in vec3 v_normal;in vec4 v_colour;in vec2 v_texcoord;in vec3 v_tangent;in vec3 v_surfaceToLight;in vec3 v_surfaceToView;uniform vec3 u_emissive;uniform vec3 u_ambient;uniform vec3 u_ambientLight;uniform vec3 u_diffuse;uniform vec3 u_specular;uniform float u_opacity;uniform float u_shininess;uniform sampler2D u_diffuseMap;uniform sampler2D u_normalMap;uniform sampler2D u_specularMap;out vec4 outColour;void main(void){vec3 normal=normalize(v_normal)*(float(gl_FrontFacing)*2.0-1.0);vec3 tangent=normalize(v_tangent)*(float(gl_FrontFacing)*2.0-1.0);vec3 bitangent=normalize(cross(normal,tangent));mat3 tbn=mat3(tangent,bitangent,normal);normal=texture(u_normalMap,v_texcoord).rgb*2.0-1.0;normal=normalize(tbn*normal);vec3 surfaceToLightDirection=normalize(v_surfaceToLight);vec3 surfaceToViewDirection=normalize(v_surfaceToView);vec3 halfVector=normalize(surfaceToLightDirection+surfaceToViewDirection);float diffuseLight=dot(surfaceToLightDirection,normal)*0.5+0.5;vec4 diffuseMapColour=texture(u_diffuseMap,v_texcoord);vec3 diffuse=u_diffuse*diffuseMapColour.rgb*v_colour.rgb;float specularLight=clamp(dot(normal,halfVector),0.0,1.0);vec4 specularMapColour=texture(u_specularMap,v_texcoord);vec3 specular=u_specular*specularMapColour.rgb;float opacity=u_opacity*diffuseMapColour.a*v_colour.a;outColour=vec4(u_emissive+u_ambient*u_ambientLight+diffuse*diffuseLight+specular*pow(specularLight,u_shininess),opacity);}`,Lo=`#version 300 es
layout(location=0)in mat4 a_model_position;layout(location=4)in vec3 a_vertex;in vec3 a_normal;layout(location=7)in vec4 a_colour;in float a_selection;in vec2 a_texcoord;in vec3 a_tangent;uniform mat4 u_projection;uniform mat4 u_view;uniform mat4 u_world;uniform vec3 u_worldLightPosition;uniform vec3 u_cameraPosition;out vec3 v_normal;out vec4 v_colour;out vec2 v_texcoord;out vec3 v_tangent;out vec3 v_surfaceToLight;out vec3 v_surfaceToView;void main(){vec4 worldPosition=u_view*a_model_position*vec4(a_vertex,1.0);gl_Position=u_projection*worldPosition;v_colour=a_colour+vec4(a_selection,a_selection,a_selection,0.0);v_texcoord=a_texcoord;v_surfaceToLight=u_worldLightPosition-worldPosition.xyz;v_surfaceToView=u_cameraPosition-worldPosition.xyz;mat3 normalMat=mat3(u_world);v_normal=normalize(normalMat*a_normal);v_tangent=normalize(normalMat*a_tangent);}`,Fo=`#version 300 es
precision highp float;flat in vec4 v_colour;out vec4 outColour;void main(){outColour=v_colour;}`,Po=`#version 300 es
layout(location=0)in mat4 a_model_position;layout(location=4)in vec3 a_vertex;layout(location=7)in vec4 a_colour;uniform mat4 u_projection;uniform mat4 u_view;flat out vec4 v_colour;void main(){gl_Position=u_projection*u_view*a_model_position*vec4(a_vertex,1.0);v_colour=a_colour;}`;const Mo=3e5,Co=1,Ao=ce({__name:"MapScene",props:{mapDefinition:{},models:{},textureSet:{}},setup(e,{expose:n}){function i(o,s){switch(s){case 0:return o.hqCoordinates;case 1:return o.portalCoordinates;case 2:return{x:o.width/2,y:o.height/2}}}const r=xt();ht(r);const d=$(128,0,32),t=$(.1,.1,.1),u=e,l=Ne(void 0),{loadingStore:x}=Pe(),_=Fe({projectionMode:xe.PERSPECTIVE}),v=[To,wo,Fo],m=[Eo,Lo,Po],f=yt(Tt.LookAt,void 0,void 0,bt),c=lo();let a;const T=[],C=[];let A;const V=Kt(ho(u.mapDefinition),yo()),w=Qt(po(u.models,u.mapDefinition,V));let h=0;const E=Co*12;function L(o,s){const y=i(o,s)??i(o,2),[b,p,F]=V.getVertex(y.x,y.y);f.lookAt(b,p,F),f.moveTo(b,p+E,E),h=0}function g(o){_.projectionMode=o,J.resize()}function U(o,s,{projection:y,view:b}){const{ambient:p,diffuse:F,emissive:k,opacity:P}=Wt;s.setClearColour(Lt),s.bindUniform("u_projection",R=>o.uniformMatrix4fv(R,!1,y)),s.bindUniform("u_view",R=>o.uniformMatrix4fv(R,!1,b)),s.bindUniform("u_ambientLight",R=>o.uniform3fv(R,t)),s.bindUniform("u_worldLightPosition",R=>o.uniform3fv(R,d)),s.bindUniform("u_emissive",R=>o.uniform3fv(R,k)),s.bindUniform("u_ambient",R=>o.uniform3fv(R,p)),s.bindUniform("u_diffuse",R=>o.uniform3fv(R,F)),s.bindUniform("u_opacity",R=>o.uniform1f(R,P));const{vertexes:D,normals:N,texcoords:G,indexes:X}=bo(V,u.textureSet),W=Ft(o,s,o.TRIANGLES,X.length,j("a_vertex",D,3,o.FLOAT),j("a_texcoord",G,2,o.FLOAT),j("a_normal",N,3,o.FLOAT),ye(X));return Dt(()=>W.setTexture(M(Ze))),W}function ue(o,s,{projection:y,view:b}){return s.bindUniform("u_projection",p=>o.uniformMatrix4fv(p,!1,y)),s.bindUniform("u_view",p=>o.uniformMatrix4fv(p,!1,b)),s.bindUniform("u_world",p=>o.uniformMatrix4fv(p,!1,r)),s.bindUniform("u_cameraPosition",p=>o.uniform3fv(p,f.position)),s.bindUniform("u_ambientLight",p=>o.uniform3fv(p,t)),s.bindUniform("u_worldLightPosition",p=>o.uniform3fv(p,d)),Array.from(w.buffers.entries(),([p,F])=>{const{modelParts:k}=p,{positions:P,selections:D}=F,N=k.map(G=>{const{buffer:X,ambient:W,diffuse:R,emissive:fe,opacity:de,shininess:le,specular:me,diffuseMap:_e,normalMap:ve,specularMap:pe}=G,{vertexes:ot,normals:nt,colours:rt,texcoords:it,tangents:st,indexes:Ce}=X,K=Pt(o);K.bindUniform("u_emissive",z=>o.uniform3fv(z,fe)),K.bindUniform("u_ambient",z=>o.uniform3fv(z,W)),K.bindUniform("u_diffuse",z=>o.uniform3fv(z,R)),K.bindUniform("u_specular",z=>o.uniform3fv(z,me)),K.bindUniform("u_opacity",z=>o.uniform1f(z,de)),K.bindUniform("u_shininess",z=>o.uniform1f(z,le+25));const at=Mt(Rt(o,_e),At(o,ve),Ct(o,pe));return Bt(o,s,K,at,o.TRIANGLES,Ce.length,P.usedCount,Se("a_model_position",P),j("a_vertex",ot,3,o.FLOAT),j("a_normal",nt,3,o.FLOAT),j("a_colour",rt,4,o.FLOAT),j("a_selection",D,1,o.FLOAT,1),j("a_texcoord",it,2,o.FLOAT),j("a_tangent",st,3,o.FLOAT),ye(Ce))});return It(o,s,o.TRIANGLES,...N)})}function $e(o,s,{projection:y,view:b}){return s.setClearColour(St),s.setEnableBits(o.CULL_FACE,o.DEPTH_TEST),s.bindUniform("u_projection",p=>o.uniformMatrix4fv(p,!1,y)),s.bindUniform("u_view",p=>o.uniformMatrix4fv(p,!1,b)),Array.from(w.buffers.entries(),([p,F])=>{const{modelParts:k}=p,{ids:P,positions:D}=F,{buffer:N}=k[0],{indexes:G,vertexes:X}=N;return Ut(o,s,o.TRIANGLES,G.length,D.usedCount,Se("a_model_position",D),j("a_vertex",X,3,o.FLOAT),j("a_colour",P,4,o.FLOAT,1),ye(G))})}function We(o,s){s.bind("ArrowDown",()=>f.pedestal(-.5)),s.bind("ArrowUp",()=>f.pedestal(.5)),s.bind("ArrowLeft",()=>h+=100),s.bind("ArrowRight",()=>h-=100),s.bind("Home",()=>L(u.mapDefinition,0)),s.bind("End",()=>L(u.mapDefinition,1)),s.bind("Space",()=>h=0),s.bind("KeyC",()=>L(u.mapDefinition,2)),s.bind("KeyO",()=>g(xe.ORTHOGRAPHIC)),s.bind("KeyP",()=>g(xe.PERSPECTIVE)),s.bind("KeyL",()=>{a.setDrawMode(o.LINE_LOOP),T.forEach(y=>y.setDrawMode(o.LINE_LOOP)),C.forEach(y=>y.setDrawMode(o.LINE_LOOP))}),s.bind("KeyK",()=>{a.setDrawMode(o.TRIANGLES),T.forEach(y=>y.setDrawMode(o.TRIANGLES)),C.forEach(y=>y.setDrawMode(o.TRIANGLES))})}function Ye(o,s){let y=0;s.bind(be.Left,()=>{if(M(c.hovered)!==y){if(M(c.selected).forEach(b=>w.findInstanceByUid(b).setSelected(!1)),y=c.setHoveredAsSelection(),y>0){const b=w.findInstanceByUid(y),{meta:p,setSelected:F}=b;F(!0),Ie({uid:mo(y),...p})}else Ie(void 0);he(w.buffers.values(),T).forEach((b,p)=>{const{selections:F}=b;p.updateBuffer("a_selection",F,F.usedLength)})}}),s.bind(be.Right,b=>{f.track(-b.movement.dx/10,-b.movement.dy/10)}),s.bind(be.Left|Vt.Ctrl,b=>{f.tilt(b.movement.dy/10),f.pan(b.movement.dx/10)}),s.bindScroll(b=>f.dolly(b*.25)),s.bindMove(b=>A=b)}function qe(o,s){s.bind(y=>{function b(F,k){const{movement:P}=k,{dx:D,dy:N}=P;(Math.abs(D)>0||Math.abs(N)>0)&&F.track(-D/10,-N/10)}function p(F,k,P){const{movement:D,currentPosition:N}=k,{movement:G,currentPosition:X}=P,{dx:W,dy:R}=D,{x:fe,y:de}=N,{dx:le,dy:me}=G,{x:_e,y:ve}=X,pe=Math.sign(fe-_e)*(W+le)+Math.sign(de-ve)*(R+me);F.dolly(pe/10)}switch(y.length){case 1:b(f,y[0]);break;case 2:p(f,y[0],y[1]);break}})}const Ze=oe(()=>u.textureSet?.image),Je=(o,[s,y,b],{keyboard:p,mouse:F,touch:k},P)=>{a=U(o,s,P),w.select(P.view),T.splice(0,1/0,...ue(o,y,P)),c.init(o),C.splice(0,1/0,...$e(o,b,P)),We(o,p),Ye(o,F),qe(o,k),L(u.mapDefinition,0),x.setLoading(!1)},Qe=(o,s)=>{const{drawingBufferWidth:y,drawingBufferHeight:b}=o;c.setPickingFrameBufferSize(y,b),w.select(s),he(w.buffers.values(),T,C).forEach((p,F,k)=>{const{positions:P,ids:D,selections:N}=p;F.setInstanceCount(P.usedCount),F.updateBuffer("a_model_position",P,P.usedLength),F.updateBuffer("a_selection",N,N.usedLength),k.setInstanceCount(P.usedCount),k.updateBuffer("a_model_position",P,P.usedLength),k.updateBuffer("a_colour",D,D.usedLength)})},et=()=>{a.activate(),a.draw(),T.filter(s=>M(s.instanceCount)>0).forEach(s=>{s.activate(!1),s.draw()});let o=0;C.filter(s=>M(s.instanceCount)>0).forEach(s=>{s.activate(o++===0,c.getPickingFrameBuffer()),s.draw()}),o>0&&A&&c.setMousePosition(A).then(tt)};let Me=0;function tt(o){if(o===Me)return;Me=o;const s=o>0?"pointer":void 0;M(l)?.setMouseCursor(s),w.hover(o),he(w.buffers.values(),T).forEach((y,b)=>{const{selections:p}=y;b.updateBuffer("a_selection",p,p.usedLength)})}const J=Et(f,Je,Qe,et,o=>{h!==0&&f.arc(h*o/Mo)},()=>{C.forEach(o=>o.delete()),T.forEach(o=>o.delete()),a.delete()});return n({fps:J.fps}),(o,s)=>(S(),O(wt,{ref_key:"glPanel",ref:l,"fragment-sources":v,"vertex-sources":m,"projection-mode":_.projectionMode,onInit:M(J).init,onResize:M(J).resize,onExit:M(J).exit},null,8,["projection-mode","onInit","onResize","onExit"]))}}),Ro={key:1},Bo=ce({__name:"KeyControl",props:{keyControls:{}},setup(e){return(n,i)=>(S(),O(He,{location:"bottom center"},{activator:I(({props:r})=>[B(Ee,{location:"top"},{activator:I(({props:d})=>[B(je,ie(ie(r,d),{icon:"mdi-keyboard-variant",tile:""}),null,16)]),default:I(()=>[i[0]||(i[0]=re(" Keyboard control ",-1))]),_:2},1024)]),default:I(()=>[B(Oe,{density:"compact","bg-color":"secondary"},{default:I(()=>[(S(!0),te(ze,null,ge(e.keyControls,r=>(S(),O(Ge,{key:r.key,title:r.action},{prepend:I(()=>[r.key.startsWith("mdi-")?(S(),O(H,{key:0,icon:r.key},null,8,["icon"])):(S(),te("kbd",Ro,we(r.key),1))]),_:2},1032,["title"]))),128))]),_:1})]),_:1}))}}),Io=Xe(Bo,[["__scopeId","data-v-8b7cd330"]]),So={key:0},Uo={key:1},Vo=ce({__name:"MouseControl",props:{mouseControls:{}},setup(e){return(n,i)=>(S(),O(He,{location:"bottom center"},{activator:I(({props:r})=>[B(Ee,{location:"top"},{activator:I(({props:d})=>[B(je,ie(ie(r,d),{icon:"mdi-mouse-variant",tile:""}),null,16)]),default:I(()=>[i[0]||(i[0]=re(" Mouse control ",-1))]),_:2},1024)]),default:I(()=>[B(Oe,{density:"compact","bg-color":"secondary"},{default:I(()=>[(S(!0),te(ze,null,ge(e.mouseControls,r=>(S(),O(Ge,{key:r.action,title:r.action},{prepend:I(()=>[B(Ee,{activator:"parent",location:"left"},{default:I(()=>[re(we(r.tooltip),1)]),_:2},1024),r.modifier?(S(),te("kbd",So,[re(we(r.modifier)+" ",1),B(H,{icon:"mdi-plus",size:"x-small"})])):(S(),te("kbd",Uo)),r.leftButton?(S(),O(H,{key:2,icon:"mdi-rectangle",size:"large"})):(S(),O(H,{key:3,icon:"mdi-rectangle-outline",size:"large"})),r.wheel?(S(),O(H,{key:4,icon:"mdi-rectangle",size:"large"})):(S(),O(H,{key:5,icon:"mdi-rectangle-outline",size:"large"})),r.rightButton?(S(),O(H,{key:6,icon:"mdi-rectangle",size:"large"})):(S(),O(H,{key:7,icon:"mdi-rectangle-outline",size:"large"}))]),_:2},1032,["title"]))),128))]),_:1})]),_:1}))}}),ko=Xe(Vo,[["__scopeId","data-v-06a81ba9"]]),Ko=ce({__name:"MapPanel",setup(e){const n=Ne(void 0),{mapStore:i,modelsStore:r,texturesStore:d}=Pe(),{map:t}=i,{modelCache:u}=r,{currentTexture:l,selectTextureById:x,textureList:_}=d,v=oe(()=>{const{worldType:a}=M(t);return M(_).filter(T=>T.worldType===a)}),m=oe(()=>M(l).id),f=[{key:"mdi-arrow-up-bold",action:"move camera up"},{key:"mdi-arrow-down-bold",action:"move camera down"},{key:"mdi-arrow-left-bold",action:"increase camera movement to the left"},{key:"mdi-arrow-right-bold",action:"increase camera movement to the right"},{key:"space",action:"stop camera moving"},{key:"Home",action:"return camera to start position"},{key:"End",action:"send camera to the exit portal position"},{key:"C",action:"send camera to the centre of the map"},{key:"O",action:"orthographic rendering"},{key:"P",action:"perspective rendering"},{key:"K",action:"filled drawing"},{key:"L",action:"line drawing"}],c=[{modifier:"<ctrl>",leftButton:!0,tooltip:"Ctrl + Left button",action:"turn the camera"},{rightButton:!0,tooltip:"Right button",action:"move the camera"},{wheel:!0,tooltip:"Wheel",action:"zoom the camera"}];return(a,T)=>(S(),O(Nt,{fluid:"",class:"d-flex flex-column pa-0"},{default:I(()=>[B(gt,{class:"flex-grow-0 flex-shrink-0",color:"secondary"},{default:I(()=>[B(ne,{class:"ml-3","max-width":"176"},{default:I(()=>[B(zt,{"item-value":"id","item-title":"name",label:"Landscape","hide-details":"",items:v.value,"model-value":m.value,"onUpdate:modelValue":M(x)},null,8,["items","model-value","onUpdate:modelValue"])]),_:1}),B(Ot),B(ne,{class:"mr-3","max-width":"56"},{default:I(()=>[B(Io,{"key-controls":f})]),_:1}),B(ne,{class:"mr-3","max-width":"56"},{default:I(()=>[B(ko,{"mouse-controls":c})]),_:1}),B(ne,{class:"mr-3","max-width":"56"},{default:I(()=>[B(kt,{class:"noMouse","hide-details":"",label:"fps","model-value":n.value?.fps,readonly:""},null,8,["model-value"])]),_:1})]),_:1}),B(Ao,{ref_key:"mapScene",ref:n,class:"flex-fill","map-definition":M(t),models:M(u).contents,"texture-set":M(l)},null,8,["map-definition","models","texture-set"])]),_:1}))}});export{Ko as default};
