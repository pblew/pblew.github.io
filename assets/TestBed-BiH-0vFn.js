import{f as T,a as X,q as K,v as Z,w as H,c as le,C as ue,x as fe,n as de,u as me,G as pe,B as Y,y as xe,d as ve,j as _e,z as he,h as we,A as ye,k as Ve,l as Se,m as Ce,p as Ee,o as Te,g as Ie,e as G,i as Me,V as ge}from"./VTextField-fH_mrKsa.js";import{F as De,I as Le,u as be}from"./Float32Buffer-CEp1cwLg.js";import{x as Fe,y as Ae,d as $,z as k,s as q,r as Oe,c as J,o as Q,u as l,v as P,A as Re,B as ze,w as z,l as Ne,a as I,p as B,n as ke,q as Be}from"./index-D-m9IlZp.js";import{u as Pe,V as W}from"./VSelect-7bT6iH3j.js";import{P as Ue}from"./Positions-BrEt00SV.js";import"./VMenu-CoiJaheW.js";import"./VSlideGroup-Bw7kydLO.js";function Xe(t){const e=new Float32Array(t*3),o=new Uint32Array(t);let i=0,c=0,r=0;function f(d){const[u,m,p]=d;e[i++]=u,e[i++]=m,e[i++]=p,o[c++]=r++}return{vertexes:e,indexes:o,emitVertex:f}}function*He(t,e){let o=e;for(const i of t){if(o>0){o--;continue}yield i}}function Ye(t,e){for(const o of t)if(!e(o))return!1;return!0}function*Ge(t,e){for(const o of t)e(o)&&(yield o)}function We(t,e){for(const o of t)if(e(o))return o}function je(t,e){for(const o of t)e(o)}function*Ke(t,e){for(const o of t)yield e(o)}function Ze(t,e,o){let i=o;for(const c of t)i=e(i,c);return i}function $e(t,e){for(const o of t)if(e(o))return!0;return!1}function*qe(t,e){let o=e;for(const i of t){if(o--<=0)break;yield i}}function N(t){return{drop:e=>N(He(t,e)),every:e=>Ye(t,e),filter:e=>N(Ge(t,e)),find:e=>We(t,e),forEach:e=>je(t,e),map:e=>N(Ke(t,e)),reduce:(e,o)=>Ze(t,e,o),some:e=>$e(t,e),take:e=>N(qe(t,e)),toArray:()=>Array.from(t),toIterable:()=>t}}const Je={of:N};class Qe extends De{selectedIndexes;constructor(e){super(e,Le.VEC2),this.selectedIndexes=new Array(e).fill(!0)}}function et(t){const e=new Qe(t.length),o=new Ue(t.length);function i(c,r){e.clear(),o.clear();let f=0;for(const d of t){const{activate:u,deactivate:m,isInView:p}=d;p(c,r)?(u({lsCoord:e.itemAt(f),position:o.itemAt(f)}),f++):m()}}return{nodes:t,lsCoords:e,positions:o,select:i}}const O=2;function tt(t,e){const{x:o,y:i,z:c}=e,r=Fe({worldCoord:T(o,i,c),minWorldCoord:T(o-O,i-O,c-O),maxWorldCoord:T(o+O,i+O,c+O)}),f=X(),d=X();function u(S,h){H(f,r.minWorldCoord,S),H(d,r.maxWorldCoord,S);const[L,g,D]=f,[R,C,b]=f,U=L/-D,F=R/-b,n=g/-D,s=C/-b;return!(F<-h||U>h||s<-h||n>h)}function m(S){r.buffers=S,K(r.buffers.lsCoord,t.y,t.x),Z(r.buffers.position,r.worldCoord)}function p(){r.buffers=void 0}return{...Ae(r),isInView:u,activate:m,deactivate:p}}function j(t){const{height:e,width:o}=t,i=o*-.5,c=e*-.5;function r(d){const[u,m,p]=d,S=m|0,h=p-c|0,g=(h&1)===0?0:-.5;return{x:u-i-g|0,y:h,z:S}}function f(d,u){const p=(u&1)===0?0:-.5;return[d+i+p,0,u+c]}return{width:o,height:e,terrain1For:()=>{throw Error("Not implemented")},terrain2For:()=>{throw Error("Not implemented")},worldCoordinateFor:r,vertexFor:f}}function ot(t){const{height:e,vertexFor:o,width:i}=t;return et(Je.of(Pe(i,e)).map(c=>{const[r,f,d]=o(c.x,c.y);return tt(c,{x:r,y:f,z:d})}).toArray())}function nt(){const t=Xe(6);return t.emitVertex(T(0,0,0)),t.emitVertex(T(-.5,0,1)),t.emitVertex(T(.5,0,1)),t.emitVertex(T(0,0,0)),t.emitVertex(T(.5,0,1)),t.emitVertex(T(1,0,0)),t}var rt=`#version 300 es
precision highp float;in vec3 v_normal;in vec2 v_texcoord;uniform vec4 u_ambientLight;uniform vec3 u_reverseLightDirection;uniform sampler2D u_texture;out vec4 outColour;void main(void){vec3 normal=normalize(v_normal);float light=dot(normal,u_reverseLightDirection);outColour=texture(u_texture,v_texcoord);outColour.rgb*=light;outColour+=u_ambientLight;}`,it=`#version 300 es
precision highp sampler2D;in mat4 a_model_position;in vec3 a_vertex;in vec2 a_lscoord;uniform mat4 u_projection;uniform mat4 u_view;uniform sampler2D u_miscDataMap;uniform sampler2D u_miscData2Map;out vec3 v_normal;out vec2 v_texcoord;out vec4 v_colour;const int NUM_TILES=2;const float HEIGHT_SCALE=0.2;const ivec2[6]EVEN_VERTEX_OFFSETS=ivec2[6](ivec2(0,0),ivec2(0,1),ivec2(1,1),ivec2(0,0),ivec2(1,1),ivec2(1,0));const ivec2[6]ODD_VERTEX_OFFSETS=ivec2[6](ivec2(0,0),ivec2(-1,1),ivec2(0,1),ivec2(0,0),ivec2(0,1),ivec2(1,0));int wrap_int(int value,int min_value,int max_value){return((value-min_value)%(max_value+min_value))+min_value;}ivec2 getMainVertexCoord(vec2 lscoord,ivec2 mapSize,int tile){int tileOffset=tile*mapSize.y/NUM_TILES;int y=int(lscoord.r)+tileOffset;int x=wrap_int(int(lscoord.g)+int((y&1)==0),0,mapSize.x);return ivec2(x,y);}ivec2 getOffsetVertexCoord(vec2 lscoord,ivec2 mapSize,int tile,int vertexId,bool isEvenRow){int mapHeight=mapSize.y/NUM_TILES;int tileOffset=tile*mapHeight;ivec2 vertexOffset=isEvenRow ? EVEN_VERTEX_OFFSETS[vertexId]: ODD_VERTEX_OFFSETS[vertexId];int y=wrap_int(int(lscoord.r)+vertexOffset.y,0,mapHeight)+tileOffset;int x=wrap_int(int(lscoord.g)+vertexOffset.x+int((y&1)==0),0,mapSize.x);return ivec2(x,y);}int lookupInt(sampler2D source,int row,int offset){vec4 pixel=texelFetch(source,ivec2(offset>>2,row),0);return int(pixel[offset&3]*255.0);}vec2 texcoordFromLs(vec2 ls1){int triangle=int(step(3.0,float(gl_VertexID)));int lsId=int(ls1[triangle]*255.0);int tileXoffset=lookupInt(u_miscData2Map,lsId,0);int tileYoffset=lookupInt(u_miscData2Map,lsId,1);int vertexXoffset=lookupInt(u_miscData2Map,lsId,2+(gl_VertexID<<1));int vertexYoffset=lookupInt(u_miscData2Map,lsId,3+(gl_VertexID<<1));return vec2(float(tileXoffset+vertexXoffset)/255.0,float(tileYoffset+vertexYoffset)/255.0);}void main(void){ivec2 mapSize=textureSize(u_miscDataMap,0);ivec2 mainVertexCoord=getMainVertexCoord(a_lscoord,mapSize,1);bool isEvenRow=(mainVertexCoord.y&1)==0;vec4 mainVertexMap1Colour=texelFetch(u_miscDataMap,mainVertexCoord,0);vec2 ls=mainVertexMap1Colour.gb;ivec2 offsetVertexCoordTile0=getOffsetVertexCoord(a_lscoord,mapSize,0,gl_VertexID,isEvenRow);vec4 offsetVertexMap0Colour=texelFetch(u_miscDataMap,offsetVertexCoordTile0,0);vec3 normal=offsetVertexMap0Colour.rgb;ivec2 offsetVertexCoordTile1=getOffsetVertexCoord(a_lscoord,mapSize,1,gl_VertexID,isEvenRow);vec4 offsetVertexMap1Colour=texelFetch(u_miscDataMap,offsetVertexCoordTile1,0);float altitude=(offsetVertexMap1Colour.r*255.0)*HEIGHT_SCALE;vec4 worldPosition=u_view*a_model_position*vec4(a_vertex.x,altitude,a_vertex.z,1.0);gl_Position=u_projection*worldPosition;v_normal=normal;v_texcoord=texcoordFromLs(ls);}`;const st=$({__name:"TestbedScene",props:{mapDefinition:{},heightAndTypeMap:{},tileMap:{},textureSet:{}},setup(t,{expose:e}){const o=t,i=k(()=>o.textureSet?.image),{loadingStore:c}=q(),r=le(ue.LookAt),f=fe(.1,.1,.1,1),d=T(0,.15,1);de(d,d);const u=Oe(j({})),m=[],p=[];function S(n,s,{projection:a,view:E},{indexes:M,vertexes:v},w,x){s.setClearColour(ve),s.setEnableBits(n.CULL_FACE,n.DEPTH_TEST),s.bindUniform("u_projection",V=>n.uniformMatrix4fv(V,!1,a)),s.bindUniform("u_view",V=>n.uniformMatrix4fv(V,!1,E)),s.bindUniform("u_ambientLight",V=>n.uniform4fv(V,f)),s.bindUniform("u_reverseLightDirection",V=>n.uniform3fv(V,d));const _=Me(n),y=_e(Ce(n),Se(n),Ve(n),ye(n,o.tileMap),he(n,we(16,24,Re))),A=Ee(n,s,n.TRIANGLES,Te(n,s,_,y,n.TRIANGLES,M.length,x.usedCount,be("a_model_position",x),G("a_vertex",v,3,n.FLOAT),G("a_lscoord",w,2,n.FLOAT,1),Ie(M)));return P(i,()=>A.setTexture(l(i)),{immediate:!0}),A}function h(n,s){s.bind("KeyL",()=>m.forEach(a=>a.setDrawMode(n.LINE_LOOP))),s.bind("KeyK",()=>m.forEach(a=>a.setDrawMode(n.TRIANGLES)))}function L(n,s){s.bind(Y.Left,({movement:a})=>{r.tilt(a.dy*.1),r.pan(a.dx*.1)}),s.bind(Y.Right,({movement:a})=>{r.track(a.dx*-.1,-a.dy*.1)}),s.bindScroll(a=>r.dolly(a*.25))}function g(n,s){s.bind(a=>{function E(v,w){const{movement:x}=w,{dx:_,dy:y}=x;(Math.abs(_)>0||Math.abs(y)>0)&&v.track(-_/10,-y/10)}function M(v,w,x){const{movement:_,currentPosition:y}=w,{movement:A,currentPosition:V}=x,{dx:ee,dy:te}=_,{x:oe,y:ne}=y,{dx:re,dy:ie}=A,{x:se,y:ae}=V,ce=Math.sign(oe-se)*(ee+re)+Math.sign(ne-ae)*(te+ie);v.dolly(ce/10)}switch(a.length){case 1:E(r,a[0]);break;case 2:M(r,a[0],a[1]);break}})}const D=(n,[s],{keyboard:a,mouse:E,touch:M},v)=>{const w=nt();P(()=>o.mapDefinition,x=>{u.value=j(x);const _=ot(l(u));p.splice(0,1/0,_),m.splice(0,1/0,S(n,s,v,w,_.lsCoords,_.positions)).forEach(y=>y.delete()),r.moveTo(0,x.height*.5,x.height*.5),r.lookAt(0,0,0),window.setTimeout(()=>R(n,xe()))},{immediate:!0}),h(n,a),L(n,E),g(n,M),c.setLoading(!1)},R=n=>{const{worldCoordinateFor:s}=l(u);p.forEach(a=>{const{lsCoords:E,nodes:M,positions:v}=a;E.clear(),v.clear();let w=0;for(const _ of M){const y=l(_.worldCoord),{x:A,y:V}=s(y);K(E.itemAt(w),V,A),Z(v.itemAt(w),y),w++}const[x]=m;x.setInstanceCount(v.usedCount),x.updateBuffer("a_model_position",v,v.usedLength),x.updateBuffer("a_lscoord",E,E.usedLength)})},F=me(r,D,void 0,()=>{m.forEach(({activate:n,draw:s},a)=>{n(a===0),s()})},()=>{},()=>{m.splice(0,1/0).forEach(n=>n.delete())});return e({fps:F.fps}),(n,s)=>(Q(),J(pe,{"fragment-sources":[l(rt)],"vertex-sources":[l(it)],onInit:l(F).init,onResize:l(F).resize,onExit:l(F).exit},null,8,["fragment-sources","vertex-sources","onInit","onResize","onExit"]))}}),pt=$({__name:"TestBed",setup(t){const e=ze(void 0),{mapStore:o,mapsStore:i,texturesStore:c}=q(),{maps:r}=i,{heightAndTypeMap:f,loadMap:d,map:u,tileMap:m}=o,{currentTexture:p,selectTextureById:S,selectTextureByWorldType:h,textureList:L}=c,g=k(()=>l(r).map(C=>({value:C.id,title:C.name}))),D=k(()=>{const{worldType:C}=l(u);return l(L).filter(b=>b.worldType===C)});P(u,({worldType:C})=>h(C));const R=k(()=>l(p).id);return(C,b)=>(Q(),J(Ne,{fluid:"",class:"d-flex flex-column pa-0"},{default:z(()=>[I(Be,{class:"flex-grow-0 flex-shrink-0",color:"secondary"},{default:z(()=>[I(B,{class:"mr-3","max-width":"176"},{default:z(()=>[I(W,{label:"Map","hide-details":"",items:g.value,"model-value":l(u).id,"onUpdate:modelValue":l(d)},null,8,["items","model-value","onUpdate:modelValue"])]),_:1}),I(B,{class:"ml-3","max-width":"176"},{default:z(()=>[I(W,{"item-value":"id","item-title":"name",label:"Landscape","hide-details":"",items:D.value,"model-value":R.value,"onUpdate:modelValue":l(S)},null,8,["items","model-value","onUpdate:modelValue"])]),_:1}),I(ke),I(B,{class:"mr-3","max-width":"56"},{default:z(()=>[I(ge,{class:"noMouse","hide-details":"",label:"fps","model-value":e.value?.fps,readonly:""},null,8,["model-value"])]),_:1})]),_:1}),I(st,{ref_key:"testbedScene",ref:e,class:"flex-fill","map-definition":l(u),"height-and-type-map":l(f),"tile-map":l(m),"texture-set":l(p)},null,8,["map-definition","height-and-type-map","tile-map","texture-set"])]),_:1}))}});export{pt as default};
