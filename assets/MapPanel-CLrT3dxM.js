import{f as N,y as at,z as $,q as st,A as ct,D as ut,E as ft,F as dt,P as ce,c as lt,C as mt,u as _t,G as vt,H as ue,d as pt,j as ye,w as xt,h as ht,x as Et,k as we,l as Me,m as Ce,p as Le,o as Se,g as fe,e as O,i as Pe,I as Tt,J as bt,B as de,M as yt,V as wt}from"./VTextField-C8Tt_kfs.js";import{u as y,aq as Ae,ar as De,as as Mt,x as ee,d as oe,at as Ct,s as Be,c as B,o as P,z as Lt,v as St,y as Re,w as S,a as L,V as Ue,g as Y,h as Ve,F as ke,i as ve,e as Z,j as Oe,m as te,f as ze,au as z,t as pe,_ as Ne,r as Pt,l as Rt,p as Q,n as Ft,q as It}from"./index-CZGhR0OV.js";import{F as le,I as me,u as _e}from"./Positions-Ds6gUhSX.js";import{S as At,b as Dt,u as Fe,g as Bt,a as Ut,V as Vt}from"./VSelect-DSDe2SGn.js";import{f as kt}from"./ObjModel-4H6TgJcI.js";import{V as ge}from"./VMenu-CxYjlaWO.js";import"./VSlideGroup-CB414sgM.js";function Ot(e,r,s,a,f,i,n){return{ambient:e,diffuse:r,emissive:s,opacity:a,opticalDensity:f,shininess:i,specular:n}}const zt=Ot(N(1,1,1),N(.8,.8,.8),N(0,0,0),1,1,225,N(.5,.5,.5));function*Nt(e,r){for(const[s,a]of e.entries())for(const f of a)yield r(s,f)}function*gt(e,r){for(const[s,a]of e.entries())yield r(s,a)}const jt=(e,r)=>[r.uid,r],Gt=(e,r)=>{const s=r.length,a=new le(s,me.MAT4),f=new le(s,me.VEC4),i=new le(s,me.FLOAT);return[e,{positions:a,ids:f,selections:i}]};function Ht(e){const r=new Map(Nt(e,jt)),s=new Map(gt(e,Gt));function a(n){return at(r.get(n),`No model instance found for uid=${n}`)}function f(n){e.forEach((p,E)=>{const c=s.get(E);if(c===void 0)return;const{positions:h,ids:l,selections:m}=c;h.clear(),l.clear(),m.clear();let T=0;for(const x of p){const{activate:v,deactivate:I,mapCoord:A}=x;n.isVisible(y(A).index)?(v({position:h.itemAt(T),id:l.itemAt(T),selection:m.itemAt(T)}),T++):I()}})}function i(n){r.forEach(p=>{p.setHovered(p.uid===n)})}return{models:e,buffers:s,findInstanceByUid:a,select:f,hover:i}}function Xt(e){const r=$(e,e.getParameter(e.MAX_CLIENT_WAIT_TIMEOUT_WEBGL),"Failed to retrieve max client wait timeout");async function s(i){const n=$(i,i.fenceSync(i.SYNC_GPU_COMMANDS_COMPLETE,0),"Failed to get sync object");return i.flush(),new Promise((p,E)=>{function c(){switch(i.clientWaitSync(n,i.SYNC_FLUSH_COMMANDS_BIT,r)){case i.WAIT_FAILED:if(h--)requestAnimationFrame(c);else{const l=i.getError();i.deleteSync(n),E(l)}break;case i.TIMEOUT_EXPIRED:requestAnimationFrame(c);break;default:i.deleteSync(n),p(i.NO_ERROR)}}let h=1;requestAnimationFrame(c)})}async function a(i,n,p,E,c,h,l){return await s(i),i.bindBuffer(n,p),i.getBufferSubData(n,E,c,h,l),i.bindBuffer(n,null),c}async function f(i,n,p,E,c,h,l,m,T=0){const x=i.createBuffer();i.bindBuffer(i.PIXEL_PACK_BUFFER,x),i.bufferData(i.PIXEL_PACK_BUFFER,m.byteLength,i.STREAM_READ),i.readPixels(n,p,E,c,h,l,T),i.bindBuffer(i.PIXEL_PACK_BUFFER,null),await a(i,i.PIXEL_PACK_BUFFER,x,0,m),i.deleteBuffer(x)}return{readPixels:(i,n,p,E,c,h,l,m)=>f(e,i,n,p,E,c,h,l,m)}}function Kt(e,r=300,s=150){const a=$(e,e.createTexture(),"Failed to create texture");e.bindTexture(e.TEXTURE_2D,a),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const f=$(e,e.createRenderbuffer(),"Failed to create render buffer");e.bindRenderbuffer(e.RENDERBUFFER,f);const i=$(e,e.createFramebuffer(),"Failed to create frame buffer");e.bindFramebuffer(e.FRAMEBUFFER,i),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,a,0),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,f),n(r,s);function n(p,E){e.bindTexture(e.TEXTURE_2D,a),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,p,E,0,e.RGBA,e.UNSIGNED_BYTE,null),e.bindRenderbuffer(e.RENDERBUFFER,f),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,p,E)}return{frameBuffer:i,setSize:n}}const xe=8;function Wt(e,r){return!!(e>>>r&1)}function je(e,r){return 1<<r*xe-1-e}function $t(e,r,s){return e&=~je(r,s),e}function Yt(e,r,s){return e|=je(r,s),e}function qt(e){if(e<1||e>4)throw new RangeError(`Bytes should be in the range 1 - 4, was: ${e}`)}function Jt(e,r=4){qt(r);let s=0;const a=r*xe;for(let f=0;f<a;f++){const i=Wt(e,f),n=f%r*xe+Math.floor(f/r);s=i?Yt(s,n,r):$t(s,n,r)}return s}const Qt=e=>e[0]<<16|e[1]<<8|e[2];function*Zt(){let e=0;for(;e<16777215;)yield Jt(++e,3);throw new Error(`Ran out of UIDs (n=${e})`)}let eo=Zt();function to(){return eo.next().value}function oo(){const e=Ae({hovered:0,selected:new Set});let r,s,a,f=150;const i=new Uint8Array(4);function n(l){r=l,s=Xt(l),a=Kt(r)}function p(){if(a===void 0)throw new Error("Picking has not been initialised");return a.frameBuffer}function E(l,m){f=m,a?.setSize(l,m)}function c(){e.selected.clear();const l=e.hovered;return l>0&&e.selected.add(l),l}function h(l){const{x:m,y:T}=l;return new Promise(x=>{if(r===void 0||s===void 0)throw new Error("Picking has not been initialised");s.readPixels(m,f-T,1,1,r.RGBA,r.UNSIGNED_BYTE,i).then(()=>{const v=Qt(i);e.hovered=v,x(v)},()=>{e.hovered=0,x(0)})})}return{...De(e),init:n,getPickingFrameBuffer:p,setPickingFrameBufferSize:E,setHoveredAsSelection:c,setMousePosition:h}}const no=(e,r=6)=>(isFinite(e)?e:0).toString(16).padStart(r,"0");function io(e,r){return{modelName:e,modelParts:r}}function ro(e,r,s,a){const f=to(),i=st(...ct(f).toArray()),{x:n,y:p,z:E}=s,c=Mt({mapCoord:r,worldCoord:N(n,p,E),hovered:!1,selected:!1,buffers:void 0}),h=ee(()=>c.selected?.2:c.hovered?.1:0);function l(v){c.buffers=v,ut(v.position,c.worldCoord),ft(v.id,i),v.selection[0]=y(h)}function m(){c.buffers=void 0}function T(v){c.hovered!==v&&(c.hovered=v,c.buffers&&(c.buffers.selection[0]=y(h)))}function x(v){c.selected!==v&&(c.selected=v,c.buffers&&(c.buffers.selection[0]=y(h)))}return{...De(c),uid:f,modelName:e,meta:a,activate:l,deactivate:m,setHovered:T,setSelected:x}}function ao(e,r,s){const a=new Map,f=new Set;function i(n){const p=e.get(n);if(p===void 0){f.add(n);return}const E=kt(p),c=io(n,E);return a.set(n,c),c}return At.of(r.nodes).filter(n=>!!n.object).reduce((n,p)=>{const{object:E,altitude:c,position:h}=p,{type:l,index:m}=E;if(l===void 0)return n;const T=l==="DECORATIVE"?`${l}_${m}`:l,x=`${T.toLowerCase()}.obj`;if(f.has(x))return n;const v=a.get(x)??i(x);if(v===void 0)return n;const[I,A,j]=s.vertexFor(h.x,h.y),q=(j&1)-1,D=ro(x,Dt(h.x,h.y,r.width),{x:I+q,y:A,z:j},{objectId:T,position:h,altitude:c});return n.has(v)?n.get(v).push(D):n.set(v,[D]),n},new Map)}var so=`#version 300 es
precision highp float;in vec3 v_normal;in vec2 v_texcoord;in vec3 v_surfaceToLight;uniform vec3 u_emissive;uniform vec3 u_ambient;uniform vec3 u_ambientLight;uniform vec3 u_diffuse;uniform float u_opacity;uniform sampler2D u_texture;out vec4 outColour;void main(void){vec3 normal=normalize(v_normal);vec3 surfaceToLightDirection=normalize(v_surfaceToLight);float diffuseLight=dot(surfaceToLightDirection,normal)*0.5+0.5;vec4 diffuseColour=texture(u_texture,v_texcoord);vec3 diffuse=u_diffuse*diffuseColour.rgb;float opacity=u_opacity*diffuseColour.a;outColour=vec4(u_emissive+u_ambient*u_ambientLight+diffuse*diffuseLight,opacity);}`,co=`#version 300 es
precision highp sampler2D;in mat4 a_model_position;in vec3 a_vertex;in vec2 a_lscoord;uniform mat4 u_projection;uniform mat4 u_view;uniform sampler2D u_miscDataMap;uniform sampler2D u_miscData2Map;uniform vec3 u_worldLightPosition;out vec3 v_normal;out vec2 v_texcoord;out vec3 v_surfaceToLight;const int NUM_TILES=2;const float HEIGHT_SCALE=0.2;const ivec2[6]EVEN_VERTEX_OFFSETS=ivec2[6](ivec2(0,0),ivec2(0,1),ivec2(1,1),ivec2(0,0),ivec2(1,1),ivec2(1,0));const ivec2[6]ODD_VERTEX_OFFSETS=ivec2[6](ivec2(0,0),ivec2(-1,1),ivec2(0,1),ivec2(0,0),ivec2(0,1),ivec2(1,0));int wrap_int(int value,int min_value,int max_value){return((value-min_value)%(max_value+min_value))+min_value;}ivec2 getMainVertexCoord(vec2 lscoord,ivec2 mapSize,int tile){int tileOffset=tile*mapSize.y/NUM_TILES;int y=int(lscoord.r)+tileOffset;int x=wrap_int(int(lscoord.g)+int((y&1)==0),0,mapSize.x);return ivec2(x,y);}ivec2 getOffsetVertexCoord(vec2 lscoord,ivec2 mapSize,int tile,int vertexId,bool isEvenRow){int mapHeight=mapSize.y/NUM_TILES;int tileOffset=tile*mapHeight;ivec2 vertexOffset=isEvenRow ? EVEN_VERTEX_OFFSETS[vertexId]: ODD_VERTEX_OFFSETS[vertexId];int y=wrap_int(int(lscoord.r)+vertexOffset.y,0,mapHeight)+tileOffset;int x=wrap_int(int(lscoord.g)+vertexOffset.x+int((y&1)==0),0,mapSize.x);return ivec2(x,y);}int lookupInt(sampler2D source,int row,int offset){vec4 pixel=texelFetch(source,ivec2(offset>>2,row),0);return int(pixel[offset&3]*255.0);}vec2 texcoordFromLs(vec2 ls1){int triangle=int(step(3.0,float(gl_VertexID)));int lsId=int(ls1[triangle]*255.0);int tileXoffset=lookupInt(u_miscData2Map,lsId,0);int tileYoffset=lookupInt(u_miscData2Map,lsId,1);int vertexXoffset=lookupInt(u_miscData2Map,lsId,2+(gl_VertexID<<1));int vertexYoffset=lookupInt(u_miscData2Map,lsId,3+(gl_VertexID<<1));return vec2(float(tileXoffset+vertexXoffset)/255.0,float(tileYoffset+vertexYoffset)/255.0);}void main(void){ivec2 mapSize=textureSize(u_miscDataMap,0);ivec2 mainVertexCoord=getMainVertexCoord(a_lscoord,mapSize,1);bool isEvenRow=(mainVertexCoord.y&1)==0;vec4 mainVertexMap1Colour=texelFetch(u_miscDataMap,mainVertexCoord,0);vec2 ls=mainVertexMap1Colour.gb;ivec2 offsetVertexCoordTile0=getOffsetVertexCoord(a_lscoord,mapSize,0,gl_VertexID,isEvenRow);vec4 offsetVertexMap0Colour=texelFetch(u_miscDataMap,offsetVertexCoordTile0,0);vec3 normal=offsetVertexMap0Colour.rgb;ivec2 offsetVertexCoordTile1=getOffsetVertexCoord(a_lscoord,mapSize,1,gl_VertexID,isEvenRow);vec4 offsetVertexMap1Colour=texelFetch(u_miscDataMap,offsetVertexCoordTile1,0);float altitude=(offsetVertexMap1Colour.r*255.0)*HEIGHT_SCALE;vec4 worldPosition=u_view*a_model_position*vec4(a_vertex.x,altitude,a_vertex.z,1.0);gl_Position=u_projection*worldPosition;v_normal=normal;v_texcoord=texcoordFromLs(ls);v_surfaceToLight=u_worldLightPosition-worldPosition.xyz;}`,uo=`#version 300 es
precision highp float;in vec3 v_normal;in vec4 v_colour;in vec2 v_texcoord;in vec3 v_tangent;in vec3 v_surfaceToLight;in vec3 v_surfaceToView;uniform vec3 u_emissive;uniform vec3 u_ambient;uniform vec3 u_ambientLight;uniform vec3 u_diffuse;uniform vec3 u_specular;uniform float u_opacity;uniform float u_shininess;uniform sampler2D u_diffuseMap;uniform sampler2D u_normalMap;uniform sampler2D u_specularMap;out vec4 outColour;void main(void){vec3 normal=normalize(v_normal)*(float(gl_FrontFacing)*2.0-1.0);vec3 tangent=normalize(v_tangent)*(float(gl_FrontFacing)*2.0-1.0);vec3 bitangent=normalize(cross(normal,tangent));mat3 tbn=mat3(tangent,bitangent,normal);normal=texture(u_normalMap,v_texcoord).rgb*2.0-1.0;normal=normalize(tbn*normal);vec3 surfaceToLightDirection=normalize(v_surfaceToLight);vec3 surfaceToViewDirection=normalize(v_surfaceToView);vec3 halfVector=normalize(surfaceToLightDirection+surfaceToViewDirection);float diffuseLight=dot(surfaceToLightDirection,normal)*0.5+0.5;vec4 diffuseMapColour=texture(u_diffuseMap,v_texcoord);vec3 diffuse=u_diffuse*diffuseMapColour.rgb*v_colour.rgb;float specularLight=clamp(dot(normal,halfVector),0.0,1.0);vec4 specularMapColour=texture(u_specularMap,v_texcoord);vec3 specular=u_specular*specularMapColour.rgb;float opacity=u_opacity*diffuseMapColour.a*v_colour.a;outColour=vec4(u_emissive+u_ambient*u_ambientLight+diffuse*diffuseLight+specular*pow(specularLight,u_shininess),opacity);}`,fo=`#version 300 es
layout(location=0)in mat4 a_model_position;layout(location=4)in vec3 a_vertex;in vec3 a_normal;layout(location=7)in vec4 a_colour;in float a_selection;in vec2 a_texcoord;in vec3 a_tangent;uniform mat4 u_projection;uniform mat4 u_view;uniform mat4 u_world;uniform vec3 u_worldLightPosition;uniform vec3 u_cameraPosition;out vec3 v_normal;out vec4 v_colour;out vec2 v_texcoord;out vec3 v_tangent;out vec3 v_surfaceToLight;out vec3 v_surfaceToView;void main(){vec4 worldPosition=u_view*a_model_position*vec4(a_vertex,1.0);gl_Position=u_projection*worldPosition;v_colour=a_colour+vec4(a_selection,a_selection,a_selection,0.0);v_texcoord=a_texcoord;v_surfaceToLight=u_worldLightPosition-worldPosition.xyz;v_surfaceToView=u_cameraPosition-worldPosition.xyz;mat3 normalMat=mat3(u_world);v_normal=normalize(normalMat*a_normal);v_tangent=normalize(normalMat*a_tangent);}`,lo=`#version 300 es
precision highp float;flat in vec4 v_colour;out vec4 outColour;void main(){outColour=v_colour;}`,mo=`#version 300 es
layout(location=0)in mat4 a_model_position;layout(location=4)in vec3 a_vertex;layout(location=7)in vec4 a_colour;uniform mat4 u_projection;uniform mat4 u_view;flat out vec4 v_colour;void main(){gl_Position=u_projection*u_view*a_model_position*vec4(a_vertex,1.0);v_colour=a_colour;}`;const _o=3e5,Ie=1.25,vo=1,po=oe({__name:"MapScene",props:{mapDefinition:{},heightAndTypeMap:{},tileMap:{},models:{},textureSet:{}},setup(e,{expose:r}){function s(t,o){switch(o){case 0:return t.hqCoordinates;case 1:return t.portalCoordinates;case 2:return{x:t.width/2,y:t.height/2}}}const a=dt(),f=N(-128,64,0),i=N(.1,.1,.1),n=e,p=Ct("glPanel"),{loadingStore:E}=Be(),c=Ae({projectionMode:ce.PERSPECTIVE}),h=[so,uo,lo],l=[co,fo,mo],m=lt(mt.LookAt),T=oo();let x,v;const I=[],A=[];let j;const q=Fe(n.mapDefinition),D=Ht(ao(n.models,n.mapDefinition,q));let G=0;const he=vo*12;function J(t,o){const d=s(t,o)??s(t,2),[_,u,b]=q.vertexFor(d.x,d.y),F=(d.y&1)-1;m.lookAt(_+F,u,b),m.moveTo(_+F,he,b+he),G=0}function Ee(t){c.projectionMode=t,X.resize()}function Ge(t,o,{projection:d,view:_},{indexes:u,vertexes:b},F,w){const{ambient:R,emissive:M,opacity:U}=zt,k=N(1,1,1);o.setClearColour(pt),o.setEnableBits(t.CULL_FACE,t.DEPTH_TEST,t.SCISSOR_TEST),o.bindUniform("u_projection",C=>t.uniformMatrix4fv(C,!1,d)),o.bindUniform("u_view",C=>t.uniformMatrix4fv(C,!1,_)),o.bindUniform("u_ambientLight",C=>t.uniform3fv(C,i)),o.bindUniform("u_worldLightPosition",C=>t.uniform3fv(C,f)),o.bindUniform("u_emissive",C=>t.uniform3fv(C,M)),o.bindUniform("u_ambient",C=>t.uniform3fv(C,R)),o.bindUniform("u_diffuse",C=>t.uniform3fv(C,k)),o.bindUniform("u_opacity",C=>t.uniform1f(C,U));const K=Pe(t),W=ye(Ce(t),Me(t),we(t),Et(t,n.tileMap),xt(t,ht(16,24,Lt))),H=Le(t,o,t.TRIANGLES,Se(t,o,K,W,t.TRIANGLES,u.length,w.usedCount,_e("a_model_position",w),O("a_vertex",b,3,t.FLOAT),O("a_lscoord",F,2,t.FLOAT,1),fe(u)));return St(Ye,H.setTexture,{immediate:!0}),H}function He(t,o,{projection:d,view:_}){return o.bindUniform("u_projection",u=>t.uniformMatrix4fv(u,!1,d)),o.bindUniform("u_view",u=>t.uniformMatrix4fv(u,!1,_)),o.bindUniform("u_world",u=>t.uniformMatrix4fv(u,!1,a)),o.bindUniform("u_cameraPosition",u=>t.uniform3fv(u,m.position)),o.bindUniform("u_ambientLight",u=>t.uniform3fv(u,i)),o.bindUniform("u_worldLightPosition",u=>t.uniform3fv(u,f)),Array.from(D.buffers.entries(),([u,b])=>{const{modelParts:F}=u,{positions:w,selections:R}=b,M=F.map(U=>{const{buffer:k,ambient:K,diffuse:W,emissive:H,opacity:C,shininess:ne,specular:ie,diffuseMap:re,normalMap:ae,specularMap:se}=U,{vertexes:et,normals:tt,colours:ot,texcoords:nt,tangents:it,indexes:be}=k,g=Pe(t);g.bindUniform("u_emissive",V=>t.uniform3fv(V,H)),g.bindUniform("u_ambient",V=>t.uniform3fv(V,K)),g.bindUniform("u_diffuse",V=>t.uniform3fv(V,W)),g.bindUniform("u_specular",V=>t.uniform3fv(V,ie)),g.bindUniform("u_opacity",V=>t.uniform1f(V,C)),g.bindUniform("u_shininess",V=>t.uniform1f(V,ne+25));const rt=ye(Ce(t,re),Me(t,ae),we(t,se));return Se(t,o,g,rt,t.TRIANGLES,be.length,w.usedCount,_e("a_model_position",w),O("a_vertex",et,3,t.FLOAT),O("a_normal",tt,3,t.FLOAT),O("a_colour",ot,4,t.FLOAT),O("a_selection",R,1,t.FLOAT,1),O("a_texcoord",nt,2,t.FLOAT),O("a_tangent",it,3,t.FLOAT),fe(be))});return Le(t,o,t.TRIANGLES,...M)})}function Xe(t,o,{projection:d,view:_}){return o.setClearColour(Tt),o.setEnableBits(t.CULL_FACE,t.DEPTH_TEST),o.bindUniform("u_projection",u=>t.uniformMatrix4fv(u,!1,d)),o.bindUniform("u_view",u=>t.uniformMatrix4fv(u,!1,_)),Array.from(D.buffers.entries(),([u,b])=>{const{modelParts:F}=u,{ids:w,positions:R}=b,{buffer:M}=F[0],{indexes:U,vertexes:k}=M;return bt(t,o,t.TRIANGLES,U.length,R.usedCount,_e("a_model_position",R),O("a_vertex",k,3,t.FLOAT),O("a_colour",w,4,t.FLOAT,1),fe(U))})}function Ke(t,o){o.bind("ArrowDown",()=>m.pedestal(-.5)),o.bind("ArrowUp",()=>m.pedestal(.5)),o.bind("ArrowLeft",()=>G+=100),o.bind("ArrowRight",()=>G-=100),o.bind("Home",()=>J(n.mapDefinition,0)),o.bind("End",()=>J(n.mapDefinition,1)),o.bind("Space",()=>G=0),o.bind("KeyC",()=>J(n.mapDefinition,2)),o.bind("KeyO",()=>Ee(ce.ORTHOGRAPHIC)),o.bind("KeyP",()=>Ee(ce.PERSPECTIVE)),o.bind("KeyL",()=>{x.setDrawMode(t.LINE_LOOP),I.forEach(d=>d.setDrawMode(t.LINE_LOOP)),A.forEach(d=>d.setDrawMode(t.LINE_LOOP))}),o.bind("KeyK",()=>{x.setDrawMode(t.TRIANGLES),I.forEach(d=>d.setDrawMode(t.TRIANGLES)),A.forEach(d=>d.setDrawMode(t.TRIANGLES))})}function We(t,o){let d=0;o.bind(de.Left,()=>{if(y(T.hovered)!==d){if(y(T.selected).forEach(_=>D.findInstanceByUid(_).setSelected(!1)),d=T.setHoveredAsSelection(),d>0){const _=D.findInstanceByUid(d),{meta:u,setSelected:b}=_;b(!0),Re({uid:no(d),...u})}else Re(void 0);ue(D.buffers.values(),I).forEach((_,u)=>{const{selections:b}=_;u.updateBuffer("a_selection",b,b.usedLength)})}}),o.bind(de.Right,_=>{m.track(-_.movement.dx/10,-_.movement.dy/10)}),o.bind(de.Left|yt.Ctrl,_=>{m.tilt(_.movement.dy/10),m.pan(_.movement.dx/10)}),o.bindScroll(_=>m.dolly(_*.25)),o.bindMove(_=>j=_)}function $e(t,o){o.bind(d=>{function _(b,F){const{movement:w}=F,{dx:R,dy:M}=w;(Math.abs(R)>0||Math.abs(M)>0)&&b.track(-R/10,-M/10)}function u(b,F,w){const{movement:R,currentPosition:M}=F,{movement:U,currentPosition:k}=w,{dx:K,dy:W}=R,{x:H,y:C}=M,{dx:ne,dy:ie}=U,{x:re,y:ae}=k,se=Math.sign(H-re)*(K+ne)+Math.sign(C-ae)*(W+ie);b.dolly(se/10)}switch(d.length){case 1:_(m,d[0]);break;case 2:u(m,d[0],d[1]);break}})}const Ye=ee(()=>n.textureSet?.image),qe=(t,[o,d,_],{keyboard:u,mouse:b,touch:F},w)=>{const R=Bt(),M=Fe(n.mapDefinition);v=Ut(M),v.select(w.view,Ie),x=Ge(t,o,w,R,v.lsCoords,v.positions),D.select(v),I.splice(0,1/0,...He(t,d,w)),T.init(t),A.splice(0,1/0,...Xe(t,_,w)),Ke(t,u),We(t,b),$e(t,F),J(n.mapDefinition,0),E.setLoading(!1)},Je=(t,o)=>{const{drawingBufferWidth:d,drawingBufferHeight:_}=t;T.setPickingFrameBufferSize(d,_),v.select(o,Ie),D.select(v);const{lsCoords:u,positions:b}=v;x.setInstanceCount(b.usedCount),x.updateBuffer("a_model_position",b,b.usedLength),x.updateBuffer("a_lscoord",u,u.usedLength),ue(D.buffers.values(),I,A).forEach((F,w,R)=>{const{positions:M,ids:U,selections:k}=F;w.setInstanceCount(M.usedCount),w.updateBuffer("a_model_position",M,M.usedLength),w.updateBuffer("a_selection",k,k.usedLength),R.setInstanceCount(M.usedCount),R.updateBuffer("a_model_position",M,M.usedLength),R.updateBuffer("a_colour",U,U.usedLength)})},Qe=()=>{x.activate(),x.draw(),I.filter(o=>y(o.instanceCount)>0).forEach(o=>{o.activate(!1),o.draw()});let t=0;A.filter(o=>y(o.instanceCount)>0).forEach(o=>{o.activate(t++===0,T.getPickingFrameBuffer()),o.draw()}),t>0&&j&&T.setMousePosition(j).then(Ze)};let Te=0;function Ze(t){if(t===Te)return;Te=t;const o=t>0?"pointer":void 0;y(p)?.setMouseCursor(o),D.hover(t),ue(D.buffers.values(),I).forEach((d,_)=>{const{selections:u}=d;_.updateBuffer("a_selection",u,u.usedLength)})}const X=_t(m,qe,Je,Qe,t=>{G!==0&&m.arc(G*t/_o)},()=>{A.forEach(t=>t.delete()),I.forEach(t=>t.delete()),x.delete()});return r({fps:X.fps}),(t,o)=>(P(),B(vt,{ref_key:"glPanel",ref:p,"fragment-sources":h,"vertex-sources":l,"projection-mode":c.projectionMode,onInit:y(X).init,onResize:y(X).resize,onExit:y(X).exit},null,8,["projection-mode","onInit","onResize","onExit"]))}}),xo={key:1},ho=oe({__name:"KeyControl",props:{keyControls:{}},setup(e){return(r,s)=>(P(),B(ge,{location:"bottom center"},{activator:S(({props:a})=>[L(ve,{location:"top"},{activator:S(({props:f})=>[L(Oe,te(te(a,f),{icon:"mdi-keyboard-variant",tile:""}),null,16)]),default:S(()=>[s[0]||(s[0]=Z(" Keyboard control ",-1))]),_:2},1024)]),default:S(()=>[L(Ue,{density:"compact","bg-color":"secondary"},{default:S(()=>[(P(!0),Y(ke,null,Ve(e.keyControls,a=>(P(),B(ze,{key:a.key,title:a.action},{prepend:S(()=>[a.key.startsWith("mdi-")?(P(),B(z,{key:0,icon:a.key},null,8,["icon"])):(P(),Y("kbd",xo,pe(a.key),1))]),_:2},1032,["title"]))),128))]),_:1})]),_:1}))}}),Eo=Ne(ho,[["__scopeId","data-v-8b7cd330"]]),To={key:0},bo={key:1},yo=oe({__name:"MouseControl",props:{mouseControls:{}},setup(e){return(r,s)=>(P(),B(ge,{location:"bottom center"},{activator:S(({props:a})=>[L(ve,{location:"top"},{activator:S(({props:f})=>[L(Oe,te(te(a,f),{icon:"mdi-mouse-variant",tile:""}),null,16)]),default:S(()=>[s[0]||(s[0]=Z(" Mouse control ",-1))]),_:2},1024)]),default:S(()=>[L(Ue,{density:"compact","bg-color":"secondary"},{default:S(()=>[(P(!0),Y(ke,null,Ve(e.mouseControls,a=>(P(),B(ze,{key:a.action,title:a.action},{prepend:S(()=>[L(ve,{activator:"parent",location:"left"},{default:S(()=>[Z(pe(a.tooltip),1)]),_:2},1024),a.modifier?(P(),Y("kbd",To,[Z(pe(a.modifier)+" ",1),L(z,{icon:"mdi-plus",size:"x-small"})])):(P(),Y("kbd",bo)),a.leftButton?(P(),B(z,{key:2,icon:"mdi-rectangle",size:"large"})):(P(),B(z,{key:3,icon:"mdi-rectangle-outline",size:"large"})),a.wheel?(P(),B(z,{key:4,icon:"mdi-rectangle",size:"large"})):(P(),B(z,{key:5,icon:"mdi-rectangle-outline",size:"large"})),a.rightButton?(P(),B(z,{key:6,icon:"mdi-rectangle",size:"large"})):(P(),B(z,{key:7,icon:"mdi-rectangle-outline",size:"large"}))]),_:2},1032,["title"]))),128))]),_:1})]),_:1}))}}),wo=Ne(yo,[["__scopeId","data-v-06a81ba9"]]),Do=oe({__name:"MapPanel",setup(e){const r=Pt(void 0),{mapStore:s,modelsStore:a,texturesStore:f}=Be(),{heightAndTypeMap:i,map:n,tileMap:p}=s,{modelCache:E}=a,{currentTexture:c,selectTextureById:h,textureList:l}=f,m=ee(()=>{const{worldType:I}=y(n);return y(l).filter(A=>A.worldType===I)}),T=ee(()=>y(c).id),x=[{key:"mdi-arrow-up-bold",action:"move camera up"},{key:"mdi-arrow-down-bold",action:"move camera down"},{key:"mdi-arrow-left-bold",action:"increase camera movement to the left"},{key:"mdi-arrow-right-bold",action:"increase camera movement to the right"},{key:"space",action:"stop camera moving"},{key:"Home",action:"return camera to start position"},{key:"End",action:"send camera to the exit portal position"},{key:"C",action:"send camera to the centre of the map"},{key:"O",action:"orthographic rendering"},{key:"P",action:"perspective rendering"},{key:"K",action:"filled drawing"},{key:"L",action:"line drawing"}],v=[{modifier:"<ctrl>",leftButton:!0,tooltip:"Ctrl + Left button",action:"turn the camera"},{rightButton:!0,tooltip:"Right button",action:"move the camera"},{wheel:!0,tooltip:"Wheel",action:"zoom the camera"}];return(I,A)=>(P(),B(Rt,{fluid:"",class:"d-flex flex-column pa-0"},{default:S(()=>[L(It,{class:"flex-grow-0 flex-shrink-0",color:"secondary"},{default:S(()=>[L(Q,{class:"ml-3","max-width":"176"},{default:S(()=>[L(Vt,{"item-value":"id","item-title":"name",label:"Landscape","hide-details":"",items:m.value,"model-value":T.value,"onUpdate:modelValue":y(h)},null,8,["items","model-value","onUpdate:modelValue"])]),_:1}),L(Ft),L(Q,{class:"mr-3","max-width":"56"},{default:S(()=>[L(Eo,{"key-controls":x})]),_:1}),L(Q,{class:"mr-3","max-width":"56"},{default:S(()=>[L(wo,{"mouse-controls":v})]),_:1}),L(Q,{class:"mr-3","max-width":"56"},{default:S(()=>[L(wt,{class:"noMouse","hide-details":"",label:"fps","model-value":r.value?.fps,readonly:""},null,8,["model-value"])]),_:1})]),_:1}),L(po,{ref_key:"mapScene",ref:r,class:"flex-fill","map-definition":y(n),"height-and-type-map":y(i),"tile-map":y(p),models:y(E).contents,"texture-set":y(c)},null,8,["map-definition","height-and-type-map","tile-map","models","texture-set"])]),_:1}))}});export{Do as default};
