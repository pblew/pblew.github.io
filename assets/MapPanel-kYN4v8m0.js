import{f as N,y as ye,z as W,q as ct,A as ut,D as ft,E as dt,F as lt,P as ce,c as mt,C as _t,u as vt,G as pt,H as ue,d as xt,j as we,w as ht,h as Et,x as Tt,k as Me,l as Ce,m as Le,p as Se,o as Pe,g as fe,e as O,i as Re,I as bt,J as yt,B as de,M as wt,V as Mt}from"./VTextField-D1PpXfh6.js";import{u as b,aq as De,ar as Be,as as Ct,x as ee,d as oe,at as Lt,s as Ue,c as D,o as P,z as St,v as Pt,y as Fe,w as L,a as C,V as Ve,g as Y,h as ke,F as Oe,i as ve,e as Z,j as ze,m as te,f as Ne,au as z,t as pe,_ as ge,r as Rt,l as Ft,p as Q,n as It,q as At}from"./index-DClP-mhw.js";import{F as le,I as me,u as _e}from"./Positions-CnxZsop4.js";import{S as je,b as Dt,u as Ie,g as Bt,a as Ut,V as Vt}from"./VSelect-D6Urv0CY.js";import{f as kt}from"./ObjModel-B2rey1mr.js";import{V as Ge}from"./VMenu-CAot_VAK.js";import"./VSlideGroup-DJmsq3yQ.js";function Ot(e,r,s,a,c,i,n){return{ambient:e,diffuse:r,emissive:s,opacity:a,opticalDensity:c,shininess:i,specular:n}}const zt=Ot(N(1,1,1),N(.8,.8,.8),N(0,0,0),1,1,225,N(.5,.5,.5));function*Nt(e,r){for(const[s,a]of e.entries())for(const c of a)yield r(s,c)}function*gt(e,r){for(const[s,a]of e.entries())yield r(s,a)}const jt=(e,r)=>[r.uid,r],Gt=(e,r)=>{const s=r.length,a=new le(s,me.MAT4),c=new le(s,me.VEC4),i=new le(s,me.FLOAT);return[e,{positions:a,ids:c,selections:i}]};function Ht(e,r,s){const{positions:a,ids:c,selections:i}=s;a.clear(),c.clear(),i.clear();let n=0;r.forEach(d=>{const{activate:x,deactivate:u,mapCoord:h}=d;e.isVisible(b(h).index)?(x({position:a.itemAt(n),id:c.itemAt(n),selection:i.itemAt(n)}),n++):u()})}function Xt(e){const r=new Map(Nt(e,jt)),s=new Map(gt(e,Gt));function a(n){return ye(r.get(n),`No model instance found for uid=${n}`)}function c(n){je.of(e.entries()).filter(([d,x])=>s.has(d)).forEach(([d,x])=>Ht(n,x,ye(s.get(d),`Buffer not found for model=${d}`)))}function i(n){r.forEach(d=>{d.setHovered(d.uid===n)})}return{models:e,buffers:s,findInstanceByUid:a,select:c,hover:i}}function Kt(e){const r=W(e,e.getParameter(e.MAX_CLIENT_WAIT_TIMEOUT_WEBGL),"Failed to retrieve max client wait timeout");async function s(i){const n=W(i,i.fenceSync(i.SYNC_GPU_COMMANDS_COMPLETE,0),"Failed to get sync object");return i.flush(),new Promise((d,x)=>{function u(){switch(i.clientWaitSync(n,i.SYNC_FLUSH_COMMANDS_BIT,r)){case i.WAIT_FAILED:if(h--)requestAnimationFrame(u);else{const _=i.getError();i.deleteSync(n),x(_)}break;case i.TIMEOUT_EXPIRED:requestAnimationFrame(u);break;default:i.deleteSync(n),d(i.NO_ERROR)}}let h=1;requestAnimationFrame(u)})}async function a(i,n,d,x,u,h,_){return await s(i),i.bindBuffer(n,d),i.getBufferSubData(n,x,u,h,_),i.bindBuffer(n,null),u}async function c(i,n,d,x,u,h,_,v,S=0){const E=i.createBuffer();i.bindBuffer(i.PIXEL_PACK_BUFFER,E),i.bufferData(i.PIXEL_PACK_BUFFER,v.byteLength,i.STREAM_READ),i.readPixels(n,d,x,u,h,_,S),i.bindBuffer(i.PIXEL_PACK_BUFFER,null),await a(i,i.PIXEL_PACK_BUFFER,E,0,v),i.deleteBuffer(E)}return{readPixels:(i,n,d,x,u,h,_,v)=>c(e,i,n,d,x,u,h,_,v)}}function $t(e,r=300,s=150){const a=W(e,e.createTexture(),"Failed to create texture");e.bindTexture(e.TEXTURE_2D,a),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const c=W(e,e.createRenderbuffer(),"Failed to create render buffer");e.bindRenderbuffer(e.RENDERBUFFER,c);const i=W(e,e.createFramebuffer(),"Failed to create frame buffer");e.bindFramebuffer(e.FRAMEBUFFER,i),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,a,0),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,c),n(r,s);function n(d,x){e.bindTexture(e.TEXTURE_2D,a),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,d,x,0,e.RGBA,e.UNSIGNED_BYTE,null),e.bindRenderbuffer(e.RENDERBUFFER,c),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,d,x)}return{frameBuffer:i,setSize:n}}const xe=8;function Wt(e,r){return!!(e>>>r&1)}function He(e,r){return 1<<r*xe-1-e}function Yt(e,r,s){return e&=~He(r,s),e}function qt(e,r,s){return e|=He(r,s),e}function Jt(e){if(e<1||e>4)throw new RangeError(`Bytes should be in the range 1 - 4, was: ${e}`)}function Qt(e,r=4){Jt(r);let s=0;const a=r*xe;for(let c=0;c<a;c++){const i=Wt(e,c),n=c%r*xe+Math.floor(c/r);s=i?qt(s,n,r):Yt(s,n,r)}return s}const Zt=e=>e[0]<<16|e[1]<<8|e[2];function*eo(){let e=0;for(;e<16777215;)yield Qt(++e,3);throw new Error(`Ran out of UIDs (n=${e})`)}let to=eo();function oo(){return to.next().value}function no(){const e=De({hovered:0,selected:new Set});let r,s,a,c=150;const i=new Uint8Array(4);function n(_){r=_,s=Kt(_),a=$t(r)}function d(){if(a===void 0)throw new Error("Picking has not been initialised");return a.frameBuffer}function x(_,v){c=v,a?.setSize(_,v)}function u(){e.selected.clear();const _=e.hovered;return _>0&&e.selected.add(_),_}function h(_){const{x:v,y:S}=_;return new Promise(E=>{if(r===void 0||s===void 0)throw new Error("Picking has not been initialised");s.readPixels(v,c-S,1,1,r.RGBA,r.UNSIGNED_BYTE,i).then(()=>{const p=Zt(i);e.hovered=p,E(p)},()=>{e.hovered=0,E(0)})})}return{...Be(e),init:n,getPickingFrameBuffer:d,setPickingFrameBufferSize:x,setHoveredAsSelection:u,setMousePosition:h}}const io=(e,r=6)=>(isFinite(e)?e:0).toString(16).padStart(r,"0");function ro(e,r){return{modelName:e,modelParts:r}}function ao(e,r,s,a){const c=oo(),i=ct(...ut(c).toArray()),{x:n,y:d,z:x}=s,u=Ct({mapCoord:r,worldCoord:N(n,d,x),hovered:!1,selected:!1,buffers:void 0}),h=ee(()=>u.selected?.2:u.hovered?.1:0);function _(p){u.buffers=p,ft(p.position,u.worldCoord),dt(p.id,i),p.selection[0]=b(h)}function v(){u.buffers=void 0}function S(p){u.hovered!==p&&(u.hovered=p,u.buffers&&(u.buffers.selection[0]=b(h)))}function E(p){u.selected!==p&&(u.selected=p,u.buffers&&(u.buffers.selection[0]=b(h)))}return{...Be(u),uid:c,modelName:e,meta:a,activate:_,deactivate:v,setHovered:S,setSelected:E}}function so(e,r,s){const a=new Map,c=new Set;function i(n){const d=e.get(n);if(d===void 0){c.add(n);return}const x=kt(d),u=ro(n,x);return a.set(n,u),u}return je.of(r.nodes).filter(n=>!!n.object).reduce((n,d)=>{const{object:x,altitude:u,position:h}=d,{type:_,index:v}=x;if(_===void 0)return n;const S=_==="DECORATIVE"?`${_}_${v}`:_,E=`${S.toLowerCase()}.obj`;if(c.has(E))return n;const p=a.get(E)??i(E);if(p===void 0)return n;const[I,B,j]=s.vertexFor(h.x,h.y),q=(j&1)-1,A=ao(E,Dt(h.x,h.y,r.width),{x:I+q,y:B,z:j},{objectId:S,position:h,altitude:u});return n.has(p)?n.get(p).push(A):n.set(p,[A]),n},new Map)}var co=`#version 300 es
precision highp float;in vec3 v_normal;in vec2 v_texcoord;in vec3 v_surfaceToLight;uniform vec3 u_emissive;uniform vec3 u_ambient;uniform vec3 u_ambientLight;uniform vec3 u_diffuse;uniform float u_opacity;uniform sampler2D u_texture;out vec4 outColour;void main(void){vec3 normal=normalize(v_normal);vec3 surfaceToLightDirection=normalize(v_surfaceToLight);float diffuseLight=dot(surfaceToLightDirection,normal)*0.5+0.5;vec4 diffuseColour=texture(u_texture,v_texcoord);vec3 diffuse=u_diffuse*diffuseColour.rgb;float opacity=u_opacity*diffuseColour.a;outColour=vec4(u_emissive+u_ambient*u_ambientLight+diffuse*diffuseLight,opacity);}`,uo=`#version 300 es
precision highp sampler2D;in mat4 a_model_position;in vec3 a_vertex;in vec2 a_lscoord;uniform mat4 u_projection;uniform mat4 u_view;uniform sampler2D u_miscDataMap;uniform sampler2D u_miscData2Map;uniform vec3 u_worldLightPosition;out vec3 v_normal;out vec2 v_texcoord;out vec3 v_surfaceToLight;const int NUM_TILES=2;const float HEIGHT_SCALE=0.2;const ivec2[6]EVEN_VERTEX_OFFSETS=ivec2[6](ivec2(0,0),ivec2(0,1),ivec2(1,1),ivec2(0,0),ivec2(1,1),ivec2(1,0));const ivec2[6]ODD_VERTEX_OFFSETS=ivec2[6](ivec2(0,0),ivec2(-1,1),ivec2(0,1),ivec2(0,0),ivec2(0,1),ivec2(1,0));int wrap_int(int value,int min_value,int max_value){return((value-min_value)%(max_value+min_value))+min_value;}ivec2 getMainVertexCoord(vec2 lscoord,ivec2 mapSize,int tile){int tileOffset=tile*mapSize.y/NUM_TILES;int y=int(lscoord.r)+tileOffset;int x=wrap_int(int(lscoord.g)+int((y&1)==0),0,mapSize.x);return ivec2(x,y);}ivec2 getOffsetVertexCoord(vec2 lscoord,ivec2 mapSize,int tile,int vertexId,bool isEvenRow){int mapHeight=mapSize.y/NUM_TILES;int tileOffset=tile*mapHeight;ivec2 vertexOffset=isEvenRow ? EVEN_VERTEX_OFFSETS[vertexId]: ODD_VERTEX_OFFSETS[vertexId];int y=wrap_int(int(lscoord.r)+vertexOffset.y,0,mapHeight)+tileOffset;int x=wrap_int(int(lscoord.g)+vertexOffset.x+int((y&1)==0),0,mapSize.x);return ivec2(x,y);}int lookupInt(sampler2D source,int row,int offset){vec4 pixel=texelFetch(source,ivec2(offset>>2,row),0);return int(pixel[offset&3]*255.0);}vec2 texcoordFromLs(vec2 ls1){int triangle=int(step(3.0,float(gl_VertexID)));int lsId=int(ls1[triangle]*255.0);int tileXoffset=lookupInt(u_miscData2Map,lsId,0);int tileYoffset=lookupInt(u_miscData2Map,lsId,1);int vertexXoffset=lookupInt(u_miscData2Map,lsId,2+(gl_VertexID<<1));int vertexYoffset=lookupInt(u_miscData2Map,lsId,3+(gl_VertexID<<1));return vec2(float(tileXoffset+vertexXoffset)/255.0,float(tileYoffset+vertexYoffset)/255.0);}void main(void){ivec2 mapSize=textureSize(u_miscDataMap,0);ivec2 mainVertexCoord=getMainVertexCoord(a_lscoord,mapSize,1);bool isEvenRow=(mainVertexCoord.y&1)==0;vec4 mainVertexMap1Colour=texelFetch(u_miscDataMap,mainVertexCoord,0);vec2 ls=mainVertexMap1Colour.gb;ivec2 offsetVertexCoordTile0=getOffsetVertexCoord(a_lscoord,mapSize,0,gl_VertexID,isEvenRow);vec4 offsetVertexMap0Colour=texelFetch(u_miscDataMap,offsetVertexCoordTile0,0);vec3 normal=offsetVertexMap0Colour.rgb;ivec2 offsetVertexCoordTile1=getOffsetVertexCoord(a_lscoord,mapSize,1,gl_VertexID,isEvenRow);vec4 offsetVertexMap1Colour=texelFetch(u_miscDataMap,offsetVertexCoordTile1,0);float altitude=(offsetVertexMap1Colour.r*255.0)*HEIGHT_SCALE;vec4 worldPosition=u_view*a_model_position*vec4(a_vertex.x,altitude,a_vertex.z,1.0);gl_Position=u_projection*worldPosition;v_normal=normal;v_texcoord=texcoordFromLs(ls);v_surfaceToLight=u_worldLightPosition-worldPosition.xyz;}`,fo=`#version 300 es
precision highp float;in vec3 v_normal;in vec4 v_colour;in vec2 v_texcoord;in vec3 v_tangent;in vec3 v_surfaceToLight;in vec3 v_surfaceToView;uniform vec3 u_emissive;uniform vec3 u_ambient;uniform vec3 u_ambientLight;uniform vec3 u_diffuse;uniform vec3 u_specular;uniform float u_opacity;uniform float u_shininess;uniform sampler2D u_diffuseMap;uniform sampler2D u_normalMap;uniform sampler2D u_specularMap;out vec4 outColour;void main(void){vec3 normal=normalize(v_normal)*(float(gl_FrontFacing)*2.0-1.0);vec3 tangent=normalize(v_tangent)*(float(gl_FrontFacing)*2.0-1.0);vec3 bitangent=normalize(cross(normal,tangent));mat3 tbn=mat3(tangent,bitangent,normal);normal=texture(u_normalMap,v_texcoord).rgb*2.0-1.0;normal=normalize(tbn*normal);vec3 surfaceToLightDirection=normalize(v_surfaceToLight);vec3 surfaceToViewDirection=normalize(v_surfaceToView);vec3 halfVector=normalize(surfaceToLightDirection+surfaceToViewDirection);float diffuseLight=dot(surfaceToLightDirection,normal)*0.5+0.5;vec4 diffuseMapColour=texture(u_diffuseMap,v_texcoord);vec3 diffuse=u_diffuse*diffuseMapColour.rgb*v_colour.rgb;float specularLight=clamp(dot(normal,halfVector),0.0,1.0);vec4 specularMapColour=texture(u_specularMap,v_texcoord);vec3 specular=u_specular*specularMapColour.rgb;float opacity=u_opacity*diffuseMapColour.a*v_colour.a;outColour=vec4(u_emissive+u_ambient*u_ambientLight+diffuse*diffuseLight+specular*pow(specularLight,u_shininess),opacity);}`,lo=`#version 300 es
layout(location=0)in mat4 a_model_position;layout(location=4)in vec3 a_vertex;in vec3 a_normal;layout(location=7)in vec4 a_colour;in float a_selection;in vec2 a_texcoord;in vec3 a_tangent;uniform mat4 u_projection;uniform mat4 u_view;uniform mat4 u_world;uniform vec3 u_worldLightPosition;uniform vec3 u_cameraPosition;out vec3 v_normal;out vec4 v_colour;out vec2 v_texcoord;out vec3 v_tangent;out vec3 v_surfaceToLight;out vec3 v_surfaceToView;void main(){vec4 worldPosition=u_view*a_model_position*vec4(a_vertex,1.0);gl_Position=u_projection*worldPosition;v_colour=a_colour+vec4(a_selection,a_selection,a_selection,0.0);v_texcoord=a_texcoord;v_surfaceToLight=u_worldLightPosition-worldPosition.xyz;v_surfaceToView=u_cameraPosition-worldPosition.xyz;mat3 normalMat=mat3(u_world);v_normal=normalize(normalMat*a_normal);v_tangent=normalize(normalMat*a_tangent);}`,mo=`#version 300 es
precision highp float;flat in vec4 v_colour;out vec4 outColour;void main(){outColour=v_colour;}`,_o=`#version 300 es
layout(location=0)in mat4 a_model_position;layout(location=4)in vec3 a_vertex;layout(location=7)in vec4 a_colour;uniform mat4 u_projection;uniform mat4 u_view;flat out vec4 v_colour;void main(){gl_Position=u_projection*u_view*a_model_position*vec4(a_vertex,1.0);v_colour=a_colour;}`;const vo=3e5,Ae=1.25,po=1,xo=oe({__name:"MapScene",props:{mapDefinition:{},heightAndTypeMap:{},tileMap:{},models:{},textureSet:{}},setup(e,{expose:r}){function s(t,o){switch(o){case 0:return t.hqCoordinates;case 1:return t.portalCoordinates;case 2:return{x:t.width/2,y:t.height/2}}}const a=lt(),c=N(-128,64,0),i=N(.1,.1,.1),n=e,d=Lt("glPanel"),{loadingStore:x}=Ue(),u=De({projectionMode:ce.PERSPECTIVE}),h=[co,fo,mo],_=[uo,lo,_o],v=mt(_t.LookAt),S=no();let E,p;const I=[],B=[];let j;const q=Ie(n.mapDefinition),A=Xt(so(n.models,n.mapDefinition,q));let G=0;const he=po*12;function J(t,o){const l=s(t,o)??s(t,2),[m,f,T]=q.vertexFor(l.x,l.y),F=(l.y&1)-1;v.lookAt(m+F,f,T),v.moveTo(m+F,he,T+he),G=0}function Ee(t){u.projectionMode=t,X.resize()}function Xe(t,o,{projection:l,view:m},{indexes:f,vertexes:T},F,y){const{ambient:R,emissive:w,opacity:U}=zt,k=N(1,1,1);o.setClearColour(xt),o.setEnableBits(t.CULL_FACE,t.DEPTH_TEST,t.SCISSOR_TEST),o.bindUniform("u_projection",M=>t.uniformMatrix4fv(M,!1,l)),o.bindUniform("u_view",M=>t.uniformMatrix4fv(M,!1,m)),o.bindUniform("u_ambientLight",M=>t.uniform3fv(M,i)),o.bindUniform("u_worldLightPosition",M=>t.uniform3fv(M,c)),o.bindUniform("u_emissive",M=>t.uniform3fv(M,w)),o.bindUniform("u_ambient",M=>t.uniform3fv(M,R)),o.bindUniform("u_diffuse",M=>t.uniform3fv(M,k)),o.bindUniform("u_opacity",M=>t.uniform1f(M,U));const K=Re(t),$=we(Le(t),Ce(t),Me(t),Tt(t,n.tileMap),ht(t,Et(16,24,St))),H=Se(t,o,t.TRIANGLES,Pe(t,o,K,$,t.TRIANGLES,f.length,y.usedCount,_e("a_model_position",y),O("a_vertex",T,3,t.FLOAT),O("a_lscoord",F,2,t.FLOAT,1),fe(f)));return Pt(Je,H.setTexture,{immediate:!0}),H}function Ke(t,o,{projection:l,view:m}){return o.bindUniform("u_projection",f=>t.uniformMatrix4fv(f,!1,l)),o.bindUniform("u_view",f=>t.uniformMatrix4fv(f,!1,m)),o.bindUniform("u_world",f=>t.uniformMatrix4fv(f,!1,a)),o.bindUniform("u_cameraPosition",f=>t.uniform3fv(f,v.position)),o.bindUniform("u_ambientLight",f=>t.uniform3fv(f,i)),o.bindUniform("u_worldLightPosition",f=>t.uniform3fv(f,c)),Array.from(A.buffers.entries(),([f,T])=>{const{modelParts:F}=f,{positions:y,selections:R}=T,w=F.map(U=>{const{buffer:k,ambient:K,diffuse:$,emissive:H,opacity:M,shininess:ne,specular:ie,diffuseMap:re,normalMap:ae,specularMap:se}=U,{vertexes:ot,normals:nt,colours:it,texcoords:rt,tangents:at,indexes:be}=k,g=Re(t);g.bindUniform("u_emissive",V=>t.uniform3fv(V,H)),g.bindUniform("u_ambient",V=>t.uniform3fv(V,K)),g.bindUniform("u_diffuse",V=>t.uniform3fv(V,$)),g.bindUniform("u_specular",V=>t.uniform3fv(V,ie)),g.bindUniform("u_opacity",V=>t.uniform1f(V,M)),g.bindUniform("u_shininess",V=>t.uniform1f(V,ne+25));const st=we(Le(t,re),Ce(t,ae),Me(t,se));return Pe(t,o,g,st,t.TRIANGLES,be.length,y.usedCount,_e("a_model_position",y),O("a_vertex",ot,3,t.FLOAT),O("a_normal",nt,3,t.FLOAT),O("a_colour",it,4,t.FLOAT),O("a_selection",R,1,t.FLOAT,1),O("a_texcoord",rt,2,t.FLOAT),O("a_tangent",at,3,t.FLOAT),fe(be))});return Se(t,o,t.TRIANGLES,...w)})}function $e(t,o,{projection:l,view:m}){return o.setClearColour(bt),o.setEnableBits(t.CULL_FACE,t.DEPTH_TEST),o.bindUniform("u_projection",f=>t.uniformMatrix4fv(f,!1,l)),o.bindUniform("u_view",f=>t.uniformMatrix4fv(f,!1,m)),Array.from(A.buffers.entries(),([f,T])=>{const{modelParts:F}=f,{ids:y,positions:R}=T,{buffer:w}=F[0],{indexes:U,vertexes:k}=w;return yt(t,o,t.TRIANGLES,U.length,R.usedCount,_e("a_model_position",R),O("a_vertex",k,3,t.FLOAT),O("a_colour",y,4,t.FLOAT,1),fe(U))})}function We(t,o){o.bind("ArrowDown",()=>v.pedestal(-.5)),o.bind("ArrowUp",()=>v.pedestal(.5)),o.bind("ArrowLeft",()=>G+=100),o.bind("ArrowRight",()=>G-=100),o.bind("Home",()=>J(n.mapDefinition,0)),o.bind("End",()=>J(n.mapDefinition,1)),o.bind("Space",()=>G=0),o.bind("KeyC",()=>J(n.mapDefinition,2)),o.bind("KeyO",()=>Ee(ce.ORTHOGRAPHIC)),o.bind("KeyP",()=>Ee(ce.PERSPECTIVE)),o.bind("KeyL",()=>{E.setDrawMode(t.LINE_LOOP),I.forEach(l=>l.setDrawMode(t.LINE_LOOP)),B.forEach(l=>l.setDrawMode(t.LINE_LOOP))}),o.bind("KeyK",()=>{E.setDrawMode(t.TRIANGLES),I.forEach(l=>l.setDrawMode(t.TRIANGLES)),B.forEach(l=>l.setDrawMode(t.TRIANGLES))})}function Ye(t,o){let l=0;o.bind(de.Left,()=>{if(b(S.hovered)!==l){if(b(S.selected).forEach(m=>A.findInstanceByUid(m).setSelected(!1)),l=S.setHoveredAsSelection(),l>0){const m=A.findInstanceByUid(l),{meta:f,setSelected:T}=m;T(!0),Fe({uid:io(l),...f})}else Fe(void 0);ue(A.buffers.values(),I).forEach((m,f)=>{const{selections:T}=m;f.updateBuffer("a_selection",T,T.usedLength)})}}),o.bind(de.Right,m=>{v.track(-m.movement.dx/10,-m.movement.dy/10)}),o.bind(de.Left|wt.Ctrl,m=>{v.tilt(m.movement.dy/10),v.pan(m.movement.dx/10)}),o.bindScroll(m=>v.dolly(m*.25)),o.bindMove(m=>j=m)}function qe(t,o){o.bind(l=>{function m(T,F){const{movement:y}=F,{dx:R,dy:w}=y;(Math.abs(R)>0||Math.abs(w)>0)&&T.track(-R/10,-w/10)}function f(T,F,y){const{movement:R,currentPosition:w}=F,{movement:U,currentPosition:k}=y,{dx:K,dy:$}=R,{x:H,y:M}=w,{dx:ne,dy:ie}=U,{x:re,y:ae}=k,se=Math.sign(H-re)*(K+ne)+Math.sign(M-ae)*($+ie);T.dolly(se/10)}switch(l.length){case 1:m(v,l[0]);break;case 2:f(v,l[0],l[1]);break}})}const Je=ee(()=>n.textureSet?.image),Qe=(t,[o,l,m],{keyboard:f,mouse:T,touch:F},y)=>{const R=Bt(),w=Ie(n.mapDefinition);p=Ut(w),p.select(y.view,Ae),E=Xe(t,o,y,R,p.lsCoords,p.positions),A.select(p),I.splice(0,1/0,...Ke(t,l,y)),S.init(t),B.splice(0,1/0,...$e(t,m,y)),We(t,f),Ye(t,T),qe(t,F),J(n.mapDefinition,0),x.setLoading(!1)},Ze=(t,o)=>{const{drawingBufferWidth:l,drawingBufferHeight:m}=t;S.setPickingFrameBufferSize(l,m),p.select(o,Ae),A.select(p);const{lsCoords:f,positions:T}=p;E.setInstanceCount(T.usedCount),E.updateBuffer("a_model_position",T,T.usedLength),E.updateBuffer("a_lscoord",f,f.usedLength),ue(A.buffers.values(),I,B).forEach((F,y,R)=>{const{positions:w,ids:U,selections:k}=F;y.setInstanceCount(w.usedCount),y.updateBuffer("a_model_position",w,w.usedLength),y.updateBuffer("a_selection",k,k.usedLength),R.setInstanceCount(w.usedCount),R.updateBuffer("a_model_position",w,w.usedLength),R.updateBuffer("a_colour",U,U.usedLength)})},et=()=>{E.activate(),E.draw(),I.filter(o=>b(o.instanceCount)>0).forEach(o=>{o.activate(!1),o.draw()});let t=0;B.filter(o=>b(o.instanceCount)>0).forEach(o=>{o.activate(t++===0,S.getPickingFrameBuffer()),o.draw()}),t>0&&j&&S.setMousePosition(j).then(tt)};let Te=0;function tt(t){if(t===Te)return;Te=t;const o=t>0?"pointer":void 0;b(d)?.setMouseCursor(o),A.hover(t),ue(A.buffers.values(),I).forEach((l,m)=>{const{selections:f}=l;m.updateBuffer("a_selection",f,f.usedLength)})}const X=vt(v,Qe,Ze,et,t=>{G!==0&&v.arc(G*t/vo)},()=>{B.forEach(t=>t.delete()),I.forEach(t=>t.delete()),E.delete()});return r({fps:X.fps}),(t,o)=>(P(),D(pt,{ref_key:"glPanel",ref:d,"fragment-sources":h,"vertex-sources":_,"projection-mode":u.projectionMode,onInit:b(X).init,onResize:b(X).resize,onExit:b(X).exit},null,8,["projection-mode","onInit","onResize","onExit"]))}}),ho={key:1},Eo=oe({__name:"KeyControl",props:{keyControls:{}},setup(e){return(r,s)=>(P(),D(Ge,{location:"bottom center"},{activator:L(({props:a})=>[C(ve,{location:"top"},{activator:L(({props:c})=>[C(ze,te(te(a,c),{icon:"mdi-keyboard-variant",tile:""}),null,16)]),default:L(()=>[s[0]||(s[0]=Z(" Keyboard control ",-1))]),_:2},1024)]),default:L(()=>[C(Ve,{density:"compact","bg-color":"secondary"},{default:L(()=>[(P(!0),Y(Oe,null,ke(e.keyControls,a=>(P(),D(Ne,{key:a.key,title:a.action},{prepend:L(()=>[a.key.startsWith("mdi-")?(P(),D(z,{key:0,icon:a.key},null,8,["icon"])):(P(),Y("kbd",ho,pe(a.key),1))]),_:2},1032,["title"]))),128))]),_:1})]),_:1}))}}),To=ge(Eo,[["__scopeId","data-v-8b7cd330"]]),bo={key:0},yo={key:1},wo=oe({__name:"MouseControl",props:{mouseControls:{}},setup(e){return(r,s)=>(P(),D(Ge,{location:"bottom center"},{activator:L(({props:a})=>[C(ve,{location:"top"},{activator:L(({props:c})=>[C(ze,te(te(a,c),{icon:"mdi-mouse-variant",tile:""}),null,16)]),default:L(()=>[s[0]||(s[0]=Z(" Mouse control ",-1))]),_:2},1024)]),default:L(()=>[C(Ve,{density:"compact","bg-color":"secondary"},{default:L(()=>[(P(!0),Y(Oe,null,ke(e.mouseControls,a=>(P(),D(Ne,{key:a.action,title:a.action},{prepend:L(()=>[C(ve,{activator:"parent",location:"left"},{default:L(()=>[Z(pe(a.tooltip),1)]),_:2},1024),a.modifier?(P(),Y("kbd",bo,[Z(pe(a.modifier)+" ",1),C(z,{icon:"mdi-plus",size:"x-small"})])):(P(),Y("kbd",yo)),a.leftButton?(P(),D(z,{key:2,icon:"mdi-rectangle",size:"large"})):(P(),D(z,{key:3,icon:"mdi-rectangle-outline",size:"large"})),a.wheel?(P(),D(z,{key:4,icon:"mdi-rectangle",size:"large"})):(P(),D(z,{key:5,icon:"mdi-rectangle-outline",size:"large"})),a.rightButton?(P(),D(z,{key:6,icon:"mdi-rectangle",size:"large"})):(P(),D(z,{key:7,icon:"mdi-rectangle-outline",size:"large"}))]),_:2},1032,["title"]))),128))]),_:1})]),_:1}))}}),Mo=ge(wo,[["__scopeId","data-v-06a81ba9"]]),Bo=oe({__name:"MapPanel",setup(e){const r=Rt(void 0),{mapStore:s,modelsStore:a,texturesStore:c}=Ue(),{heightAndTypeMap:i,map:n,tileMap:d}=s,{modelCache:x}=a,{currentTexture:u,selectTextureById:h,textureList:_}=c,v=ee(()=>{const{worldType:I}=b(n);return b(_).filter(B=>B.worldType===I)}),S=ee(()=>b(u).id),E=[{key:"mdi-arrow-up-bold",action:"move camera up"},{key:"mdi-arrow-down-bold",action:"move camera down"},{key:"mdi-arrow-left-bold",action:"increase camera movement to the left"},{key:"mdi-arrow-right-bold",action:"increase camera movement to the right"},{key:"space",action:"stop camera moving"},{key:"Home",action:"return camera to start position"},{key:"End",action:"send camera to the exit portal position"},{key:"C",action:"send camera to the centre of the map"},{key:"O",action:"orthographic rendering"},{key:"P",action:"perspective rendering"},{key:"K",action:"filled drawing"},{key:"L",action:"line drawing"}],p=[{modifier:"<ctrl>",leftButton:!0,tooltip:"Ctrl + Left button",action:"turn the camera"},{rightButton:!0,tooltip:"Right button",action:"move the camera"},{wheel:!0,tooltip:"Wheel",action:"zoom the camera"}];return(I,B)=>(P(),D(Ft,{fluid:"",class:"d-flex flex-column pa-0"},{default:L(()=>[C(At,{class:"flex-grow-0 flex-shrink-0",color:"secondary"},{default:L(()=>[C(Q,{class:"ml-3","max-width":"176"},{default:L(()=>[C(Vt,{"item-value":"id","item-title":"name",label:"Landscape","hide-details":"",items:v.value,"model-value":S.value,"onUpdate:modelValue":b(h)},null,8,["items","model-value","onUpdate:modelValue"])]),_:1}),C(It),C(Q,{class:"mr-3","max-width":"56"},{default:L(()=>[C(To,{"key-controls":E})]),_:1}),C(Q,{class:"mr-3","max-width":"56"},{default:L(()=>[C(Mo,{"mouse-controls":p})]),_:1}),C(Q,{class:"mr-3","max-width":"56"},{default:L(()=>[C(Mt,{class:"noMouse","hide-details":"",label:"fps","model-value":r.value?.fps,readonly:""},null,8,["model-value"])]),_:1})]),_:1}),C(xo,{ref_key:"mapScene",ref:r,class:"flex-fill","map-definition":b(n),"height-and-type-map":b(i),"tile-map":b(d),models:b(x).contents,"texture-set":b(u)},null,8,["map-definition","height-and-type-map","tile-map","models","texture-set"])]),_:1}))}});export{Bo as default};
