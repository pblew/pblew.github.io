import{f as G,y as at,z as Y,q as st,A as ct,s as ut,a as ft,D as dt,E as lt,F as mt,H as _t,P as ue,c as vt,C as pt,u as xt,G as ht,I as fe,d as Et,j as Me,w as Tt,h as bt,x as yt,k as we,l as Ce,m as Le,p as Se,o as Pe,g as de,e as z,i as Ie,J as Mt,K as wt,B as le,M as Ct,V as Lt}from"./VTextField-DDrnnwWa.js";import{aq as De,ar as Ae,as as St,x as J,u as y,d as ne,at as Pt,s as Be,c as B,o as R,z as It,v as Rt,y as Re,w as I,a as P,V as Ve,g as q,h as Ue,F as ke,i as pe,e as te,j as Oe,m as oe,f as ze,au as j,t as xe,_ as Ne,r as Ft,l as Dt,p as Z,n as At,q as Bt}from"./index-B19zD5W-.js";import{F as me,I as _e,u as ve}from"./Positions-B6s2AX71.js";import{f as Vt}from"./ObjModel-Dfaq8umK.js";import{u as Fe,g as Ut,a as kt,V as Ot}from"./VSelect-C7rG3Jk3.js";import{V as ge}from"./VMenu-CcLqGeYH.js";import"./VSlideGroup-7xO0dBsV.js";function zt(e,i,c,r,f,o,a){return{ambient:e,diffuse:i,emissive:c,opacity:r,opticalDensity:f,shininess:o,specular:a}}const Nt=zt(G(1,1,1),G(.8,.8,.8),G(0,0,0),1,1,225,G(.5,.5,.5));function*gt(e,i){for(const[c,r]of e.entries())for(const f of r)yield i(c,f)}function*jt(e,i){for(const[c,r]of e.entries())yield i(c,r)}const Gt=(e,i)=>[i.uid,i],Ht=(e,i)=>{const c=i.length,r=new me(c,_e.MAT4),f=new me(c,_e.VEC4),o=new me(c,_e.FLOAT);return[e,{positions:r,ids:f,selections:o}]};function Xt(e){const i=new Map(gt(e,Gt)),c=new Map(jt(e,Ht));function r(a){return at(i.get(a),`No model instance found for uid=${a}`)}function f(a,v){e.forEach((E,p)=>{const T=c.get(p);if(T===void 0)return;const{positions:_,ids:l,selections:x}=T;_.clear(),l.clear(),x.clear();let s=0;for(const h of E){const{activate:w,deactivate:C,isInView:k}=h;k(a,v)?(w({position:_.itemAt(s),id:l.itemAt(s),selection:x.itemAt(s)}),s++):C()}})}function o(a){i.forEach(v=>{v.setHovered(v.uid===a)})}return{models:e,buffers:c,findInstanceByUid:r,select:f,hover:o}}function Kt(e){const i=Y(e,e.getParameter(e.MAX_CLIENT_WAIT_TIMEOUT_WEBGL),"Failed to retrieve max client wait timeout");async function c(o){const a=Y(o,o.fenceSync(o.SYNC_GPU_COMMANDS_COMPLETE,0),"Failed to get sync object");return o.flush(),new Promise((v,E)=>{function p(){switch(o.clientWaitSync(a,o.SYNC_FLUSH_COMMANDS_BIT,i)){case o.WAIT_FAILED:if(T--)requestAnimationFrame(p);else{const _=o.getError();o.deleteSync(a),E(_)}break;case o.TIMEOUT_EXPIRED:requestAnimationFrame(p);break;default:o.deleteSync(a),v(o.NO_ERROR)}}let T=1;requestAnimationFrame(p)})}async function r(o,a,v,E,p,T,_){return await c(o),o.bindBuffer(a,v),o.getBufferSubData(a,E,p,T,_),o.bindBuffer(a,null),p}async function f(o,a,v,E,p,T,_,l,x=0){const s=o.createBuffer();o.bindBuffer(o.PIXEL_PACK_BUFFER,s),o.bufferData(o.PIXEL_PACK_BUFFER,l.byteLength,o.STREAM_READ),o.readPixels(a,v,E,p,T,_,x),o.bindBuffer(o.PIXEL_PACK_BUFFER,null),await r(o,o.PIXEL_PACK_BUFFER,s,0,l),o.deleteBuffer(s)}return{readPixels:(o,a,v,E,p,T,_,l)=>f(e,o,a,v,E,p,T,_,l)}}function $t(e,i=300,c=150){const r=Y(e,e.createTexture(),"Failed to create texture");e.bindTexture(e.TEXTURE_2D,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const f=Y(e,e.createRenderbuffer(),"Failed to create render buffer");e.bindRenderbuffer(e.RENDERBUFFER,f);const o=Y(e,e.createFramebuffer(),"Failed to create frame buffer");e.bindFramebuffer(e.FRAMEBUFFER,o),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,r,0),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,f),a(i,c);function a(v,E){e.bindTexture(e.TEXTURE_2D,r),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,v,E,0,e.RGBA,e.UNSIGNED_BYTE,null),e.bindRenderbuffer(e.RENDERBUFFER,f),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,v,E)}return{frameBuffer:o,setSize:a}}const he=8;function Wt(e,i){return!!(e>>>i&1)}function je(e,i){return 1<<i*he-1-e}function Yt(e,i,c){return e&=~je(i,c),e}function qt(e,i,c){return e|=je(i,c),e}function Jt(e){if(e<1||e>4)throw new RangeError(`Bytes should be in the range 1 - 4, was: ${e}`)}function Qt(e,i=4){Jt(i);let c=0;const r=i*he;for(let f=0;f<r;f++){const o=Wt(e,f),a=f%i*he+Math.floor(f/i);c=o?qt(c,a,i):Yt(c,a,i)}return c}const Zt=e=>e[0]<<16|e[1]<<8|e[2];function*eo(){let e=0;for(;e<16777215;)yield Qt(++e,3);throw new Error(`Ran out of UIDs (n=${e})`)}let to=eo();function oo(){return to.next().value}function no(){const e=De({hovered:0,selected:new Set});let i,c,r,f=150;const o=new Uint8Array(4);function a(_){i=_,c=Kt(_),r=$t(i)}function v(){if(r===void 0)throw new Error("Picking has not been initialised");return r.frameBuffer}function E(_,l){f=l,r?.setSize(_,l)}function p(){e.selected.clear();const _=e.hovered;return _>0&&e.selected.add(_),_}function T(_){const{x:l,y:x}=_;return new Promise(s=>{if(i===void 0||c===void 0)throw new Error("Picking has not been initialised");c.readPixels(l,f-x,1,1,i.RGBA,i.UNSIGNED_BYTE,o).then(()=>{const h=Zt(o);e.hovered=h,s(h)},()=>{e.hovered=0,s(0)})})}return{...Ae(e),init:a,getPickingFrameBuffer:v,setPickingFrameBufferSize:E,setHoveredAsSelection:p,setMousePosition:T}}const io=(e,i=6)=>(isFinite(e)?e:0).toString(16).padStart(i,"0");function ro(e,i){return{modelName:e,modelParts:i}}function ao(e,i,c){const r=oo(),f=st(...ct(r).toArray()),o=St({worldCoord:{...i},hovered:!1,selected:!1,buffers:void 0}),a=J(s=>{const{x:h,y:w,z:C}=o.worldCoord;return s===void 0?G(h,w,C):ut(s,h,w,C)}),v=J(()=>o.selected?.2:o.hovered?.1:0),E=ft();function p(s,h){dt(E,y(a),s);const[w,C,k]=E,N=w/-k,D=C/-k;return N>-h&&N<h&&D>-h&&D<h+h}function T(s){o.buffers=s,lt(s.position,y(a)),mt(s.id,f),s.selection[0]=y(v)}function _(){o.buffers=void 0}function l(s){o.hovered!==s&&(o.hovered=s,o.buffers&&(o.buffers.selection[0]=y(v)))}function x(s){o.selected!==s&&(o.selected=s,o.buffers&&(o.buffers.selection[0]=y(v)))}return{...Ae(o),uid:r,modelName:e,meta:c,isInView:p,activate:T,deactivate:_,setHovered:l,setSelected:x}}function so(e,i,c){const r=new Map,f=new Set;return i.nodes.filter(o=>!!o.object).reduce((o,a)=>{const{object:v,altitude:E,position:p}=a,{type:T,index:_}=v;if(T===void 0)return o;const l=T==="DECORATIVE"?`${T}_${_}`:T,x=`${l.toLowerCase()}.obj`;if(f.has(x))return o;let s=r.get(x);if(s===void 0){const D=e.get(x);if(D===void 0)return f.add(x),o;const g=Vt(D);s=ro(x,g),r.set(x,s)}const[h,w,C]=c.vertexFor(p.x,p.y),k=(C&1)-1,N=ao(x,{x:h+k,y:w,z:C},{objectId:l,position:p,altitude:E});return o.has(s)?o.get(s).push(N):o.set(s,[N]),o},new Map)}var co=`#version 300 es
precision highp float;in vec3 v_normal;in vec2 v_texcoord;in vec3 v_surfaceToLight;uniform vec3 u_emissive;uniform vec3 u_ambient;uniform vec3 u_ambientLight;uniform vec3 u_diffuse;uniform float u_opacity;uniform sampler2D u_texture;out vec4 outColour;void main(void){vec3 normal=normalize(v_normal);vec3 surfaceToLightDirection=normalize(v_surfaceToLight);float diffuseLight=dot(surfaceToLightDirection,normal)*0.5+0.5;vec4 diffuseColour=texture(u_texture,v_texcoord);vec3 diffuse=u_diffuse*diffuseColour.rgb;float opacity=u_opacity*diffuseColour.a;outColour=vec4(u_emissive+u_ambient*u_ambientLight+diffuse*diffuseLight,opacity);}`,uo=`#version 300 es
precision highp sampler2D;in mat4 a_model_position;in vec3 a_vertex;in vec2 a_lscoord;uniform mat4 u_projection;uniform mat4 u_view;uniform sampler2D u_miscDataMap;uniform sampler2D u_miscData2Map;uniform vec3 u_worldLightPosition;out vec3 v_normal;out vec2 v_texcoord;out vec3 v_surfaceToLight;const int NUM_TILES=2;const float HEIGHT_SCALE=0.2;const ivec2[6]EVEN_VERTEX_OFFSETS=ivec2[6](ivec2(0,0),ivec2(0,1),ivec2(1,1),ivec2(0,0),ivec2(1,1),ivec2(1,0));const ivec2[6]ODD_VERTEX_OFFSETS=ivec2[6](ivec2(0,0),ivec2(-1,1),ivec2(0,1),ivec2(0,0),ivec2(0,1),ivec2(1,0));int wrap_int(int value,int min_value,int max_value){return((value-min_value)%(max_value+min_value))+min_value;}ivec2 getMainVertexCoord(vec2 lscoord,ivec2 mapSize,int tile){int tileOffset=tile*mapSize.y/NUM_TILES;int y=int(lscoord.r)+tileOffset;int x=wrap_int(int(lscoord.g)+int((y&1)==0),0,mapSize.x);return ivec2(x,y);}ivec2 getOffsetVertexCoord(vec2 lscoord,ivec2 mapSize,int tile,int vertexId,bool isEvenRow){int mapHeight=mapSize.y/NUM_TILES;int tileOffset=tile*mapHeight;ivec2 vertexOffset=isEvenRow ? EVEN_VERTEX_OFFSETS[vertexId]: ODD_VERTEX_OFFSETS[vertexId];int y=wrap_int(int(lscoord.r)+vertexOffset.y,0,mapHeight)+tileOffset;int x=wrap_int(int(lscoord.g)+vertexOffset.x+int((y&1)==0),0,mapSize.x);return ivec2(x,y);}int lookupInt(sampler2D source,int row,int offset){vec4 pixel=texelFetch(source,ivec2(offset>>2,row),0);return int(pixel[offset&3]*255.0);}vec2 texcoordFromLs(vec2 ls1){int triangle=int(step(3.0,float(gl_VertexID)));int lsId=int(ls1[triangle]*255.0);int tileXoffset=lookupInt(u_miscData2Map,lsId,0);int tileYoffset=lookupInt(u_miscData2Map,lsId,1);int vertexXoffset=lookupInt(u_miscData2Map,lsId,2+(gl_VertexID<<1));int vertexYoffset=lookupInt(u_miscData2Map,lsId,3+(gl_VertexID<<1));return vec2(float(tileXoffset+vertexXoffset)/255.0,float(tileYoffset+vertexYoffset)/255.0);}void main(void){ivec2 mapSize=textureSize(u_miscDataMap,0);ivec2 mainVertexCoord=getMainVertexCoord(a_lscoord,mapSize,1);bool isEvenRow=(mainVertexCoord.y&1)==0;vec4 mainVertexMap1Colour=texelFetch(u_miscDataMap,mainVertexCoord,0);vec2 ls=mainVertexMap1Colour.gb;ivec2 offsetVertexCoordTile0=getOffsetVertexCoord(a_lscoord,mapSize,0,gl_VertexID,isEvenRow);vec4 offsetVertexMap0Colour=texelFetch(u_miscDataMap,offsetVertexCoordTile0,0);vec3 normal=offsetVertexMap0Colour.rgb;ivec2 offsetVertexCoordTile1=getOffsetVertexCoord(a_lscoord,mapSize,1,gl_VertexID,isEvenRow);vec4 offsetVertexMap1Colour=texelFetch(u_miscDataMap,offsetVertexCoordTile1,0);float altitude=(offsetVertexMap1Colour.r*255.0)*HEIGHT_SCALE;vec4 worldPosition=u_view*a_model_position*vec4(a_vertex.x,altitude,a_vertex.z,1.0);gl_Position=u_projection*worldPosition;v_normal=normal;v_texcoord=texcoordFromLs(ls);v_surfaceToLight=u_worldLightPosition-worldPosition.xyz;}`,fo=`#version 300 es
precision highp float;in vec3 v_normal;in vec4 v_colour;in vec2 v_texcoord;in vec3 v_tangent;in vec3 v_surfaceToLight;in vec3 v_surfaceToView;uniform vec3 u_emissive;uniform vec3 u_ambient;uniform vec3 u_ambientLight;uniform vec3 u_diffuse;uniform vec3 u_specular;uniform float u_opacity;uniform float u_shininess;uniform sampler2D u_diffuseMap;uniform sampler2D u_normalMap;uniform sampler2D u_specularMap;out vec4 outColour;void main(void){vec3 normal=normalize(v_normal)*(float(gl_FrontFacing)*2.0-1.0);vec3 tangent=normalize(v_tangent)*(float(gl_FrontFacing)*2.0-1.0);vec3 bitangent=normalize(cross(normal,tangent));mat3 tbn=mat3(tangent,bitangent,normal);normal=texture(u_normalMap,v_texcoord).rgb*2.0-1.0;normal=normalize(tbn*normal);vec3 surfaceToLightDirection=normalize(v_surfaceToLight);vec3 surfaceToViewDirection=normalize(v_surfaceToView);vec3 halfVector=normalize(surfaceToLightDirection+surfaceToViewDirection);float diffuseLight=dot(surfaceToLightDirection,normal)*0.5+0.5;vec4 diffuseMapColour=texture(u_diffuseMap,v_texcoord);vec3 diffuse=u_diffuse*diffuseMapColour.rgb*v_colour.rgb;float specularLight=clamp(dot(normal,halfVector),0.0,1.0);vec4 specularMapColour=texture(u_specularMap,v_texcoord);vec3 specular=u_specular*specularMapColour.rgb;float opacity=u_opacity*diffuseMapColour.a*v_colour.a;outColour=vec4(u_emissive+u_ambient*u_ambientLight+diffuse*diffuseLight+specular*pow(specularLight,u_shininess),opacity);}`,lo=`#version 300 es
layout(location=0)in mat4 a_model_position;layout(location=4)in vec3 a_vertex;in vec3 a_normal;layout(location=7)in vec4 a_colour;in float a_selection;in vec2 a_texcoord;in vec3 a_tangent;uniform mat4 u_projection;uniform mat4 u_view;uniform mat4 u_world;uniform vec3 u_worldLightPosition;uniform vec3 u_cameraPosition;out vec3 v_normal;out vec4 v_colour;out vec2 v_texcoord;out vec3 v_tangent;out vec3 v_surfaceToLight;out vec3 v_surfaceToView;void main(){vec4 worldPosition=u_view*a_model_position*vec4(a_vertex,1.0);gl_Position=u_projection*worldPosition;v_colour=a_colour+vec4(a_selection,a_selection,a_selection,0.0);v_texcoord=a_texcoord;v_surfaceToLight=u_worldLightPosition-worldPosition.xyz;v_surfaceToView=u_cameraPosition-worldPosition.xyz;mat3 normalMat=mat3(u_world);v_normal=normalize(normalMat*a_normal);v_tangent=normalize(normalMat*a_tangent);}`,mo=`#version 300 es
precision highp float;flat in vec4 v_colour;out vec4 outColour;void main(){outColour=v_colour;}`,_o=`#version 300 es
layout(location=0)in mat4 a_model_position;layout(location=4)in vec3 a_vertex;layout(location=7)in vec4 a_colour;uniform mat4 u_projection;uniform mat4 u_view;flat out vec4 v_colour;void main(){gl_Position=u_projection*u_view*a_model_position*vec4(a_vertex,1.0);v_colour=a_colour;}`;const vo=3e5,ee=1.25,po=1,xo=ne({__name:"MapScene",props:{mapDefinition:{},heightAndTypeMap:{},tileMap:{},models:{},textureSet:{}},setup(e,{expose:i}){function c(t,n){switch(n){case 0:return t.hqCoordinates;case 1:return t.portalCoordinates;case 2:return{x:t.width/2,y:t.height/2}}}const r=_t(),f=G(-128,64,0),o=G(.1,.1,.1),a=e,v=Pt("glPanel"),{loadingStore:E}=Be(),p=De({projectionMode:ue.PERSPECTIVE}),T=[co,fo,mo],_=[uo,lo,_o],l=vt(pt.LookAt),x=no();let s,h;const w=[],C=[];let k;const N=Fe(a.mapDefinition),D=Xt(so(a.models,a.mapDefinition,N));let g=0;const Ee=po*12;function Q(t,n){const d=c(t,n)??c(t,2),[m,u,b]=N.vertexFor(d.x,d.y),A=(d.y&1)-1;l.lookAt(m+A,u,b),l.moveTo(m+A,Ee,b+Ee),g=0}function Te(t){p.projectionMode=t,K.resize()}function Ge(t,n,{projection:d,view:m},{indexes:u,vertexes:b},A,M){const{ambient:F,emissive:L,opacity:V}=Nt,O=G(1,1,1);n.setClearColour(Et),n.setEnableBits(t.CULL_FACE,t.DEPTH_TEST,t.SCISSOR_TEST),n.bindUniform("u_projection",S=>t.uniformMatrix4fv(S,!1,d)),n.bindUniform("u_view",S=>t.uniformMatrix4fv(S,!1,m)),n.bindUniform("u_ambientLight",S=>t.uniform3fv(S,o)),n.bindUniform("u_worldLightPosition",S=>t.uniform3fv(S,f)),n.bindUniform("u_emissive",S=>t.uniform3fv(S,L)),n.bindUniform("u_ambient",S=>t.uniform3fv(S,F)),n.bindUniform("u_diffuse",S=>t.uniform3fv(S,O)),n.bindUniform("u_opacity",S=>t.uniform1f(S,V));const $=Ie(t),W=Me(Le(t),Ce(t),we(t),yt(t,a.tileMap),Tt(t,bt(16,24,It))),X=Se(t,n,t.TRIANGLES,Pe(t,n,$,W,t.TRIANGLES,u.length,M.usedCount,ve("a_model_position",M),z("a_vertex",b,3,t.FLOAT),z("a_lscoord",A,2,t.FLOAT,1),de(u)));return Rt(Ye,X.setTexture,{immediate:!0}),X}function He(t,n,{projection:d,view:m}){return n.bindUniform("u_projection",u=>t.uniformMatrix4fv(u,!1,d)),n.bindUniform("u_view",u=>t.uniformMatrix4fv(u,!1,m)),n.bindUniform("u_world",u=>t.uniformMatrix4fv(u,!1,r)),n.bindUniform("u_cameraPosition",u=>t.uniform3fv(u,l.position)),n.bindUniform("u_ambientLight",u=>t.uniform3fv(u,o)),n.bindUniform("u_worldLightPosition",u=>t.uniform3fv(u,f)),Array.from(D.buffers.entries(),([u,b])=>{const{modelParts:A}=u,{positions:M,selections:F}=b,L=A.map(V=>{const{buffer:O,ambient:$,diffuse:W,emissive:X,opacity:S,shininess:ie,specular:re,diffuseMap:ae,normalMap:se,specularMap:ce}=V,{vertexes:et,normals:tt,colours:ot,texcoords:nt,tangents:it,indexes:ye}=O,H=Ie(t);H.bindUniform("u_emissive",U=>t.uniform3fv(U,X)),H.bindUniform("u_ambient",U=>t.uniform3fv(U,$)),H.bindUniform("u_diffuse",U=>t.uniform3fv(U,W)),H.bindUniform("u_specular",U=>t.uniform3fv(U,re)),H.bindUniform("u_opacity",U=>t.uniform1f(U,S)),H.bindUniform("u_shininess",U=>t.uniform1f(U,ie+25));const rt=Me(Le(t,ae),Ce(t,se),we(t,ce));return Pe(t,n,H,rt,t.TRIANGLES,ye.length,M.usedCount,ve("a_model_position",M),z("a_vertex",et,3,t.FLOAT),z("a_normal",tt,3,t.FLOAT),z("a_colour",ot,4,t.FLOAT),z("a_selection",F,1,t.FLOAT,1),z("a_texcoord",nt,2,t.FLOAT),z("a_tangent",it,3,t.FLOAT),de(ye))});return Se(t,n,t.TRIANGLES,...L)})}function Xe(t,n,{projection:d,view:m}){return n.setClearColour(Mt),n.setEnableBits(t.CULL_FACE,t.DEPTH_TEST),n.bindUniform("u_projection",u=>t.uniformMatrix4fv(u,!1,d)),n.bindUniform("u_view",u=>t.uniformMatrix4fv(u,!1,m)),Array.from(D.buffers.entries(),([u,b])=>{const{modelParts:A}=u,{ids:M,positions:F}=b,{buffer:L}=A[0],{indexes:V,vertexes:O}=L;return wt(t,n,t.TRIANGLES,V.length,F.usedCount,ve("a_model_position",F),z("a_vertex",O,3,t.FLOAT),z("a_colour",M,4,t.FLOAT,1),de(V))})}function Ke(t,n){n.bind("ArrowDown",()=>l.pedestal(-.5)),n.bind("ArrowUp",()=>l.pedestal(.5)),n.bind("ArrowLeft",()=>g+=100),n.bind("ArrowRight",()=>g-=100),n.bind("Home",()=>Q(a.mapDefinition,0)),n.bind("End",()=>Q(a.mapDefinition,1)),n.bind("Space",()=>g=0),n.bind("KeyC",()=>Q(a.mapDefinition,2)),n.bind("KeyO",()=>Te(ue.ORTHOGRAPHIC)),n.bind("KeyP",()=>Te(ue.PERSPECTIVE)),n.bind("KeyL",()=>{s.setDrawMode(t.LINE_LOOP),w.forEach(d=>d.setDrawMode(t.LINE_LOOP)),C.forEach(d=>d.setDrawMode(t.LINE_LOOP))}),n.bind("KeyK",()=>{s.setDrawMode(t.TRIANGLES),w.forEach(d=>d.setDrawMode(t.TRIANGLES)),C.forEach(d=>d.setDrawMode(t.TRIANGLES))})}function $e(t,n){let d=0;n.bind(le.Left,()=>{if(y(x.hovered)!==d){if(y(x.selected).forEach(m=>D.findInstanceByUid(m).setSelected(!1)),d=x.setHoveredAsSelection(),d>0){const m=D.findInstanceByUid(d),{meta:u,setSelected:b}=m;b(!0),Re({uid:io(d),...u})}else Re(void 0);fe(D.buffers.values(),w).forEach((m,u)=>{const{selections:b}=m;u.updateBuffer("a_selection",b,b.usedLength)})}}),n.bind(le.Right,m=>{l.track(-m.movement.dx/10,-m.movement.dy/10)}),n.bind(le.Left|Ct.Ctrl,m=>{l.tilt(m.movement.dy/10),l.pan(m.movement.dx/10)}),n.bindScroll(m=>l.dolly(m*.25)),n.bindMove(m=>k=m)}function We(t,n){n.bind(d=>{function m(b,A){const{movement:M}=A,{dx:F,dy:L}=M;(Math.abs(F)>0||Math.abs(L)>0)&&b.track(-F/10,-L/10)}function u(b,A,M){const{movement:F,currentPosition:L}=A,{movement:V,currentPosition:O}=M,{dx:$,dy:W}=F,{x:X,y:S}=L,{dx:ie,dy:re}=V,{x:ae,y:se}=O,ce=Math.sign(X-ae)*($+ie)+Math.sign(S-se)*(W+re);b.dolly(ce/10)}switch(d.length){case 1:m(l,d[0]);break;case 2:u(l,d[0],d[1]);break}})}const Ye=J(()=>a.textureSet?.image),qe=(t,[n,d,m],{keyboard:u,mouse:b,touch:A},M)=>{const F=Ut(),L=Fe(a.mapDefinition);h=kt(L),h.select(M.view,ee),s=Ge(t,n,M,F,h.lsCoords,h.positions),D.select(M.view,ee),w.splice(0,1/0,...He(t,d,M)),x.init(t),C.splice(0,1/0,...Xe(t,m,M)),Ke(t,u),$e(t,b),We(t,A),Q(a.mapDefinition,0),E.setLoading(!1)},Je=(t,n)=>{const{drawingBufferWidth:d,drawingBufferHeight:m}=t;x.setPickingFrameBufferSize(d,m),h.select(n,ee),D.select(n,ee);const{lsCoords:u,positions:b}=h;s.setInstanceCount(b.usedCount),s.updateBuffer("a_model_position",b,b.usedLength),s.updateBuffer("a_lscoord",u,u.usedLength),fe(D.buffers.values(),w,C).forEach((A,M,F)=>{const{positions:L,ids:V,selections:O}=A;M.setInstanceCount(L.usedCount),M.updateBuffer("a_model_position",L,L.usedLength),M.updateBuffer("a_selection",O,O.usedLength),F.setInstanceCount(L.usedCount),F.updateBuffer("a_model_position",L,L.usedLength),F.updateBuffer("a_colour",V,V.usedLength)})},Qe=()=>{s.activate(),s.draw(),w.filter(n=>y(n.instanceCount)>0).forEach(n=>{n.activate(!1),n.draw()});let t=0;C.filter(n=>y(n.instanceCount)>0).forEach(n=>{n.activate(t++===0,x.getPickingFrameBuffer()),n.draw()}),t>0&&k&&x.setMousePosition(k).then(Ze)};let be=0;function Ze(t){if(t===be)return;be=t;const n=t>0?"pointer":void 0;y(v)?.setMouseCursor(n),D.hover(t),fe(D.buffers.values(),w).forEach((d,m)=>{const{selections:u}=d;m.updateBuffer("a_selection",u,u.usedLength)})}const K=xt(l,qe,Je,Qe,t=>{g!==0&&l.arc(g*t/vo)},()=>{C.forEach(t=>t.delete()),w.forEach(t=>t.delete()),s.delete()});return i({fps:K.fps}),(t,n)=>(R(),B(ht,{ref_key:"glPanel",ref:v,"fragment-sources":T,"vertex-sources":_,"projection-mode":p.projectionMode,onInit:y(K).init,onResize:y(K).resize,onExit:y(K).exit},null,8,["projection-mode","onInit","onResize","onExit"]))}}),ho={key:1},Eo=ne({__name:"KeyControl",props:{keyControls:{}},setup(e){return(i,c)=>(R(),B(ge,{location:"bottom center"},{activator:I(({props:r})=>[P(pe,{location:"top"},{activator:I(({props:f})=>[P(Oe,oe(oe(r,f),{icon:"mdi-keyboard-variant",tile:""}),null,16)]),default:I(()=>[c[0]||(c[0]=te(" Keyboard control ",-1))]),_:2},1024)]),default:I(()=>[P(Ve,{density:"compact","bg-color":"secondary"},{default:I(()=>[(R(!0),q(ke,null,Ue(e.keyControls,r=>(R(),B(ze,{key:r.key,title:r.action},{prepend:I(()=>[r.key.startsWith("mdi-")?(R(),B(j,{key:0,icon:r.key},null,8,["icon"])):(R(),q("kbd",ho,xe(r.key),1))]),_:2},1032,["title"]))),128))]),_:1})]),_:1}))}}),To=Ne(Eo,[["__scopeId","data-v-8b7cd330"]]),bo={key:0},yo={key:1},Mo=ne({__name:"MouseControl",props:{mouseControls:{}},setup(e){return(i,c)=>(R(),B(ge,{location:"bottom center"},{activator:I(({props:r})=>[P(pe,{location:"top"},{activator:I(({props:f})=>[P(Oe,oe(oe(r,f),{icon:"mdi-mouse-variant",tile:""}),null,16)]),default:I(()=>[c[0]||(c[0]=te(" Mouse control ",-1))]),_:2},1024)]),default:I(()=>[P(Ve,{density:"compact","bg-color":"secondary"},{default:I(()=>[(R(!0),q(ke,null,Ue(e.mouseControls,r=>(R(),B(ze,{key:r.action,title:r.action},{prepend:I(()=>[P(pe,{activator:"parent",location:"left"},{default:I(()=>[te(xe(r.tooltip),1)]),_:2},1024),r.modifier?(R(),q("kbd",bo,[te(xe(r.modifier)+" ",1),P(j,{icon:"mdi-plus",size:"x-small"})])):(R(),q("kbd",yo)),r.leftButton?(R(),B(j,{key:2,icon:"mdi-rectangle",size:"large"})):(R(),B(j,{key:3,icon:"mdi-rectangle-outline",size:"large"})),r.wheel?(R(),B(j,{key:4,icon:"mdi-rectangle",size:"large"})):(R(),B(j,{key:5,icon:"mdi-rectangle-outline",size:"large"})),r.rightButton?(R(),B(j,{key:6,icon:"mdi-rectangle",size:"large"})):(R(),B(j,{key:7,icon:"mdi-rectangle-outline",size:"large"}))]),_:2},1032,["title"]))),128))]),_:1})]),_:1}))}}),wo=Ne(Mo,[["__scopeId","data-v-06a81ba9"]]),Bo=ne({__name:"MapPanel",setup(e){const i=Ft(void 0),{mapStore:c,modelsStore:r,texturesStore:f}=Be(),{heightAndTypeMap:o,map:a,tileMap:v}=c,{modelCache:E}=r,{currentTexture:p,selectTextureById:T,textureList:_}=f,l=J(()=>{const{worldType:w}=y(a);return y(_).filter(C=>C.worldType===w)}),x=J(()=>y(p).id),s=[{key:"mdi-arrow-up-bold",action:"move camera up"},{key:"mdi-arrow-down-bold",action:"move camera down"},{key:"mdi-arrow-left-bold",action:"increase camera movement to the left"},{key:"mdi-arrow-right-bold",action:"increase camera movement to the right"},{key:"space",action:"stop camera moving"},{key:"Home",action:"return camera to start position"},{key:"End",action:"send camera to the exit portal position"},{key:"C",action:"send camera to the centre of the map"},{key:"O",action:"orthographic rendering"},{key:"P",action:"perspective rendering"},{key:"K",action:"filled drawing"},{key:"L",action:"line drawing"}],h=[{modifier:"<ctrl>",leftButton:!0,tooltip:"Ctrl + Left button",action:"turn the camera"},{rightButton:!0,tooltip:"Right button",action:"move the camera"},{wheel:!0,tooltip:"Wheel",action:"zoom the camera"}];return(w,C)=>(R(),B(Dt,{fluid:"",class:"d-flex flex-column pa-0"},{default:I(()=>[P(Bt,{class:"flex-grow-0 flex-shrink-0",color:"secondary"},{default:I(()=>[P(Z,{class:"ml-3","max-width":"176"},{default:I(()=>[P(Ot,{"item-value":"id","item-title":"name",label:"Landscape","hide-details":"",items:l.value,"model-value":x.value,"onUpdate:modelValue":y(T)},null,8,["items","model-value","onUpdate:modelValue"])]),_:1}),P(At),P(Z,{class:"mr-3","max-width":"56"},{default:I(()=>[P(To,{"key-controls":s})]),_:1}),P(Z,{class:"mr-3","max-width":"56"},{default:I(()=>[P(wo,{"mouse-controls":h})]),_:1}),P(Z,{class:"mr-3","max-width":"56"},{default:I(()=>[P(Lt,{class:"noMouse","hide-details":"",label:"fps","model-value":i.value?.fps,readonly:""},null,8,["model-value"])]),_:1})]),_:1}),P(xo,{ref_key:"mapScene",ref:i,class:"flex-fill","map-definition":y(a),"height-and-type-map":y(o),"tile-map":y(v),models:y(E).contents,"texture-set":y(p)},null,8,["map-definition","height-and-type-map","tile-map","models","texture-set"])]),_:1}))}});export{Bo as default};
