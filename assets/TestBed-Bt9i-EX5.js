import{c as ie,C as ae,q as ne,f as se,n as re,u as ce,G as le,v as B,B as P,d as ue,j as de,w as fe,h as me,x as pe,k as ve,l as xe,m as _e,p as he,o as Te,g as Se,e as N,i as Ee,V as Me}from"./VTextField-C8Tt_kfs.js";import{d as X,x as y,s as $,r as Ve,c as j,o as K,u as i,v as O,y as ge,z as ye,A as Ce,w as S,l as Ie,a as f,p as R,n as De,q as we}from"./index-CZGhR0OV.js";import{u as Le}from"./Positions-Ds6gUhSX.js";import{u as U,g as be,a as ze,V as G}from"./VSelect-DSDe2SGn.js";import"./VMenu-CxYjlaWO.js";import"./VSlideGroup-CB414sgM.js";var Fe=`#version 300 es
precision highp float;in vec3 v_normal;in vec2 v_texcoord;uniform vec4 u_ambientLight;uniform vec3 u_reverseLightDirection;uniform sampler2D u_texture;out vec4 outColour;void main(void){vec3 normal=normalize(v_normal);float light=dot(normal,u_reverseLightDirection);outColour=texture(u_texture,v_texcoord);outColour.rgb*=light;outColour+=u_ambientLight;}`,Re=`#version 300 es
precision highp sampler2D;in mat4 a_model_position;in vec3 a_vertex;in vec2 a_lscoord;uniform mat4 u_projection;uniform mat4 u_view;uniform sampler2D u_miscDataMap;uniform sampler2D u_miscData2Map;out vec3 v_normal;out vec2 v_texcoord;out vec4 v_colour;const int NUM_TILES=2;const float HEIGHT_SCALE=0.2;const ivec2[6]EVEN_VERTEX_OFFSETS=ivec2[6](ivec2(0,0),ivec2(0,1),ivec2(1,1),ivec2(0,0),ivec2(1,1),ivec2(1,0));const ivec2[6]ODD_VERTEX_OFFSETS=ivec2[6](ivec2(0,0),ivec2(-1,1),ivec2(0,1),ivec2(0,0),ivec2(0,1),ivec2(1,0));int wrap_int(int value,int min_value,int max_value){return((value-min_value)%(max_value+min_value))+min_value;}ivec2 getMainVertexCoord(vec2 lscoord,ivec2 mapSize,int tile){int tileOffset=tile*mapSize.y/NUM_TILES;int y=int(lscoord.r)+tileOffset;int x=wrap_int(int(lscoord.g)+int((y&1)==0),0,mapSize.x);return ivec2(x,y);}ivec2 getOffsetVertexCoord(vec2 lscoord,ivec2 mapSize,int tile,int vertexId,bool isEvenRow){int mapHeight=mapSize.y/NUM_TILES;int tileOffset=tile*mapHeight;ivec2 vertexOffset=isEvenRow ? EVEN_VERTEX_OFFSETS[vertexId]: ODD_VERTEX_OFFSETS[vertexId];int y=wrap_int(int(lscoord.r)+vertexOffset.y,0,mapHeight)+tileOffset;int x=wrap_int(int(lscoord.g)+vertexOffset.x+int((y&1)==0),0,mapSize.x);return ivec2(x,y);}int lookupInt(sampler2D source,int row,int offset){vec4 pixel=texelFetch(source,ivec2(offset>>2,row),0);return int(pixel[offset&3]*255.0);}vec2 texcoordFromLs(vec2 ls1){int triangle=int(step(3.0,float(gl_VertexID)));int lsId=int(ls1[triangle]*255.0);int tileXoffset=lookupInt(u_miscData2Map,lsId,0);int tileYoffset=lookupInt(u_miscData2Map,lsId,1);int vertexXoffset=lookupInt(u_miscData2Map,lsId,2+(gl_VertexID<<1));int vertexYoffset=lookupInt(u_miscData2Map,lsId,3+(gl_VertexID<<1));return vec2(float(tileXoffset+vertexXoffset)/255.0,float(tileYoffset+vertexYoffset)/255.0);}void main(void){ivec2 mapSize=textureSize(u_miscDataMap,0);ivec2 mainVertexCoord=getMainVertexCoord(a_lscoord,mapSize,1);bool isEvenRow=(mainVertexCoord.y&1)==0;vec4 mainVertexMap1Colour=texelFetch(u_miscDataMap,mainVertexCoord,0);vec2 ls=mainVertexMap1Colour.gb;ivec2 offsetVertexCoordTile0=getOffsetVertexCoord(a_lscoord,mapSize,0,gl_VertexID,isEvenRow);vec4 offsetVertexMap0Colour=texelFetch(u_miscDataMap,offsetVertexCoordTile0,0);vec3 normal=offsetVertexMap0Colour.rgb;ivec2 offsetVertexCoordTile1=getOffsetVertexCoord(a_lscoord,mapSize,1,gl_VertexID,isEvenRow);vec4 offsetVertexMap1Colour=texelFetch(u_miscDataMap,offsetVertexCoordTile1,0);float altitude=(offsetVertexMap1Colour.r*255.0)*HEIGHT_SCALE;vec4 worldPosition=u_view*a_model_position*vec4(a_vertex.x,altitude,a_vertex.z,1.0);gl_Position=u_projection*worldPosition;v_normal=normal;v_texcoord=texcoordFromLs(ls);}`;const H=1.25,Oe=X({__name:"TestbedScene",props:{mapDefinition:{},heightAndTypeMap:{},tileMap:{},textureSet:{}},setup(A,{expose:E}){const _=A,C=y(()=>_.textureSet?.image),{loadingStore:I}=$(),n=ie(ae.LookAt),D=ne(.1,.1,.1,1),h=se(0,.15,1);re(h,h);const m=Ve(U({})),p=[],T=[];function w(e,t,{projection:o,view:x},{indexes:c,vertexes:l},u,s){t.setClearColour(ue),t.setEnableBits(e.CULL_FACE,e.DEPTH_TEST,e.SCISSOR_TEST),t.bindUniform("u_projection",d=>e.uniformMatrix4fv(d,!1,o)),t.bindUniform("u_view",d=>e.uniformMatrix4fv(d,!1,x)),t.bindUniform("u_ambientLight",d=>e.uniform4fv(d,D)),t.bindUniform("u_reverseLightDirection",d=>e.uniform3fv(d,h));const a=Ee(e),r=de(_e(e),xe(e),ve(e),pe(e,_.tileMap),fe(e,me(16,24,ye))),g=he(e,t,e.TRIANGLES,Te(e,t,a,r,e.TRIANGLES,c.length,s.usedCount,Le("a_model_position",s),N("a_vertex",l,3,e.FLOAT),N("a_lscoord",u,2,e.FLOAT,1),Se(c)));return O(C,g.setTexture,{immediate:!0}),g}function M(e){const t=Math.min(e.width,e.height)*.5;n.moveTo(0,t,t),n.lookAt(0,0,0)}function L(e,t){t.bind("KeyL",()=>p.forEach(o=>o.setDrawMode(e.LINE_LOOP))),t.bind("KeyK",()=>p.forEach(o=>o.setDrawMode(e.TRIANGLES))),t.bind("Home",()=>M(_.mapDefinition))}function b(e,t){t.bind(P.Left,({movement:o})=>{n.tilt(o.dy*.1),n.pan(o.dx*.1)}),t.bind(P.Right,({movement:o})=>{n.track(o.dx*-.1,-o.dy*.1)}),t.bindScroll(o=>n.dolly(o*.25))}function z(e,t){t.bind(o=>{function x(l,u){const{movement:s}=u,{dx:a,dy:r}=s;(Math.abs(a)>0||Math.abs(r)>0)&&l.track(-a/10,-r/10)}function c(l,u,s){const{movement:a,currentPosition:r}=u,{movement:g,currentPosition:d}=s,{dx:Y,dy:q}=a,{x:W,y:J}=r,{dx:Q,dy:Z}=g,{x:ee,y:te}=d,oe=Math.sign(W-ee)*(Y+Q)+Math.sign(J-te)*(q+Z);l.dolly(oe/10)}switch(o.length){case 1:x(n,o[0]);break;case 2:c(n,o[0],o[1]);break}})}const V=ce(n,(e,[t],{keyboard:o,mouse:x,touch:c},l)=>{const u=be();O(()=>_.mapDefinition,s=>{m.value=U(s);const a=ze(i(m));a.select(l.view,H),T.splice(0,1/0,a),p.splice(0,1/0,w(e,t,l,u,a.lsCoords,a.positions)).forEach(r=>r.delete()),M(s)},{immediate:!0}),L(e,o),b(e,x),z(e,c),I.setLoading(!1)},(e,t)=>{T.forEach(o=>{o.select(t,H);const{worldCoordinateFor:x}=i(m),c=x(n.position),l=B(i(n.angle)).toFixed(2),u=B(i(n.pitch)).toFixed(2);ge(o.toGridString(c),{fontSize:"0.3em",title:`camera=(${c.y}:${c.x}@${c.z}), azimuth=${l} pitch=${u}`});const{lsCoords:s,positions:a}=o,[r]=p;r.setInstanceCount(a.usedCount),r.updateBuffer("a_model_position",a,a.usedLength),r.updateBuffer("a_lscoord",s,s.usedLength)})},()=>{p.forEach(({activate:e,draw:t},o)=>{e(o===0),t()})},()=>{},()=>{p.splice(0,1/0).forEach(e=>e.delete())});return E({fps:V.fps}),(e,t)=>(K(),j(le,{"fragment-sources":[i(Fe)],"vertex-sources":[i(Re)],onInit:i(V).init,onResize:i(V).resize,onExit:i(V).exit},null,8,["fragment-sources","vertex-sources","onInit","onResize","onExit"]))}}),Xe=X({__name:"TestBed",setup(A){const E=Ce(void 0),{mapStore:_,mapsStore:C,texturesStore:I}=$(),{maps:n}=C,{heightAndTypeMap:D,loadMap:h,map:m,tileMap:p}=_,{currentTexture:T,selectTextureById:w,selectTextureByWorldType:M,textureList:L}=I,b=y(()=>i(n).map(v=>({value:v.id,title:v.name}))),z=y(()=>{const{worldType:v}=i(m);return i(L).filter(F=>F.worldType===v)});O(m,({worldType:v})=>M(v));const k=y(()=>i(T).id);return(v,F)=>(K(),j(Ie,{fluid:"",class:"d-flex flex-column pa-0"},{default:S(()=>[f(we,{class:"flex-grow-0 flex-shrink-0",color:"secondary"},{default:S(()=>[f(R,{class:"mr-3","max-width":"176"},{default:S(()=>[f(G,{label:"Map","hide-details":"",items:b.value,"model-value":i(m).id,"onUpdate:modelValue":i(h)},null,8,["items","model-value","onUpdate:modelValue"])]),_:1}),f(R,{class:"ml-3","max-width":"176"},{default:S(()=>[f(G,{"item-value":"id","item-title":"name",label:"Landscape","hide-details":"",items:z.value,"model-value":k.value,"onUpdate:modelValue":i(w)},null,8,["items","model-value","onUpdate:modelValue"])]),_:1}),f(De),f(R,{class:"mr-3","max-width":"56"},{default:S(()=>[f(Me,{class:"noMouse","hide-details":"",label:"fps","model-value":E.value?.fps,readonly:""},null,8,["model-value"])]),_:1})]),_:1}),f(Oe,{ref_key:"testbedScene",ref:E,class:"flex-fill","map-definition":i(m),"height-and-type-map":i(D),"tile-map":i(p),"texture-set":i(T)},null,8,["map-definition","height-and-type-map","tile-map","texture-set"])]),_:1}))}});export{Xe as default};
